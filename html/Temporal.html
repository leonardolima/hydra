<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Temporal</title>
</head>


<body>
<div class="head">
<h1>Theory Temporal</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Temporal
  <span class="keyword2"><span class="keyword">imports</span></span> <a href="MDL.html">MDL</a> <a href="NFA.html">NFA</a> <a href="Window.html">Window</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">state_cnt</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">::</span> timestamp<span class="main">)</span> regex <span class="main">⇒</span> nat"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">state_cnt</span> Wild <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">state_cnt</span> <span class="main">(</span>Test <span class="main"><span class="bound"><span class="entity">_</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">state_cnt</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">state_cnt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">+</span> <span class="free">state_cnt</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">state_cnt</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free">state_cnt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">+</span> <span class="free">state_cnt</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">state_cnt</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">1</span> <span class="main">+</span> <span class="free">state_cnt</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> state_cnt_pos<span class="main">:</span> <span class="quoted"><span class="quoted">"state_cnt <span class="free">r</span> <span class="main">&gt;</span> <span class="main">0</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> state_cnt.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">collect_subfmlas</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">::</span> timestamp<span class="main">)</span> regex <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> formula list <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> formula list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">collect_subfmlas</span> Wild <span class="free"><span class="bound"><span class="entity">phis</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">collect_subfmlas</span> <span class="main">(</span>Test <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="main">∈</span> set <span class="free"><span class="bound"><span class="entity">phis</span></span></span> <span class="keyword1">then</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span> <span class="main">@</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">collect_subfmlas</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span> <span class="main">=</span> <span class="free">collect_subfmlas</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free">collect_subfmlas</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">collect_subfmlas</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span> <span class="main">=</span> <span class="free">collect_subfmlas</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free">collect_subfmlas</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">collect_subfmlas</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span> <span class="main">=</span> <span class="free">collect_subfmlas</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> bf_collect_subfmlas<span class="main">:</span> <span class="quoted"><span class="quoted">"bounded_future_regex <span class="free">r</span> <span class="main">⟹</span> <span class="free">phi</span> <span class="main">∈</span> set <span class="main">(</span>collect_subfmlas <span class="free">r</span> <span class="free">phis</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">phi</span> <span class="main">∈</span> set <span class="free">phis</span> <span class="main">∨</span> bounded_future_fmla <span class="free">phi</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">phis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> collect_subfmlas.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> FR_collect_subfmlas<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">phi</span> <span class="main">∈</span> set <span class="main">(</span>collect_subfmlas <span class="free">r</span> <span class="free">phis</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">phi</span> <span class="main">∈</span> set <span class="free">phis</span> <span class="main">∨</span> FR_fmla <span class="free">phi</span> <span class="main">≤</span> FR_regex <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">phis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> collect_subfmlas.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> le_supI1 le_supI2 <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> collect_subfmlas_set<span class="main">:</span> <span class="quoted"><span class="quoted">"set <span class="main">(</span>collect_subfmlas <span class="free">r</span> <span class="free">phis</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>collect_subfmlas <span class="free">r</span> <span class="main">[]</span><span class="main">)</span> <span class="main">∪</span> set <span class="free">phis</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">phis</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Plus<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">phis</span></span><span class="main">]</span> Plus<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"collect_subfmlas <span class="skolem">r1</span> <span class="skolem">phis</span>"</span></span><span class="main">]</span>
      Plus<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"collect_subfmlas <span class="skolem">r1</span> <span class="main">[]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Times<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">phis</span></span><span class="main">]</span> Times<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"collect_subfmlas <span class="skolem">r1</span> <span class="skolem">phis</span>"</span></span><span class="main">]</span>
      Times<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"collect_subfmlas <span class="skolem">r1</span> <span class="main">[]</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Star<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">phis</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> collect_subfmlas_size<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="main">(</span>collect_subfmlas <span class="free">r</span> <span class="main">[]</span><span class="main">)</span> <span class="main">⟹</span> size <span class="free">x</span> <span class="main">&lt;</span> size <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Wild
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Test <span class="skolem">phi</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> collect_subfmlas_set<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">r2</span></span> <span class="quoted"><span class="quoted">"collect_subfmlas <span class="skolem">r1</span> <span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">r1</span> <span class="skolem">r2</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> collect_subfmlas_set<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">r2</span></span> <span class="quoted"><span class="quoted">"collect_subfmlas <span class="skolem">r1</span> <span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> collect_subfmlas_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">phis'</span><span class="main">.</span> collect_subfmlas <span class="free">r</span> <span class="free">phis</span> <span class="main">=</span> <span class="free">phis</span> <span class="main">@</span> <span class="bound">phis'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">phis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> collect_subfmlas.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> length_collect_subfmlas<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>collect_subfmlas <span class="free">r</span> <span class="free">phis</span><span class="main">)</span> <span class="main">≥</span> length <span class="free">phis</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">phis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> collect_subfmlas.induct<span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">pos</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'a</span> list <span class="main">⇒</span> nat option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">pos</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">[]</span> <span class="main">=</span> None"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">pos</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="keyword1">then</span> Some <span class="main">0</span> <span class="keyword1">else</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free">pos</span> <span class="free"><span class="bound"><span class="entity">a</span></span></span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span> <span class="keyword1">of</span> Some <span class="bound">n</span> <span class="main">⇒</span> Some <span class="main">(</span>Suc <span class="bound">n</span><span class="main">)</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> None<span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> pos_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"pos <span class="free">a</span> <span class="free">xs</span> <span class="main">=</span> Some <span class="free">i</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">∧</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> <span class="free">a</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pos.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> pos_complete<span class="main">:</span> <span class="quoted"><span class="quoted">"pos <span class="free">a</span> <span class="free">xs</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">a</span> <span class="main">∉</span> set <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">a</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> pos.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">build_nfa_impl</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span> <span class="main">::</span> timestamp<span class="main">)</span> regex <span class="main">⇒</span> <span class="main">(</span>state <span class="main">×</span> state <span class="main">×</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> formula list<span class="main">)</span> <span class="main">⇒</span>
  transition list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">build_nfa_impl</span> Wild <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q0</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">qf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">[</span>wild_trans <span class="free"><span class="bound"><span class="entity">qf</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">build_nfa_impl</span> <span class="main">(</span>Test <span class="free"><span class="bound"><span class="entity">φ</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q0</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">qf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> pos <span class="free"><span class="bound"><span class="entity">φ</span></span></span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span> <span class="keyword1">of</span>
    Some <span class="bound">n</span> <span class="main">⇒</span> <span class="main">[</span>cond_eps <span class="free"><span class="bound"><span class="entity">qf</span></span></span> <span class="bound">n</span><span class="main">]</span>
  <span class="main">|</span> None <span class="main">⇒</span> <span class="main">[</span>cond_eps <span class="free"><span class="bound"><span class="entity">qf</span></span></span> <span class="main">(</span>length <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span><span class="main">]</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">build_nfa_impl</span> <span class="main">(</span>Plus <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q0</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">qf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">ts_r</span> <span class="main">=</span> <span class="free">build_nfa_impl</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q0</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">qf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span><span class="main">;</span>
        <span class="bound">ts_s</span> <span class="main">=</span> <span class="free">build_nfa_impl</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q0</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> state_cnt <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">qf</span></span></span><span class="main">,</span> collect_subfmlas <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    split_trans <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q0</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q0</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> state_cnt <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="bound">ts_r</span> <span class="main">@</span> <span class="bound">ts_s</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">build_nfa_impl</span> <span class="main">(</span>Times <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q0</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">qf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">ts_r</span> <span class="main">=</span> <span class="free">build_nfa_impl</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q0</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q0</span></span></span> <span class="main">+</span> state_cnt <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span><span class="main">;</span>
        <span class="bound">ts_s</span> <span class="main">=</span> <span class="free">build_nfa_impl</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q0</span></span></span> <span class="main">+</span> state_cnt <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">qf</span></span></span><span class="main">,</span> collect_subfmlas <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    <span class="bound">ts_r</span> <span class="main">@</span> <span class="bound">ts_s</span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">build_nfa_impl</span> <span class="main">(</span>Star <span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q0</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">qf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>
    <span class="keyword1">let</span> <span class="bound">ts_r</span> <span class="main">=</span> <span class="free">build_nfa_impl</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q0</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">q0</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span> <span class="keyword1">in</span>
    split_trans <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q0</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">qf</span></span></span> <span class="main">#</span> <span class="bound">ts_r</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> build_nfa_impl_state_cnt<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="main">(</span>build_nfa_impl <span class="free">r</span> <span class="main">(</span><span class="free">q0</span><span class="main">,</span> <span class="free">qf</span><span class="main">,</span> <span class="free">phis</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> state_cnt <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">q0</span><span class="main">,</span> <span class="free">qf</span><span class="main">,</span> <span class="free">phis</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q0</span></span> <span class="quoted"><span class="free">qf</span></span> <span class="quoted"><span class="free">phis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> build_nfa_impl.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> build_nfa_impl_not_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"build_nfa_impl <span class="free">r</span> <span class="main">(</span><span class="free">q0</span><span class="main">,</span> <span class="free">qf</span><span class="main">,</span> <span class="free">phis</span><span class="main">)</span> <span class="main">≠</span> <span class="main">[]</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">q0</span><span class="main">,</span> <span class="free">qf</span><span class="main">,</span> <span class="free">phis</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q0</span></span> <span class="quoted"><span class="free">qf</span></span> <span class="quoted"><span class="free">phis</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> build_nfa_impl.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> build_nfa_impl_state_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set <span class="main">(</span>build_nfa_impl <span class="free">r</span> <span class="main">(</span><span class="free">q0</span><span class="main">,</span> <span class="free">qf</span><span class="main">,</span> <span class="free">phis</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  state_set <span class="free">t</span> <span class="main">⊆</span> <span class="main">{</span><span class="free">q0</span><span class="main">..&lt;</span><span class="free">q0</span> <span class="main">+</span> length <span class="main">(</span>build_nfa_impl <span class="free">r</span> <span class="main">(</span><span class="free">q0</span><span class="main">,</span> <span class="free">qf</span><span class="main">,</span> <span class="free">phis</span><span class="main">)</span><span class="main">)</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="free">qf</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">q0</span><span class="main">,</span> <span class="free">qf</span><span class="main">,</span> <span class="free">phis</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q0</span></span> <span class="quoted"><span class="free">qf</span></span> <span class="quoted"><span class="free">phis</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> build_nfa_impl.induct<span class="main">)</span>
    <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> build_nfa_impl_state_cnt state_cnt_pos build_nfa_impl_not_Nil
      <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> build_nfa_impl_fmla_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">∈</span> set <span class="main">(</span>build_nfa_impl <span class="free">r</span> <span class="main">(</span><span class="free">q0</span><span class="main">,</span> <span class="free">qf</span><span class="main">,</span> <span class="free">phis</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">n</span> <span class="main">∈</span> fmla_set <span class="free">t</span> <span class="main">⟹</span> <span class="free">n</span> <span class="main">&lt;</span> length <span class="main">(</span>collect_subfmlas <span class="free">r</span> <span class="free">phis</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">q0</span><span class="main">,</span> <span class="free">qf</span><span class="main">,</span> <span class="free">phis</span><span class="main">)</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q0</span></span> <span class="quoted"><span class="free">qf</span></span> <span class="quoted"><span class="free">phis</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> build_nfa_impl.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">φ</span> <span class="skolem">q0</span> <span class="skolem">qf</span> <span class="skolem">phis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> pos_sound pos_complete <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>3 <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">q0</span> <span class="skolem">qf</span> <span class="skolem">phis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> length_collect_subfmlas dual_order.strict_trans1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>4 <span class="skolem">r</span> <span class="skolem">s</span> <span class="skolem">q0</span> <span class="skolem">qf</span> <span class="skolem">phis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> length_collect_subfmlas dual_order.strict_trans1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>5 <span class="skolem">r</span> <span class="skolem">q0</span> <span class="skolem">qf</span> <span class="skolem">phis</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> length_collect_subfmlas dual_order.strict_trans1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">context</span></span> MDL
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">IH</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">q0</span></span></span> <span class="free"><span class="bound"><span class="entity">qf</span></span></span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span> <span class="free"><span class="bound"><span class="entity">transs</span></span></span> <span class="free"><span class="bound"><span class="entity">bss</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≡</span>
  <span class="free"><span class="bound"><span class="entity">transs</span></span></span> <span class="main">=</span> build_nfa_impl <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q0</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">qf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span> <span class="main">∧</span>
  <span class="free"><span class="bound"><span class="entity">qf</span></span></span> <span class="main">∉</span> NFA.SQ <span class="free"><span class="bound"><span class="entity">q0</span></span></span> <span class="main">(</span>build_nfa_impl <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q0</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">qf</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="main">(</span>collect_subfmlas <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span><span class="main">.</span>
    <span class="main">(</span><span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">!</span> <span class="bound">k</span> <span class="main">⟷</span> sat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> length <span class="free"><span class="bound"><span class="entity">bss</span></span></span><span class="main">)</span> <span class="main">(</span>collect_subfmlas <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">bss</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span> <span class="main">&lt;</span> length <span class="main">(</span>collect_subfmlas <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span><span class="main">)</span><span class="main">.</span>
    <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">bss</span></span></span> <span class="main">!</span> <span class="bound">j</span><span class="main">)</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">⟷</span> sat <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>collect_subfmlas <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">phis</span></span></span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> nfa_correct<span class="main">:</span> <span class="quoted"><span class="quoted">"IH <span class="free">r</span> <span class="free">q0</span> <span class="free">qf</span> <span class="free">phis</span> <span class="free">transs</span> <span class="free">bss</span> <span class="free">bs</span> <span class="free">i</span> <span class="main">⟹</span>
  NFA.run_accept <span class="free">q0</span> <span class="free">qf</span> <span class="free">transs</span> <span class="main">{</span><span class="free">q0</span><span class="main">}</span> <span class="free">bss</span> <span class="free">bs</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">i</span> <span class="main">+</span> length <span class="free">bss</span><span class="main">)</span> <span class="main">∈</span> match <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">r</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">q0</span></span> <span class="quoted"><span class="free">qf</span></span> <span class="quoted"><span class="free">phis</span></span> <span class="quoted"><span class="free">transs</span></span> <span class="quoted"><span class="free">bss</span></span> <span class="quoted"><span class="free">bs</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> regex_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> Wild
  <span class="keyword1"><span class="command">interpret</span></span> base<span class="main">:</span> nfa <span class="quoted"><span class="skolem">q0</span></span> <span class="quoted"><span class="skolem">qf</span></span> <span class="quoted"><span class="quoted">"build_nfa_impl Wild <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">using</span></span> build_nfa_impl_state_set build_nfa_impl_not_Nil Wild
    <span class="keyword1"><span class="command">unfolding</span></span> IH_def NFA.Q_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cs</span> <span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>base.step_eps <span class="bound">cs</span> <span class="skolem">q0</span> <span class="bound">q</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> NFA.step_eps_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> transition.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> base_eps<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cs</span><span class="main">.</span> base.eps_closure_set <span class="main">{</span><span class="skolem">q0</span><span class="main">}</span> <span class="bound">cs</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">q0</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> NFA.eps_closure_set_step_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> base_delta<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cs</span><span class="main">.</span> base.delta <span class="main">{</span><span class="skolem">q0</span><span class="main">}</span> <span class="bound">cs</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">qf</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> NFA.delta_def base_eps NFA.step_wild_set_def NFA.step_wild_def
    <span class="keyword1"><span class="command">using</span></span> base.q0_sub_SQ
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bss</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> Nil
      <span class="keyword1"><span class="command">using</span></span> NFA.run_accept_Nil NFA.accept_def base_eps
      <span class="keyword1"><span class="command">using</span></span> base.qf_not_in_SQ base.q0_sub_SQ
      <span class="keyword1"><span class="command">using</span></span> IH_def Wild <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">cs</span> <span class="skolem">css</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> bss_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">bss</span> <span class="main">=</span> <span class="skolem">cs</span> <span class="main">#</span> <span class="skolem">css</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">css</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons Nil NFA.run_accept_Cons NFA.run_accept_Nil base_delta NFA.accept_def
        <span class="keyword1"><span class="command">using</span></span> NFA.eps_closure_set_refl
        <span class="keyword1"><span class="command">using</span></span> IH_def Wild <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">ds</span> <span class="skolem">dss</span><span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> bss_split Cons NFA.run_accept_Cons base_delta base.delta_qf
        <span class="keyword1"><span class="command">using</span></span> NFA.run_accept_empty
        <span class="keyword1"><span class="command">using</span></span> IH_def Wild <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Test <span class="skolem">φ</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> qf_not_in_SQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qf</span> <span class="main">∉</span> NFA.SQ <span class="skolem">q0</span> <span class="main">(</span>build_nfa_impl <span class="main">(</span>Test <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Test <span class="keyword1"><span class="command">unfolding</span></span> IH_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> base<span class="main">:</span> nfa <span class="quoted"><span class="skolem">q0</span></span> <span class="quoted"><span class="skolem">qf</span></span> <span class="quoted"><span class="quoted">"build_nfa_impl <span class="main">(</span>Test <span class="skolem">φ</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">using</span></span> build_nfa_impl_state_set build_nfa_impl_not_Nil qf_not_in_SQ
    <span class="keyword1"><span class="command">unfolding</span></span> NFA.Q_def NFA.SQ_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">n</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">≡</span> <span class="keyword1">case</span> pos <span class="skolem">φ</span> <span class="skolem">phis</span> <span class="keyword1">of</span> Some <span class="bound">n</span> <span class="main">⇒</span> <span class="bound">n</span> <span class="main">|</span> <span class="main"><span class="bound">_</span></span> <span class="main">⇒</span> length <span class="skolem">phis</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> collect<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="main">(</span>collect_subfmlas <span class="main">(</span>Test <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span>collect_subfmlas <span class="main">(</span>Test <span class="skolem">φ</span><span class="main">)</span> <span class="skolem">phis</span><span class="main">)</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">=</span> <span class="skolem">φ</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> pos_sound pos_complete <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> base_step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">cs</span> <span class="bound">q</span><span class="main">.</span> base.step_eps <span class="bound">cs</span> <span class="skolem">q0</span> <span class="bound">q</span> <span class="main">⟷</span> <span class="bound">cs</span> <span class="main">!</span> <span class="skolem">n</span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">=</span> <span class="skolem">qf</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> NFA.step_eps_def <span class="keyword1"><span class="command">using</span></span> n_def base.q0_sub_SQ
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bss</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> Nil
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">bs</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sat_phi<span class="main">:</span> <span class="quoted"><span class="quoted">"sat <span class="skolem">i</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Test<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> IH_def Nil<span class="main">]</span> collect <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> base.step_eps <span class="skolem">bs</span> <span class="skolem">q0</span> <span class="bound">q</span> <span class="main">⟷</span> <span class="bound">q</span> <span class="main">=</span> <span class="skolem">qf</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> True base_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base.eps_closure_set <span class="main">{</span><span class="skolem">q0</span><span class="main">}</span> <span class="skolem">bs</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> NFA.eps_closure_set_unfold base.eps_closure_set_qf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">with</span></span> sat_phi <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Nil NFA.run_accept_Nil NFA.accept_def Test
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IH_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sat_phi<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>sat <span class="skolem">i</span> <span class="skolem">φ</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Test<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> IH_def Nil<span class="main">]</span> collect <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>base.step_eps <span class="skolem">bs</span> <span class="skolem">q0</span> <span class="bound">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> False base_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base.eps_closure_set <span class="main">{</span><span class="skolem">q0</span><span class="main">}</span> <span class="skolem">bs</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">q0</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> NFA.eps_closure_set_step_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">with</span></span> sat_phi <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Nil NFA.run_accept_Nil NFA.accept_def
        <span class="keyword1"><span class="command">using</span></span> base.q0_sub_SQ base.qf_not_in_SQ Test
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IH_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">cs</span> <span class="skolem">css</span><span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">cs</span> <span class="main">!</span> <span class="skolem">n</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> base.step_eps <span class="skolem">cs</span> <span class="skolem">q0</span> <span class="bound">q</span> <span class="main">⟷</span> <span class="bound">q</span> <span class="main">=</span> <span class="skolem">qf</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> base_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base.eps_closure_set <span class="main">{</span><span class="skolem">q0</span><span class="main">}</span> <span class="skolem">cs</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> NFA.eps_closure_set_unfold base.eps_closure_set_qf <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> base_delta<span class="main">:</span> <span class="quoted"><span class="quoted">"base.delta <span class="main">{</span><span class="skolem">q0</span><span class="main">}</span> <span class="skolem">cs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> NFA.delta_def NFA.step_wild_set_def NFA.step_wild_def
        <span class="keyword1"><span class="command">using</span></span> base.q0_sub_SQ base.qf_not_in_SQ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> NFA.run_accept_empty Test Cons NFA.run_accept_Cons base_delta
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IH_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> <span class="main">¬</span>base.step_eps <span class="skolem">cs</span> <span class="skolem">q0</span> <span class="bound">q</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> base_step <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"base.eps_closure_set <span class="main">{</span><span class="skolem">q0</span><span class="main">}</span> <span class="skolem">cs</span> <span class="main">=</span> <span class="main">{</span><span class="skolem">q0</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> NFA.eps_closure_set_step_id <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> base_delta<span class="main">:</span> <span class="quoted"><span class="quoted">"base.delta <span class="main">{</span><span class="skolem">q0</span><span class="main">}</span> <span class="skolem">cs</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> NFA.delta_def NFA.step_wild_set_def NFA.step_wild_def
        <span class="keyword1"><span class="command">using</span></span> base.q0_sub_SQ <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> NFA.run_accept_empty Cons NFA.run_accept_Cons base_delta Test
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IH_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">phis'</span></span> <span class="keyword2"><span class="keyword">where</span></span> collect<span class="main">:</span> <span class="quoted"><span class="quoted">"collect_subfmlas <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">phis</span> <span class="main">=</span>
    collect_subfmlas <span class="skolem">r</span> <span class="skolem">phis</span> <span class="main">@</span> <span class="skolem">phis'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> collect_subfmlas_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> qf_not_in_SQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qf</span> <span class="main">∉</span> NFA.SQ <span class="skolem">q0</span> <span class="main">(</span>build_nfa_impl <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Plus <span class="keyword1"><span class="command">unfolding</span></span> IH_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> base<span class="main">:</span> nfa <span class="quoted"><span class="skolem">q0</span></span> <span class="quoted"><span class="skolem">qf</span></span> <span class="quoted"><span class="quoted">"build_nfa_impl <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">using</span></span> build_nfa_impl_state_set build_nfa_impl_not_Nil qf_not_in_SQ
    <span class="keyword1"><span class="command">unfolding</span></span> NFA.Q_def NFA.SQ_def build_nfa_impl_state_cnt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> left<span class="main">:</span> nfa <span class="quoted"><span class="quoted">"<span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">qf</span></span> <span class="quoted"><span class="quoted">"build_nfa_impl <span class="skolem">r</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">using</span></span> build_nfa_impl_state_set build_nfa_impl_not_Nil qf_not_in_SQ
    <span class="keyword1"><span class="command">unfolding</span></span> NFA.Q_def NFA.SQ_def build_nfa_impl_state_cnt
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> right<span class="main">:</span> nfa <span class="quoted"><span class="quoted">"<span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> state_cnt <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="skolem">qf</span></span>
    <span class="quoted"><span class="quoted">"build_nfa_impl <span class="skolem">s</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> collect_subfmlas <span class="skolem">r</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">using</span></span> build_nfa_impl_state_set build_nfa_impl_not_Nil qf_not_in_SQ
    <span class="keyword1"><span class="command">unfolding</span></span> NFA.Q_def NFA.SQ_def build_nfa_impl_state_cnt
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> Plus<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IH <span class="skolem">r</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">qf</span> <span class="skolem">phis</span> <span class="main">(</span>build_nfa_impl <span class="skolem">r</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bss</span> <span class="skolem">bs</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> IH_def collect
    <span class="keyword1"><span class="command">using</span></span> left.qf_not_in_SQ
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> left_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"left.run_accept <span class="main">{</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span> <span class="skolem">bss</span> <span class="skolem">bs</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">bss</span><span class="main">)</span> <span class="main">∈</span> match <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Plus<span class="main">(</span>1<span class="main">)</span> build_nfa_impl_state_cnt
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IH <span class="skolem">s</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">)</span> <span class="skolem">qf</span> <span class="main">(</span>collect_subfmlas <span class="skolem">r</span> <span class="skolem">phis</span><span class="main">)</span>
    <span class="main">(</span>build_nfa_impl <span class="skolem">s</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> collect_subfmlas <span class="skolem">r</span> <span class="skolem">phis</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bss</span> <span class="skolem">bs</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> right.qf_not_in_SQ IH_def Plus
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> right_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"right.run_accept <span class="main">{</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">}</span> <span class="skolem">bss</span> <span class="skolem">bs</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">bss</span><span class="main">)</span> <span class="main">∈</span> match <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Plus<span class="main">(</span>2<span class="main">)</span> build_nfa_impl_state_cnt
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> cong<span class="main">:</span> nfa_cong_Plus <span class="quoted"><span class="skolem">q0</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> state_cnt <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="skolem">qf</span></span> <span class="quoted"><span class="skolem">qf</span></span> <span class="quoted"><span class="skolem">qf</span></span>
    <span class="quoted"><span class="quoted">"build_nfa_impl <span class="main">(</span>Plus <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"build_nfa_impl <span class="skolem">r</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"build_nfa_impl <span class="skolem">s</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> collect_subfmlas <span class="skolem">r</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">unfolding</span></span> NFA.SQ_def build_nfa_impl_state_cnt
      NFA.step_eps_def NFA.step_wild_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append build_nfa_impl_state_cnt<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> cong.run_accept_cong left_IH right_IH Plus
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IH_def<span class="main">)</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Times <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">phis'</span></span> <span class="keyword2"><span class="keyword">where</span></span> collect<span class="main">:</span> <span class="quoted"><span class="quoted">"collect_subfmlas <span class="main">(</span>Times <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="skolem">phis</span> <span class="main">=</span>
    collect_subfmlas <span class="skolem">r</span> <span class="skolem">phis</span> <span class="main">@</span> <span class="skolem">phis'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> collect_subfmlas_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> transs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">transs</span> <span class="main">=</span> build_nfa_impl <span class="main">(</span>Times <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Times <span class="keyword1"><span class="command">unfolding</span></span> IH_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> qf_not_in_SQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qf</span> <span class="main">∉</span> NFA.SQ <span class="skolem">q0</span> <span class="main">(</span>build_nfa_impl <span class="main">(</span>Times <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Times <span class="keyword1"><span class="command">unfolding</span></span> IH_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">interpret</span></span> base<span class="main">:</span> nfa <span class="quoted"><span class="skolem">q0</span></span> <span class="quoted"><span class="skolem">qf</span></span> <span class="quoted"><span class="quoted">"build_nfa_impl <span class="main">(</span>Times <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">using</span></span> build_nfa_impl_state_set build_nfa_impl_not_Nil qf_not_in_SQ
    <span class="keyword1"><span class="command">unfolding</span></span> NFA.Q_def NFA.SQ_def build_nfa_impl_state_cnt <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> left<span class="main">:</span> nfa <span class="quoted"><span class="quoted">"<span class="skolem">q0</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="quoted">"build_nfa_impl <span class="skolem">r</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">using</span></span> build_nfa_impl_state_set build_nfa_impl_not_Nil qf_not_in_SQ
    <span class="keyword1"><span class="command">unfolding</span></span> NFA.Q_def NFA.SQ_def build_nfa_impl_state_cnt
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">interpret</span></span> right<span class="main">:</span> nfa <span class="quoted"><span class="quoted">"<span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="skolem">qf</span></span>
    <span class="quoted"><span class="quoted">"build_nfa_impl <span class="skolem">s</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> collect_subfmlas <span class="skolem">r</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">using</span></span> build_nfa_impl_state_set build_nfa_impl_not_Nil qf_not_in_SQ
    <span class="keyword1"><span class="command">unfolding</span></span> NFA.Q_def NFA.SQ_def build_nfa_impl_state_cnt
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">from</span></span> Times<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> left_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"IH <span class="skolem">r</span> <span class="skolem">q0</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">)</span> <span class="skolem">phis</span>
    <span class="main">(</span>build_nfa_impl <span class="skolem">r</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">,</span> <span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bss</span> <span class="skolem">bs</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> IH_def collect
    <span class="keyword1"><span class="command">using</span></span> left.qf_not_in_SQ
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> Times<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> left_IH_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">bss</span> <span class="main">⟹</span>
    IH <span class="skolem">r</span> <span class="skolem">q0</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">)</span> <span class="skolem">phis</span>
    <span class="main">(</span>build_nfa_impl <span class="skolem">r</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">n</span> <span class="skolem">bss</span><span class="main">)</span> <span class="main">(</span>hd <span class="main">(</span>drop <span class="bound">n</span> <span class="skolem">bss</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> IH_def collect
    <span class="keyword1"><span class="command">using</span></span> left.qf_not_in_SQ
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append min_absorb2 hd_drop_conv_nth<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> left_IH_match<span class="main">:</span> <span class="quoted"><span class="quoted">"left.run_accept <span class="main">{</span><span class="skolem">q0</span><span class="main">}</span> <span class="skolem">bss</span> <span class="skolem">bs</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">bss</span><span class="main">)</span> <span class="main">∈</span> match <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Times<span class="main">(</span>1<span class="main">)</span> build_nfa_impl_state_cnt left_IH
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> left_IH_match_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">bss</span> <span class="main">⟹</span>
    left.run_accept <span class="main">{</span><span class="skolem">q0</span><span class="main">}</span> <span class="main">(</span>take <span class="bound">n</span> <span class="skolem">bss</span><span class="main">)</span> <span class="main">(</span>hd <span class="main">(</span>drop <span class="bound">n</span> <span class="skolem">bss</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">i</span> <span class="main">+</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> match <span class="skolem">r</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Times<span class="main">(</span>1<span class="main">)</span> build_nfa_impl_state_cnt left_IH_take
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append min_absorb2<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"IH <span class="skolem">s</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">)</span> <span class="skolem">qf</span> <span class="main">(</span>collect_subfmlas <span class="skolem">r</span> <span class="skolem">phis</span><span class="main">)</span>
    <span class="main">(</span>build_nfa_impl <span class="skolem">s</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> collect_subfmlas <span class="skolem">r</span> <span class="skolem">phis</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bss</span> <span class="skolem">bs</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> right.qf_not_in_SQ IH_def Times
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> right_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="skolem">bss</span> <span class="main">⟹</span> IH <span class="skolem">s</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">)</span> <span class="skolem">qf</span> <span class="main">(</span>collect_subfmlas <span class="skolem">r</span> <span class="skolem">phis</span><span class="main">)</span>
    <span class="main">(</span>build_nfa_impl <span class="skolem">s</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> collect_subfmlas <span class="skolem">r</span> <span class="skolem">phis</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="skolem">bss</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="bound">n</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> IH_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append add.assoc<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> right_IH_match<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">≤</span> length <span class="skolem">bss</span> <span class="main">⟹</span>
    right.run_accept <span class="main">{</span><span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">}</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="skolem">bss</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">⟷</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="bound">n</span><span class="main">,</span> <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">bss</span><span class="main">)</span> <span class="main">∈</span> match <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Times<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> right_IH<span class="main">]</span> build_nfa_impl_state_cnt
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> IH_def<span class="main">)</span>
  <span class="keyword1"><span class="command">interpret</span></span> cong<span class="main">:</span> nfa_cong_Times <span class="quoted"><span class="skolem">q0</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span>"</span></span> <span class="quoted"><span class="skolem">qf</span></span>
    <span class="quoted"><span class="quoted">"build_nfa_impl <span class="main">(</span>Times <span class="skolem">r</span> <span class="skolem">s</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"build_nfa_impl <span class="skolem">r</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"build_nfa_impl <span class="skolem">s</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> collect_subfmlas <span class="skolem">r</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
    <span class="keyword1"><span class="command">using</span></span> NFA.Q_def NFA.SQ_def NFA.step_eps_def NFA.step_wild_def build_nfa_impl_state_set
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append build_nfa_impl_state_cnt build_nfa_impl_not_Nil
        state_cnt_pos<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> right_IH_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"right.run_accept <span class="main">{</span><span class="skolem">q0</span> <span class="main">+</span> state_cnt <span class="skolem">r</span><span class="main">}</span> <span class="main">[]</span> <span class="skolem">bs</span> <span class="main">⟷</span>
    <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">bss</span><span class="main">,</span> <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">bss</span><span class="main">)</span> <span class="main">∈</span> match <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> right_IH_match
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> match_Times transs_def cong.run_accept_cong left_IH_match right_IH_Nil
    <span class="keyword1"><span class="command">using</span></span> left_IH_match_take right_IH_match less_imp_le_nat le_eq_less_or_eq
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"length <span class="skolem">bss</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">bss</span></span> <span class="quoted"><span class="skolem">bs</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> nat_less_induct<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 1
    <span class="keyword1"><span class="command">have</span></span> transs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">transs</span> <span class="main">=</span> build_nfa_impl <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> IH_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> qf_not_in_SQ<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">qf</span> <span class="main">∉</span> NFA.SQ <span class="skolem">q0</span> <span class="main">(</span>build_nfa_impl <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1 <span class="keyword1"><span class="command">unfolding</span></span> IH_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">interpret</span></span> base<span class="main">:</span> nfa <span class="quoted"><span class="skolem">q0</span></span> <span class="quoted"><span class="skolem">qf</span></span> <span class="quoted"><span class="quoted">"build_nfa_impl <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">using</span></span> build_nfa_impl_state_set build_nfa_impl_not_Nil qf_not_in_SQ
      <span class="keyword1"><span class="command">unfolding</span></span> NFA.Q_def NFA.SQ_def build_nfa_impl_state_cnt
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">interpret</span></span> left<span class="main">:</span> nfa <span class="quoted"><span class="quoted">"<span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">q0</span></span> <span class="quoted"><span class="quoted">"build_nfa_impl <span class="skolem">r</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">q0</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">using</span></span> build_nfa_impl_state_set build_nfa_impl_not_Nil qf_not_in_SQ
      <span class="keyword1"><span class="command">unfolding</span></span> NFA.Q_def NFA.SQ_def build_nfa_impl_state_cnt
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> left_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"IH <span class="skolem">r</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">q0</span> <span class="skolem">phis</span> <span class="main">(</span>build_nfa_impl <span class="skolem">r</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">q0</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span><span class="main">)</span> <span class="skolem">bss</span> <span class="skolem">bs</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> left.qf_not_in_SQ
      <span class="keyword1"><span class="command">unfolding</span></span> IH_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> left_IH_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">bss</span> <span class="main">⟹</span>
      IH <span class="skolem">r</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">q0</span> <span class="skolem">phis</span> <span class="main">(</span>build_nfa_impl <span class="skolem">r</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">q0</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>take <span class="bound">n</span> <span class="skolem">bss</span><span class="main">)</span> <span class="main">(</span>hd <span class="main">(</span>drop <span class="bound">n</span> <span class="skolem">bss</span><span class="main">)</span><span class="main">)</span> <span class="skolem">i</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> left.qf_not_in_SQ
      <span class="keyword1"><span class="command">unfolding</span></span> IH_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append min_absorb2 hd_drop_conv_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> left_IH_match<span class="main">:</span> <span class="quoted"><span class="quoted">"left.run_accept <span class="main">{</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span> <span class="skolem">bss</span> <span class="skolem">bs</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">i</span> <span class="main">+</span> length <span class="skolem">bss</span><span class="main">)</span> <span class="main">∈</span> match <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> left_IH
      <span class="keyword1"><span class="command">unfolding</span></span> build_nfa_impl_state_cnt NFA.SQ_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> left_IH_match_take<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">bss</span> <span class="main">⟹</span>
      left.run_accept <span class="main">{</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span> <span class="main">(</span>take <span class="bound">n</span> <span class="skolem">bss</span><span class="main">)</span> <span class="main">(</span>hd <span class="main">(</span>drop <span class="bound">n</span> <span class="skolem">bss</span><span class="main">)</span><span class="main">)</span> <span class="main">⟷</span>
      <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">i</span> <span class="main">+</span> <span class="bound">n</span><span class="main">)</span> <span class="main">∈</span> match <span class="skolem">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 1<span class="main">(</span>2<span class="main">)</span> left_IH_take
      <span class="keyword1"><span class="command">unfolding</span></span> build_nfa_impl_state_cnt NFA.SQ_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append min_absorb2<span class="main">)</span>
    <span class="keyword1"><span class="command">interpret</span></span> cong<span class="main">:</span> nfa_cong_Star <span class="quoted"><span class="skolem">q0</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span>"</span></span> <span class="quoted"><span class="skolem">qf</span></span>
      <span class="quoted"><span class="quoted">"build_nfa_impl <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="main">(</span><span class="skolem">q0</span><span class="main">,</span> <span class="skolem">qf</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"build_nfa_impl <span class="skolem">r</span> <span class="main">(</span><span class="skolem">q0</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">q0</span><span class="main">,</span> <span class="skolem">phis</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">unfold_locales</span>
      <span class="keyword1"><span class="command">unfolding</span></span> NFA.SQ_def build_nfa_impl_state_cnt NFA.step_eps_def NFA.step_wild_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append build_nfa_impl_state_cnt<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> cong.run_accept_Nil
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">bss</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> Nil
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> transs_def Nil
        <span class="keyword1"><span class="command">using</span></span> cong.run_accept_Nil run_Nil run_accept_Nil
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">cs</span> <span class="skolem">css</span><span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> aux<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span> <span class="bound">j</span> <span class="bound">x</span> <span class="bound">P</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> <span class="bound">x</span> <span class="main">-</span> <span class="bound">n</span> <span class="main">⟹</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">j</span></span> <span class="main">&lt;</span> Suc <span class="bound">x</span><span class="main">.</span> <span class="bound">P</span> <span class="bound">j</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">P</span> <span class="main">(</span>Suc <span class="main">(</span><span class="bound">n</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">from</span></span> 1<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> star_IH<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">css</span> <span class="main">⟹</span>
        IH <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="skolem">q0</span> <span class="skolem">qf</span> <span class="skolem">phis</span> <span class="skolem">transs</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="skolem">css</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Cons IH_def
        <span class="keyword1"><span class="command">using</span></span> aux<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">j</span><span class="main">.</span> <span class="main">∀</span><span class="bound"><span class="bound">k</span></span><span class="main">&lt;</span>length <span class="main">(</span>collect_subfmlas <span class="skolem">r</span> <span class="skolem">phis</span><span class="main">)</span><span class="main">.</span>
          <span class="main">(</span><span class="skolem">cs</span> <span class="main">#</span> <span class="skolem">css</span><span class="main">)</span> <span class="main">!</span> <span class="bound">j</span> <span class="main">!</span> <span class="bound">k</span> <span class="main">=</span> sat <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>collect_subfmlas <span class="skolem">r</span> <span class="skolem">phis</span> <span class="main">!</span> <span class="bound">k</span><span class="main">)</span>"</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append add.assoc<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> IH_inst<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">xs</span> <span class="bound">i</span><span class="main">.</span> length <span class="bound">xs</span> <span class="main">≤</span> length <span class="skolem">css</span> <span class="main">⟹</span> IH <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span> <span class="skolem">q0</span> <span class="skolem">qf</span> <span class="skolem">phis</span> <span class="skolem">transs</span> <span class="bound">xs</span> <span class="skolem">bs</span> <span class="bound">i</span> <span class="main">⟶</span>
        <span class="main">(</span>base.run_accept <span class="main">{</span><span class="skolem">q0</span><span class="main">}</span> <span class="bound">xs</span> <span class="skolem">bs</span> <span class="main">⟷</span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">i</span> <span class="main">+</span> length <span class="bound">xs</span><span class="main">)</span> <span class="main">∈</span> match <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> 1
        <span class="keyword1"><span class="command">unfolding</span></span> Cons
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append less_Suc_eq_le transs_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">n</span><span class="main">.</span> <span class="bound">n</span> <span class="main">&lt;</span> length <span class="skolem">css</span> <span class="main">⟹</span> base.run_accept <span class="main">{</span><span class="skolem">q0</span><span class="main">}</span> <span class="main">(</span>drop <span class="bound">n</span> <span class="skolem">css</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">⟷</span>
        <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="bound">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">i</span> <span class="main">+</span> length <span class="main">(</span><span class="skolem">cs</span> <span class="main">#</span> <span class="skolem">css</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> match <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">n</span>
        <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">n</span> <span class="main">&lt;</span> length <span class="skolem">css</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"base.run_accept <span class="main">{</span><span class="skolem">q0</span><span class="main">}</span> <span class="main">(</span>drop <span class="skolem">n</span> <span class="skolem">css</span><span class="main">)</span> <span class="skolem">bs</span> <span class="main">⟷</span>
          <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">i</span> <span class="main">+</span> length <span class="main">(</span><span class="skolem">cs</span> <span class="main">#</span> <span class="skolem">css</span><span class="main">)</span><span class="main">)</span> <span class="main">∈</span> match <span class="main">(</span>Star <span class="skolem">r</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> IH_inst<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">n</span> <span class="skolem">css</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="skolem">n</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> star_IH
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> match_Star length_Cons Cons cong.run_accept_cong_Cons
        <span class="keyword1"><span class="command">using</span></span> cong.run_accept_Nil left_IH_match left_IH_match_take
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Cons transs_def<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_less_eq add_Suc_right drop_Suc_Cons less_imp_le_nat take_Suc_Cons<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_less_eq add_Suc_right drop_Suc_Cons le_eq_less_or_eq lessThan_iff
            take_Suc_Cons<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">context</span></span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">args</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool iarray<span class="main">,</span> nat set<span class="main">,</span> <span class="tfree">'d</span> <span class="main">::</span> timestamp<span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> args"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">reach_w</span> <span class="main">≡</span> reach_window <span class="free">args</span>"</span></span>

<span class="keyword2"><span class="keyword">qualified</span></span> <span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">in_win</span> <span class="main">=</span> init_window <span class="free">args</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid_window_matchP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> ℐ <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> bool iarray<span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span>bool iarray<span class="main">,</span> nat set<span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> window <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_window_matchP</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> w_j <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∧</span>
    valid_window <span class="free">args</span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∧</span>
    reach_w <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">(</span>w_i <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> w_ti <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> w_si <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> w_j <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> w_tj <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> w_sj <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="keyword1">case</span> w_read_t <span class="free">args</span> <span class="main">(</span>w_tj <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True
    <span class="main">|</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">l</span></span> <span class="main">&lt;</span> w_i <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">.</span> ts_at <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">l</span> <span class="main">+</span> left <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≤</span> <span class="bound">t</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_window_matchP_reach_tj<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_window_matchP <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">i</span> <span class="free">w</span> <span class="main">⟹</span>
  reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span> <span class="main">(</span>w_tj <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reach_window_run_tj
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_matchP_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> reach_window.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_window_matchP_reach_sj<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_window_matchP <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">i</span> <span class="free">w</span> <span class="main">⟹</span>
  reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span> <span class="main">(</span>w_sj <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reach_window_run_sj
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_matchP_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> reach_window.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_window_matchP_len_rho<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_window_matchP <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">i</span> <span class="free">w</span> <span class="main">⟹</span> length <span class="free">rho</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_matchP_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">matchP_loop_cond</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> w_i <span class="bound">w</span> <span class="main">&lt;</span> w_j <span class="bound">w</span> <span class="main">∧</span> the <span class="main">(</span>w_read_t <span class="free">args</span> <span class="main">(</span>w_ti <span class="bound">w</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> left <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">matchP_loop_inv</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">j0</span></span></span> <span class="free"><span class="bound"><span class="entity">tj0</span></span></span> <span class="free"><span class="bound"><span class="entity">sj0</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> valid_window <span class="free">args</span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">w</span> <span class="main">∧</span>
    w_j <span class="bound">w</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j0</span></span></span> <span class="main">∧</span> w_tj <span class="bound">w</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">tj0</span></span></span> <span class="main">∧</span> w_sj <span class="bound">w</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sj0</span></span></span> <span class="main">∧</span> <span class="main">(</span><span class="main">∀</span><span class="bound"><span class="bound">l</span></span> <span class="main">&lt;</span> w_i <span class="bound">w</span><span class="main">.</span> ts_at <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">l</span> <span class="main">+</span> left <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">ex_key</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> mmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> bool<span class="main">)</span> mapping <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span>bool <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> bool<span class="main">)</span> mapping<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ex_key</span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">time</span></span></span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">ac</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> <span class="main">(</span>False<span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ac</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">ex_key</span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">qts</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">time</span></span></span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">ac</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">time</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="keyword1">then</span>
    <span class="main">(</span><span class="keyword1">case</span> cac <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">ac</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">β</span><span class="main">,</span> <span class="bound">ac'</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="keyword1">if</span> <span class="bound">β</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> <span class="bound">ac'</span><span class="main">)</span> <span class="keyword1">else</span> <span class="free">ex_key</span> <span class="free"><span class="bound"><span class="entity">qts</span></span></span> <span class="free"><span class="bound"><span class="entity">time</span></span></span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="bound">ac'</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span>
  <span class="keyword1">else</span> <span class="free">ex_key</span> <span class="free"><span class="bound"><span class="entity">qts</span></span></span> <span class="free"><span class="bound"><span class="entity">time</span></span></span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">ac</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> ex_key_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">ac</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free">accept</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">qts</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"ex_key <span class="free">qts</span> <span class="free">time</span> <span class="free">accept</span> <span class="free">ac</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">ac'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> mmap_keys <span class="free">qts</span><span class="main">.</span> <span class="free">time</span> <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="free">qts</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="free">accept</span> <span class="bound">q</span> <span class="free">bs</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">ac'</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free">accept</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">qts</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">ac</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">qts</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> qt_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">time</span> <span class="skolem">t</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword1"><span class="command">note</span></span> time_t <span class="main">=</span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="skolem"><span class="skolem">ac''</span></span> <span class="keyword2"><span class="keyword">where</span></span> ac''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"cac <span class="free">accept</span> <span class="skolem">ac</span> <span class="skolem">q</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">β</span><span class="main">,</span> <span class="skolem">ac''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> accept<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> <span class="free">accept</span> <span class="skolem">q</span> <span class="free">bs</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">ac''</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True
      <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free">accept</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ac''_def Cons<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cac_def Let_def Mapping.lookup_update' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">β</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> accept<span class="main">(</span>2<span class="main">)</span> time_t Cons<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qt_def mmap_keys_def accept<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> mmap_lookup_def ac''_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">have</span></span> ex_key<span class="main">:</span> <span class="quoted"><span class="quoted">"ex_key <span class="skolem">qts</span> <span class="free">time</span> <span class="free">accept</span> <span class="skolem">ac''</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">ac'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>4<span class="main">)</span> time_t False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qt_def ac''_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> accept<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ ex_key<span class="main">]</span> False<span class="main">[</span><span class="operator">unfolded</span> accept<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> Cons<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_keys_def mmap_lookup_def qt_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> ex_key<span class="main">:</span> <span class="quoted"><span class="quoted">"ex_key <span class="skolem">qts</span> <span class="free">time</span> <span class="free">accept</span> <span class="skolem">ac</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">(</span><span class="free">b</span><span class="main">,</span> <span class="free">ac'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>4<span class="main">)</span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qt_def<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> _ ex_key<span class="main">]</span> False Cons<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_keys_def mmap_lookup_def qt_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_keys_def<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_matchP</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> ℐ <span class="main">⇒</span> <span class="main">(</span>bool iarray<span class="main">,</span> nat set<span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> window <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> bool<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>bool iarray<span class="main">,</span> nat set<span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> window<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_matchP</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> w_read_t <span class="free">args</span> <span class="main">(</span>w_tj <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None
    <span class="main">|</span> Some <span class="bound">t</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> w_read_sub <span class="free">args</span> <span class="main">(</span>w_sj <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None
    <span class="main">|</span> Some <span class="bound">b</span> <span class="main">⇒</span>
      <span class="keyword1">let</span> <span class="bound">w'</span> <span class="main">=</span> while <span class="main">(</span>matchP_loop_cond <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>adv_start <span class="free">args</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span>
      <span class="main">(</span><span class="bound">β</span><span class="main">,</span> <span class="bound">ac'</span><span class="main">)</span> <span class="main">=</span> ex_key <span class="main">(</span>w_e <span class="bound">w'</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t</span> <span class="main">≤</span> <span class="bound">t'</span> <span class="main">+</span> right <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span> <span class="main">(</span>w_accept <span class="free">args</span><span class="main">)</span> <span class="main">(</span>w_ac <span class="bound">w'</span><span class="main">)</span> <span class="bound">b</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">β'</span><span class="main">,</span> <span class="bound">ac''</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="bound">β</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> <span class="bound">ac'</span><span class="main">)</span>
        <span class="keyword1">else</span> <span class="keyword1">if</span> mem <span class="bound">t</span> <span class="bound">t</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1">then</span> cac <span class="main">(</span>w_accept <span class="free">args</span><span class="main">)</span> <span class="bound">ac'</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="bound">b</span>
        <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> <span class="bound">ac'</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">in</span>
      Some <span class="main">(</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">β'</span><span class="main">)</span><span class="main">,</span> adv_end <span class="free">args</span> <span class="main">(</span><span class="bound">w'</span><span class="main">⦇</span>w_ac <span class="main">:=</span> <span class="bound">ac''</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid_window_matchF</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> ℐ <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> bool iarray<span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">⇒</span>
  <span class="main">(</span>bool iarray<span class="main">,</span> nat set<span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> window <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_window_matchF</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> w_i <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∧</span>
    valid_window <span class="free">args</span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">∧</span>
    reach_w <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">(</span>w_i <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> w_ti <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> w_si <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> w_j <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> w_tj <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">,</span> w_sj <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span>w_i <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">..&lt;</span>w_j <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">}</span><span class="main">.</span> ts_at <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">l</span> <span class="main">≤</span> ts_at <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> right <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_window_matchF_reach_tj<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_window_matchF <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">i</span> <span class="free">w</span> <span class="main">⟹</span>
  reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span> <span class="main">(</span>w_tj <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reach_window_run_tj
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_matchF_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> reach_window.simps<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_window_matchF_reach_sj<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_window_matchF <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">i</span> <span class="free">w</span> <span class="main">⟹</span>
  reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span> <span class="main">(</span>w_sj <span class="free">w</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reach_window_run_sj
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_matchF_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> reach_window.simps<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">matchF_loop_cond</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="keyword1">case</span> w_read_t <span class="free">args</span> <span class="main">(</span>w_tj <span class="bound">w</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False
  <span class="main">|</span> Some <span class="bound">t'</span> <span class="main">⇒</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="main">+</span> right <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">∧</span> w_read_sub <span class="free">args</span> <span class="main">(</span>w_sj <span class="bound">w</span><span class="main">)</span> <span class="main">≠</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">matchF_loop_inv</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="free"><span class="bound"><span class="entity">tjm</span></span></span> <span class="free"><span class="bound"><span class="entity">sjm</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> valid_window <span class="free">args</span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">(</span>take <span class="main">(</span>w_j <span class="bound">w</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span><span class="main">)</span> <span class="bound">w</span> <span class="main">∧</span>
  w_i <span class="bound">w</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> w_ti <span class="bound">w</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span> <span class="main">∧</span> w_si <span class="bound">w</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="main">∧</span>
  reach_window <span class="free">args</span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">(</span>w_j <span class="bound">w</span><span class="main">,</span> w_tj <span class="bound">w</span><span class="main">,</span> w_sj <span class="bound">w</span><span class="main">,</span> length <span class="free"><span class="bound"><span class="entity">rho</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tjm</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sjm</span></span></span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span>w_i <span class="bound">w</span><span class="main">..&lt;</span>w_j <span class="bound">w</span><span class="main">}</span><span class="main">.</span> ts_at <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">l</span> <span class="main">≤</span> ts_at <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">+</span> right <span class="free"><span class="bound"><span class="entity">I</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">matchF_loop_inv'</span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">tj</span></span></span> <span class="free"><span class="bound"><span class="entity">sj</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> w_i <span class="bound">w</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> w_ti <span class="bound">w</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span> <span class="main">∧</span> w_si <span class="bound">w</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∃</span><span class="bound">rho'</span><span class="main">.</span> valid_window <span class="free">args</span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">@</span> <span class="bound">rho'</span><span class="main">)</span> <span class="bound">w</span> <span class="main">∧</span>
    reach_window <span class="free">args</span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">@</span> <span class="bound">rho'</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tj</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sj</span></span></span><span class="main">,</span> w_j <span class="bound">w</span><span class="main">,</span> w_tj <span class="bound">w</span><span class="main">,</span> w_sj <span class="bound">w</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">eval_matchF</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> ℐ <span class="main">⇒</span> <span class="main">(</span>bool iarray<span class="main">,</span> nat set<span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> window <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> bool<span class="main">)</span> <span class="main">×</span> <span class="main">(</span>bool iarray<span class="main">,</span> nat set<span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> window<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">eval_matchF</span> <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">case</span> w_read_t <span class="free">args</span> <span class="main">(</span>w_ti <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None
    <span class="main">|</span> Some <span class="bound">t</span> <span class="main">⇒</span> 
      <span class="keyword1">let</span> <span class="bound">w'</span> <span class="main">=</span> while <span class="main">(</span>matchF_loop_cond <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="bound">t</span><span class="main">)</span> <span class="main">(</span>adv_end <span class="free">args</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="keyword1">in</span>
      <span class="main">(</span><span class="keyword1">case</span> w_read_t <span class="free">args</span> <span class="main">(</span>w_tj <span class="bound">w'</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> None
      <span class="main">|</span> Some <span class="bound">t'</span> <span class="main">⇒</span> <span class="keyword1">if</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">+</span> right <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="keyword1">then</span> None <span class="keyword1">else</span>
        <span class="keyword1">let</span> <span class="bound">β</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> snd <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="main">(</span>w_s <span class="bound">w'</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False
          <span class="main">|</span> Some <span class="bound">tstp</span> <span class="main">⇒</span> <span class="bound">t</span> <span class="main">+</span> left <span class="free"><span class="bound"><span class="entity">I</span></span></span> <span class="main">≤</span> fst <span class="bound">tstp</span><span class="main">)</span> <span class="keyword1">in</span>
        Some <span class="main">(</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">β</span><span class="main">)</span><span class="main">,</span> adv_start <span class="free">args</span> <span class="bound">w'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword1"><span class="command">locale</span></span> MDL_window <span class="main">=</span> MDL <span class="quoted"><span class="free">σ</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="free">σ</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">::</span> timestamp<span class="main">)</span> trace"</span></span> <span class="main">+</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">r</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">::</span> timestamp<span class="main">)</span> regex"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">t0</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'t</span></span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">sub</span> <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'e</span></span></span>
    <span class="keyword2"><span class="keyword">and</span></span> <span class="free">args</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool iarray<span class="main">,</span> nat set<span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> args"</span></span>
  <span class="keyword2"><span class="keyword">assumes</span></span> init_def<span class="main">:</span> <span class="quoted"><span class="quoted">"w_init <span class="free">args</span> <span class="main">=</span> <span class="main">{</span><span class="main">0</span> <span class="main">::</span> nat<span class="main">}</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> step_def<span class="main">:</span> <span class="quoted"><span class="quoted">"w_step <span class="free">args</span> <span class="main">=</span>
      NFA.delta' <span class="main">(</span>IArray <span class="main">(</span>build_nfa_impl <span class="free">r</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> state_cnt <span class="free">r</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>state_cnt <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> accept_def<span class="main">:</span> <span class="quoted"><span class="quoted">"w_accept <span class="free">args</span> <span class="main">=</span>
      NFA.accept' <span class="main">(</span>IArray <span class="main">(</span>build_nfa_impl <span class="free">r</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> state_cnt <span class="free">r</span><span class="main">,</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>state_cnt <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> run_t_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="free">ts</span> <span class="free">t</span> <span class="main">⟹</span>
      w_run_t <span class="free">args</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">t'</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="main">(</span>length <span class="free">ts</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> run_sub_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="free">bs</span> <span class="free">s</span> <span class="main">⟹</span>
      w_run_sub <span class="free">args</span> <span class="free">s</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟹</span>
      <span class="free">b</span> <span class="main">=</span> IArray <span class="main">(</span>map <span class="main">(</span>sat <span class="main">(</span>length <span class="free">bs</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>collect_subfmlas <span class="free">r</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> run_t_read<span class="main">:</span> <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">t'</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> w_read_t <span class="free">args</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">x</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> read_t_run<span class="main">:</span> <span class="quoted"><span class="quoted">"w_read_t <span class="free">args</span> <span class="free">t</span> <span class="main">=</span> Some <span class="free">x</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">t'</span><span class="main">.</span> w_run_t <span class="free">args</span> <span class="free">t</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">t'</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> run_sub_read<span class="main">:</span> <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span> <span class="free">s</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟹</span> w_read_sub <span class="free">args</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">y</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> read_sub_run<span class="main">:</span> <span class="quoted"><span class="quoted">"w_read_sub <span class="free">args</span> <span class="free">s</span> <span class="main">=</span> Some <span class="free">y</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> w_run_sub <span class="free">args</span> <span class="free">s</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">qf</span> <span class="main">=</span> state_cnt <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">transs</span> <span class="main">=</span> build_nfa_impl <span class="free">r</span> <span class="main">(</span><span class="main">0</span><span class="main">,</span> qf<span class="main">,</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">init</span> <span class="main">≡</span> w_init <span class="free">args</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="main">≡</span> w_step <span class="free">args</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="main">≡</span> w_accept <span class="free">args</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="main">≡</span> NFA.run' <span class="main">(</span>IArray transs<span class="main">)</span> qf"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">wacc</span> <span class="main">≡</span> Window.acc <span class="main">(</span>w_step <span class="free">args</span><span class="main">)</span> <span class="main">(</span>w_accept <span class="free">args</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">rw</span> <span class="main">≡</span> reach_window <span class="free">args</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">valid_matchP</span> <span class="main">≡</span> valid_window_matchP <span class="free">args</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval_mP</span> <span class="main">≡</span> eval_matchP <span class="free">args</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">matchP_inv</span> <span class="main">≡</span> matchP_loop_inv <span class="free">args</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">matchP_cond</span> <span class="main">≡</span> matchP_loop_cond <span class="free">args</span>"</span></span>

<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">valid_matchF</span> <span class="main">≡</span> valid_window_matchF <span class="free">args</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">eval_mF</span> <span class="main">≡</span> eval_matchF <span class="free">args</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">matchF_inv</span> <span class="main">≡</span> matchF_loop_inv <span class="free">args</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">matchF_inv'</span> <span class="main">≡</span> matchF_loop_inv' <span class="free">args</span>"</span></span>
<span class="keyword1"><span class="command">abbreviation</span></span> <span class="quoted"><span class="quoted">"<span class="free">matchF_cond</span> <span class="main">≡</span> matchF_loop_cond <span class="free">args</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> run_t_sound'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="free">ts</span> <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">ts</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">t''</span></span> <span class="keyword2"><span class="keyword">where</span></span> t'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">ts</span><span class="main">)</span> <span class="skolem">t'</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="skolem">t'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">t''</span><span class="main">,</span> <span class="free">ts</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_sub_split<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> run_t_sound<span class="main">[</span><span class="operator">OF</span> t'_def<span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min.absorb2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> run_sub_sound'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="free">bs</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="free">bs</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">bs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">=</span> IArray <span class="main">(</span>map <span class="main">(</span>sat <span class="free">i</span><span class="main">)</span> <span class="main">(</span>collect_subfmlas <span class="free">r</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">bs</span><span class="main">)</span> <span class="skolem">s'</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span> <span class="skolem">s'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">s''</span><span class="main">,</span> <span class="free">bs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_sub_split<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> run_sub_sound<span class="main">[</span><span class="operator">OF</span> s'_def<span class="main">]</span> assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> min.absorb2<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> run_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t</span> <span class="free">ts</span> <span class="free">t'</span> <span class="main">⟹</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t0</span> <span class="main">⟹</span> chain_le <span class="free">ts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">t</span></span> <span class="quoted"><span class="free">ts</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reach_sub_rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">s''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">zs</span> <span class="skolem">z</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">using</span></span> chain_le_app<span class="main">[</span><span class="operator">OF</span> _ τ_mono<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span>"</span></span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        run_t_sound'<span class="main">[</span><span class="operator">OF</span> reach_sub_app<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> 2<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">zs</span>"</span></span><span class="main">]</span>
        run_t_sound'<span class="main">[</span><span class="operator">OF</span> reach_sub_app<span class="main"><span class="main">[</span></span><span class="operator">OF</span> 2<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> 2<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"Suc <span class="main">(</span>length <span class="skolem">zs</span><span class="main">)</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> snoc
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> chain_le.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> chain_le.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> ts_at_tau<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">rho</span> <span class="main">⟹</span>
  ts_at <span class="free">rho</span> <span class="free">i</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">i</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> run_t_sound'
  <span class="keyword1"><span class="command">unfolding</span></span> ts_at_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> length_bs_at<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">rho</span> <span class="main">⟹</span>
  IArray.length <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> length <span class="main">(</span>collect_subfmlas <span class="free">r</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> run_sub_sound'
  <span class="keyword1"><span class="command">unfolding</span></span> bs_at_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> bs_at_nth<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">rho</span> <span class="main">⟹</span>
  <span class="free">n</span> <span class="main">&lt;</span> IArray.length <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span>
  IArray.sub <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span> <span class="free">n</span> <span class="main">⟷</span> sat <span class="free">i</span> <span class="main">(</span>collect_subfmlas <span class="free">r</span> <span class="main">[]</span> <span class="main">!</span> <span class="free">n</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> run_sub_sound'
  <span class="keyword1"><span class="command">unfolding</span></span> bs_at_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> ts_at_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span> <span class="free">t</span> <span class="main">⟹</span>
  <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">rho</span> <span class="main">⟹</span> ts_at <span class="free">rho</span> <span class="bound">i</span> <span class="main">≤</span> ts_at <span class="free">rho</span> <span class="bound">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> ts_at_tau
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> steps_is_run<span class="main">:</span> <span class="quoted"><span class="quoted">"steps <span class="main">(</span>w_step <span class="free">args</span><span class="main">)</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">ij</span> <span class="main">=</span> run <span class="free">q</span> <span class="main">(</span>sub_bs <span class="free">rho</span> <span class="free">ij</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> NFA.run'_def steps_def step_def transs_def qf_def <span class="keyword1"><span class="command">..</span></span>

<span class="keyword1"><span class="command">lemma</span></span> acc_is_accept<span class="main">:</span> <span class="quoted"><span class="quoted">"wacc <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> w_accept <span class="free">args</span> <span class="main">(</span>run <span class="free">q</span> <span class="main">(</span>sub_bs <span class="free">rho</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
  <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> acc_def steps_is_run <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> iarray_list_of<span class="main">:</span> <span class="quoted"><span class="quoted">"IArray <span class="main">(</span>IArray.list_of <span class="free">xs</span><span class="main">)</span> <span class="main">=</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="free">xs</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> map_iarray_list_of<span class="main">:</span> <span class="quoted"><span class="quoted">"map IArray <span class="main">(</span>map IArray.list_of <span class="free">bss</span><span class="main">)</span> <span class="main">=</span> <span class="free">bss</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> iarray_list_of
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">bss</span></span><span class="main">)</span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> acc_match<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">rho</span> <span class="main">⟹</span>
    wacc <span class="free">rho</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> match <span class="free">r</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span> <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">rho</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> j_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> length <span class="main">(</span>sub_bs <span class="free">rho</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> IH<span class="main">:</span> <span class="quoted"><span class="quoted">"IH <span class="free">r</span> <span class="main">0</span> qf <span class="main">[]</span> transs <span class="main">(</span>map IArray.list_of <span class="main">(</span>sub_bs <span class="free">rho</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>
    <span class="main">(</span>IArray.list_of <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> IH_def transs_def qf_def NFA.SQ_def build_nfa_impl_state_cnt
    <span class="keyword1"><span class="command">using</span></span> assms run_sub_sound bs_at_nth length_bs_at <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">interpret</span></span> NFA_array<span class="main">:</span> nfa_array <span class="quoted">transs</span> <span class="quoted"><span class="quoted">"IArray transs"</span></span> <span class="quoted">qf</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">unfold_locales</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> qf_def transs_def build_nfa_impl_state_cnt<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> nfa_correct<span class="main">[</span><span class="operator">OF</span> IH<span class="main">,</span> <span class="operator">unfolded</span> NFA.run_accept_def<span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> NFA_array.accept'_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"bs_at <span class="free">rho</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"IArray.list_of <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">j</span><span class="main">)</span>"</span></span><span class="main">]</span>
      NFA_array.run'_eq<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"sub_bs <span class="free">rho</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"map IArray.list_of <span class="main">(</span>sub_bs <span class="free">rho</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span>"</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> acc_is_accept j_eq<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> accept_def acc_def length_map steps_is_run
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> transs_def qf_def iarray_list_of map_iarray_list_of<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> accept_match<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">ts</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span> <span class="free">s</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">rho</span> <span class="main">⟹</span>
  w_accept <span class="free">args</span> <span class="main">(</span>steps <span class="main">(</span>w_step <span class="free">args</span><span class="main">)</span> <span class="free">rho</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟷</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> match <span class="free">r</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> acc_match acc_is_accept steps_is_run
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>

<span class="keyword1"><span class="command">lemma</span></span> drop_take_drop<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">rho</span> <span class="main">⟹</span> drop <span class="free">i</span> <span class="main">(</span>take <span class="free">j</span> <span class="free">rho</span><span class="main">)</span> <span class="main">@</span> drop <span class="free">j</span> <span class="free">rho</span> <span class="main">=</span> drop <span class="free">i</span> <span class="free">rho</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">rho</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> append_take_drop_id diff_add drop_drop drop_take<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> take_Suc<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="free">n</span> <span class="free">xs</span> <span class="main">=</span> <span class="free">y</span> <span class="main">#</span> <span class="free">ys</span> <span class="main">⟹</span> take <span class="free">n</span> <span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">y</span><span class="main">]</span> <span class="main">=</span> take <span class="main">(</span>Suc <span class="free">n</span><span class="main">)</span> <span class="free">xs</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> drop_all list.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> list.sel<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_less take_hd_drop<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_init_matchP<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_matchP <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>init_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_init_window
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_matchP_def Let_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reach_sub.intros <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_init_matchF<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_matchF <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">[]</span> <span class="main">0</span> <span class="main">(</span>init_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> valid_init_window
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_matchF_def Let_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reach_sub.intros <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_eval_matchP<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_before'<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_matchP <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">j</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> before_end<span class="main">:</span> <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="main">(</span>w_tj <span class="free">w</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">tj'''</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span> <span class="main">(</span>w_sj <span class="free">w</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">sj'''</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w'</span><span class="main">.</span> eval_mP <span class="free">I</span> <span class="free">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">,</span> sat <span class="free">j</span> <span class="main">(</span>MatchP <span class="free">I</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">w'</span><span class="main">)</span> <span class="main">∧</span>
    <span class="free">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">∧</span> valid_matchP <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="bound">w'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> w_st <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> w_i <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ti</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ti</span> <span class="main">=</span> w_ti <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">si</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">si</span> <span class="main">=</span> w_si <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj</span> <span class="main">=</span> w_tj <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sj</span> <span class="main">=</span> w_sj <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> w_s <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> w_e <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">ti</span><span class="main">,</span> <span class="skolem">si</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="skolem">tj</span><span class="main">,</span> <span class="skolem">sj</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">rho</span> <span class="main">⟹</span> ts_at <span class="free">rho</span> <span class="bound">i</span> <span class="main">≤</span> ts_at <span class="free">rho</span> <span class="bound">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> mmap_lookup <span class="skolem">e</span> <span class="bound">q</span> <span class="main">=</span> sup_leadsto init step <span class="free">rho</span> <span class="skolem">i</span> <span class="free">j</span> <span class="bound">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"valid_s init step <span class="skolem">st</span> accept <span class="free">rho</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="free">j</span> <span class="skolem">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> w_j <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before'<span class="main">[</span><span class="operator">unfolded</span> valid_window_matchP_def<span class="main">]</span> ti_def
      si_def i_def tj_def sj_def s_def e_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_def Let_def init_def step_def st_def accept_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> read_t_def <span class="main">=</span> run_t_read<span class="main">[</span><span class="operator">OF</span> before_end<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> t_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound"><span class="bound">l</span></span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">.</span> ts_at <span class="free">rho</span> <span class="bound">l</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before'<span class="main">[</span><span class="operator">unfolded</span> valid_window_matchP_def read_t_def<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> i_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> read_sub_def <span class="main">=</span> run_sub_read<span class="main">[</span><span class="operator">OF</span> before_end<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rho'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rho'</span> <span class="main">=</span> <span class="free">rho</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">note</span></span> rw_app <span class="main">=</span> reach_window_app<span class="main">[</span><span class="operator">OF</span> valid_before<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
      before_end<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> tj_def<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main">]</span></span> sj_def<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> reach_sub'<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>map fst <span class="skolem">rho'</span><span class="main">)</span> <span class="free">tj'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_window_run_tj<span class="main">[</span><span class="operator">OF</span> rw_app<span class="main">]</span> valid_before<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> length_rho<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">rho</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> reach_sub_tj<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span> <span class="skolem">tj</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before reach_sub_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> reach_sub_tj'<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>map fst <span class="skolem">rho'</span><span class="main">)</span> <span class="free">tj'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_sub_app before_end <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def tj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span> <span class="skolem">sj</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before reach_sub_trans <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> reach_sub_sj'<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>map snd <span class="skolem">rho'</span><span class="main">)</span> <span class="free">sj'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_sub_app before_end <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def sj_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tj_def'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> ts_at <span class="skolem">rho'</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> run_t_sound'<span class="main">[</span><span class="operator">OF</span> reach_sub_tj'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_rho nth_append ts_at_def rho'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> bj_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> bs_at <span class="skolem">rho'</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> run_sub_sound'<span class="main">[</span><span class="operator">OF</span> reach_sub_sj'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_rho nth_append bs_at_def rho'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> j_len_rho'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="skolem">rho'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> length_rho rho'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> loop_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">=</span> while <span class="main">(</span>matchP_cond <span class="free">I</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>adv_start <span class="free">args</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> inv_before<span class="main">:</span> <span class="quoted"><span class="quoted">"matchP_inv <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="free">t</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before valid_before'<span class="main">[</span><span class="operator">unfolded</span> valid_window_matchP_def<span class="main">]</span> t_props
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> matchP_loop_inv_def read_t_def i_def tj_def sj_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> loop<span class="main">:</span> <span class="quoted"><span class="quoted">"matchP_inv <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="free">t</span> <span class="skolem">w'</span> <span class="main">∧</span> <span class="main">¬</span> matchP_cond <span class="free">I</span> <span class="free">t</span> <span class="skolem">w'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> loop_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> while_rule_lemma<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"matchP_inv <span class="free"><span class="free">I</span></span> <span class="free"><span class="free">t0</span></span> <span class="free"><span class="free">sub</span></span> <span class="free"><span class="free">rho</span></span> <span class="free"><span class="free">j</span></span> <span class="skolem"><span class="skolem">tj</span></span> <span class="skolem"><span class="skolem">sj</span></span> <span class="free"><span class="free">t</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w_cur</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool iarray<span class="main">,</span> nat set<span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> window"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"matchP_inv <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="free">t</span> <span class="skolem">w_cur</span>"</span></span> <span class="quoted"><span class="quoted">"matchP_cond <span class="free">I</span> <span class="free">t</span> <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">st_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st_cur</span> <span class="main">=</span> w_st <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i_cur</span> <span class="main">=</span> w_i <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ti_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ti_cur</span> <span class="main">=</span> w_ti <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">si_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">si_cur</span> <span class="main">=</span> w_si <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s_cur</span> <span class="main">=</span> w_s <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e_cur</span> <span class="main">=</span> w_e <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> valid_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="skolem">i_cur</span><span class="main">,</span> <span class="skolem">ti_cur</span><span class="main">,</span> <span class="skolem">si_cur</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="skolem">tj</span><span class="main">,</span> <span class="skolem">sj</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">rho</span> <span class="main">⟹</span> ts_at <span class="free">rho</span> <span class="bound">i</span> <span class="main">≤</span> ts_at <span class="free">rho</span> <span class="bound">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> mmap_lookup <span class="skolem">e_cur</span> <span class="bound">q</span> <span class="main">=</span> sup_leadsto init step <span class="free">rho</span> <span class="skolem">i_cur</span> <span class="free">j</span> <span class="bound">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"valid_s init step <span class="skolem">st_cur</span> accept <span class="free">rho</span> <span class="skolem">i_cur</span> <span class="skolem">i_cur</span> <span class="free">j</span> <span class="skolem">s_cur</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> w_j <span class="skolem">w_cur</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> matchP_loop_inv_def valid_window_matchP_def<span class="main">]</span> valid_before<span class="main">(</span>6<span class="main">)</span>
        ti_cur_def si_cur_def i_cur_def s_cur_def e_cur_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_def Let_def init_def step_def st_cur_def accept_def
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ti'_cur</span></span> <span class="skolem"><span class="skolem">si'_cur</span></span> <span class="skolem"><span class="skolem">t_cur</span></span> <span class="skolem"><span class="skolem">b_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> run_si_cur<span class="main">:</span>
      <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="skolem">ti_cur</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ti'_cur</span><span class="main">,</span> <span class="skolem">t_cur</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span> <span class="skolem">si_cur</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">si'_cur</span><span class="main">,</span> <span class="skolem">b_cur</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t_cur</span> <span class="main">=</span> ts_at <span class="free">rho</span> <span class="skolem">i_cur</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b_cur</span> <span class="main">=</span> bs_at <span class="free">rho</span> <span class="skolem">i_cur</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> reach_window_run_si<span class="main">[</span><span class="operator">OF</span> valid_loop<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> reach_window_run_ti<span class="main">[</span><span class="operator">OF</span> valid_loop<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> matchP_loop_cond_def valid_loop<span class="main">(</span>5<span class="main">)</span> i_cur_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="skolem">i_cur</span> <span class="main">⟹</span> ts_at <span class="free">rho</span> <span class="bound">l</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> matchP_loop_inv_def i_cur_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="skolem">i_cur</span> <span class="main">+</span> <span class="main">1</span> <span class="main">⟹</span> ts_at <span class="free">rho</span> <span class="bound">l</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> run_t_read<span class="main">[</span><span class="operator">OF</span> run_si_cur<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> run_si_cur<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> matchP_loop_cond_def i_cur_def ti_cur_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> less_Suc_eq<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"matchP_inv <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="free">t</span> <span class="main">(</span>adv_start <span class="free">args</span> <span class="skolem">w_cur</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms i_cur_def valid_adv_start valid_adv_start_bounds
      <span class="keyword1"><span class="command">unfolding</span></span> matchP_loop_inv_def matchP_loop_cond_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w1</span> <span class="skolem">w2</span>
      <span class="keyword3"><span class="command">assume</span></span> lassms<span class="main">:</span> <span class="quoted"><span class="quoted">"matchP_inv <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="free">t</span> <span class="skolem">w1</span>"</span></span> <span class="quoted"><span class="quoted">"matchP_cond <span class="free">I</span> <span class="free">t</span> <span class="skolem">w1</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">=</span> adv_start <span class="free">args</span> <span class="skolem">w1</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i_cur</span> <span class="main">=</span> w_i <span class="skolem">w1</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ti_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ti_cur</span> <span class="main">=</span> w_ti <span class="skolem">w1</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">si_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">si_cur</span> <span class="main">=</span> w_si <span class="skolem">w1</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> valid_loop<span class="main">:</span> <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="skolem">i_cur</span><span class="main">,</span> <span class="skolem">ti_cur</span><span class="main">,</span> <span class="skolem">si_cur</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="skolem">tj</span><span class="main">,</span> <span class="skolem">sj</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">=</span> w_j <span class="skolem">w1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> matchP_loop_inv_def valid_window_matchP_def<span class="main">]</span> valid_before<span class="main">(</span>6<span class="main">)</span>
          ti_cur_def si_cur_def i_cur_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_def Let_def<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ti'_cur</span></span> <span class="skolem"><span class="skolem">si'_cur</span></span> <span class="skolem"><span class="skolem">t_cur</span></span> <span class="skolem"><span class="skolem">b_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> run_si_cur<span class="main">:</span>
        <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="skolem">ti_cur</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ti'_cur</span><span class="main">,</span> <span class="skolem">t_cur</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span> <span class="skolem">si_cur</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">si'_cur</span><span class="main">,</span> <span class="skolem">b_cur</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>2<span class="main">)</span> reach_window_run_si<span class="main">[</span><span class="operator">OF</span> valid_loop<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> reach_window_run_ti<span class="main">[</span><span class="operator">OF</span> valid_loop<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> matchP_loop_cond_def valid_loop i_cur_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> w1_ij<span class="main">:</span> <span class="quoted"><span class="quoted">"w_i <span class="skolem">w1</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"w_j <span class="skolem">w1</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lassms
        <span class="keyword1"><span class="command">unfolding</span></span> matchP_loop_inv_def matchP_loop_cond_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> w2_ij<span class="main">:</span> <span class="quoted"><span class="quoted">"w_i <span class="skolem">w2</span> <span class="main">=</span> Suc <span class="main">(</span>w_i <span class="skolem">w1</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"w_j <span class="skolem">w2</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> w1_ij lassms<span class="main">(</span>3<span class="main">)</span> run_si_cur<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> ti_cur_def si_cur_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> adv_start_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"w_j <span class="skolem">w2</span> <span class="main">-</span> w_i <span class="skolem">w2</span> <span class="main">&lt;</span> w_j <span class="skolem">w1</span> <span class="main">-</span> w_i <span class="skolem">w1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> w1_ij w2_ij
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> matchP_inv <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="free">t</span> <span class="bound">s</span> <span class="main">∧</span> matchP_cond <span class="free">I</span> <span class="free">t</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="bound">s'</span> <span class="main">=</span> adv_start <span class="free">args</span> <span class="bound">s</span><span class="main">}</span> <span class="main">⊆</span> measure <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> w_j <span class="bound">w</span> <span class="main">-</span> w_i <span class="bound">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> matchP_inv <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="free">t</span> <span class="bound">s</span> <span class="main">∧</span> matchP_cond <span class="free">I</span> <span class="free">t</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="bound">s'</span> <span class="main">=</span> adv_start <span class="free">args</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_measure wf_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_before<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st'</span> <span class="main">=</span> w_st <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ac</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ac</span> <span class="main">=</span> w_ac <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> w_i <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ti'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ti'</span> <span class="main">=</span> w_ti <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">si'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">si'</span> <span class="main">=</span> w_si <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> w_s <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">=</span> w_e <span class="skolem">w'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> valid_after<span class="main">:</span> <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="skolem">i'</span><span class="main">,</span> <span class="skolem">ti'</span><span class="main">,</span> <span class="skolem">si'</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="skolem">tj</span><span class="main">,</span> <span class="skolem">sj</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">rho</span> <span class="main">⟹</span> ts_at <span class="free">rho</span> <span class="bound">i</span> <span class="main">≤</span> ts_at <span class="free">rho</span> <span class="bound">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">e'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> mmap_lookup <span class="skolem">e'</span> <span class="bound">q</span> <span class="main">=</span> sup_leadsto init step <span class="free">rho</span> <span class="skolem">i'</span> <span class="free">j</span> <span class="bound">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">ac</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> accept <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
    <span class="quoted"><span class="quoted">"valid_s init step <span class="skolem">st'</span> accept <span class="free">rho</span> <span class="skolem">i'</span> <span class="skolem">i'</span> <span class="free">j</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">rho</span>"</span></span>
    <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="skolem">w'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conjunct1<span class="main">[</span><span class="operator">OF</span> loop<span class="main">]</span> i'_def ti'_def si'_def s'_def e'_def
    <span class="keyword1"><span class="command">unfolding</span></span> matchP_loop_inv_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_def Let_def init_def step_def st'_def ac_def accept_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> lookup_e' <span class="main">=</span> valid_after<span class="main">(</span>3<span class="main">,</span>5<span class="main">,</span>6<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="skolem"><span class="skolem">ac'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ac'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"ex_key <span class="skolem">e'</span> <span class="main">(</span><span class="main">λ</span><span class="bound">t'</span><span class="main">.</span> <span class="free">t</span> <span class="main">≤</span> <span class="bound">t'</span> <span class="main">+</span> right <span class="free">I</span><span class="main">)</span>
    <span class="main">(</span>w_accept <span class="free">args</span><span class="main">)</span> <span class="skolem">ac</span> <span class="free">b</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">β</span><span class="main">,</span> <span class="skolem">ac'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> β_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> <span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>mmap_keys <span class="skolem">e'</span><span class="main">.</span> <span class="free">t</span> <span class="main">≤</span> the <span class="main">(</span>mmap_lookup <span class="skolem">e'</span> <span class="bound">q</span><span class="main">)</span> <span class="main">+</span> right <span class="free">I</span> <span class="main">∧</span> accept <span class="bound">q</span> <span class="free">b</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">ac'</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> accept <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ex_key_sound<span class="main">[</span><span class="operator">OF</span> valid_after<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> valid_after<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ac'_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β'</span></span> <span class="skolem"><span class="skolem">ac''</span></span> <span class="keyword2"><span class="keyword">where</span></span> ac''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">if</span> <span class="skolem">β</span> <span class="keyword1">then</span> <span class="main">(</span>True<span class="main">,</span> <span class="skolem">ac'</span><span class="main">)</span>
    <span class="keyword1">else</span> <span class="keyword1">if</span> mem <span class="free">t</span> <span class="free">t</span> <span class="free">I</span> <span class="keyword1">then</span> cac <span class="main">(</span>w_accept <span class="free">args</span><span class="main">)</span> <span class="skolem">ac'</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="free">b</span>
    <span class="keyword1">else</span> <span class="main">(</span>False<span class="main">,</span> <span class="skolem">ac'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">β'</span><span class="main">,</span> <span class="skolem">ac''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> β'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β'</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>mmap_keys <span class="skolem">e'</span><span class="main">.</span> <span class="free">t</span> <span class="main">≤</span> <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="skolem">e'</span> <span class="bound">q</span><span class="main">)</span><span class="main">)</span> <span class="main">+</span> right <span class="free">I</span> <span class="main">∧</span>
    accept <span class="bound">q</span> <span class="free">b</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>mem <span class="free">t</span> <span class="free">t</span> <span class="free">I</span> <span class="main">∧</span> accept <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">ac''</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> accept <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ac''_def β_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cac_def Let_def Mapping.lookup_update' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w''</span></span> <span class="keyword2"><span class="keyword">where</span></span> adv_end_last<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w''</span> <span class="main">=</span> adv_end <span class="free">args</span> <span class="main">(</span><span class="skolem">w'</span><span class="main">⦇</span>w_ac <span class="main">:=</span> <span class="skolem">ac''</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> adv_loop_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"w_j <span class="main">(</span><span class="skolem">w'</span><span class="main">⦇</span>w_ac <span class="main">:=</span> <span class="skolem">ac''</span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"w_tj <span class="main">(</span><span class="skolem">w'</span><span class="main">⦇</span>w_ac <span class="main">:=</span> <span class="skolem">ac''</span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">tj</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_sj <span class="main">(</span><span class="skolem">w'</span><span class="main">⦇</span>w_ac <span class="main">:=</span> <span class="skolem">ac''</span><span class="main">⦈</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">sj</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> loop <span class="keyword1"><span class="command">unfolding</span></span> matchP_loop_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> valid_w'<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="skolem">w'</span><span class="main">⦇</span>w_ac <span class="main">:=</span> <span class="skolem">ac''</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_after<span class="main">(</span>9<span class="main">)</span> β'_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_def Let_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> adv_last_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"w_i <span class="skolem">w''</span> <span class="main">=</span> w_i <span class="main">(</span><span class="skolem">w'</span><span class="main">⦇</span>w_ac <span class="main">:=</span> <span class="skolem">ac''</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"w_ti <span class="skolem">w''</span> <span class="main">=</span> w_ti <span class="main">(</span><span class="skolem">w'</span><span class="main">⦇</span>w_ac <span class="main">:=</span> <span class="skolem">ac''</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_si <span class="skolem">w''</span> <span class="main">=</span> w_si <span class="main">(</span><span class="skolem">w'</span><span class="main">⦇</span>w_ac <span class="main">:=</span> <span class="skolem">ac''</span><span class="main">⦈</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"w_j <span class="skolem">w''</span> <span class="main">=</span> Suc <span class="main">(</span>w_j <span class="main">(</span><span class="skolem">w'</span><span class="main">⦇</span>w_ac <span class="main">:=</span> <span class="skolem">ac''</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_sj <span class="skolem">w''</span> <span class="main">=</span> <span class="free">sj'''</span>"</span></span> <span class="quoted"><span class="quoted">"w_tj <span class="skolem">w''</span> <span class="main">=</span> <span class="free">tj'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adv_end_last adv_loop_bounds<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span>
      before_end<span class="main">[</span><span class="operator">unfolded</span> adv_loop_bounds<span class="main"><span class="main"><span class="main">(</span></span></span>2<span class="main"><span class="main"><span class="main">,</span></span></span>3<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">unfolded</span></span> tj_def sj_def<span class="main"><span class="main"><span class="main">,</span></span></span> <span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> adv_end_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> j''_j<span class="main">:</span> <span class="quoted"><span class="quoted">"w_j <span class="skolem">w''</span> <span class="main">=</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adv_loop_bounds adv_last_bounds <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> i'_le_j<span class="main">:</span> <span class="quoted"><span class="quoted">"w_i <span class="skolem">w'</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_after<span class="main">(</span>7<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> i'_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> i'_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> w_i <span class="skolem">w'</span> <span class="main">⟹</span> ts_at <span class="skolem">rho'</span> <span class="bound">l</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> ts_at <span class="skolem">rho'</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> loop length_rho i'_le_j
    <span class="keyword1"><span class="command">unfolding</span></span> matchP_loop_inv_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_at_def rho'_def nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> b_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> mmap_keys <span class="skolem">e'</span><span class="main">.</span> <span class="free">t</span> <span class="main">≤</span> the <span class="main">(</span>mmap_lookup <span class="skolem">e'</span> <span class="bound">q</span><span class="main">)</span> <span class="main">+</span> right <span class="free">I</span> <span class="main">∧</span>
    accept <span class="bound">q</span> <span class="free">b</span><span class="main">)</span> <span class="main">∨</span> <span class="main">(</span>mem <span class="free">t</span> <span class="free">t</span> <span class="free">I</span> <span class="main">∧</span> accept <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="free">b</span><span class="main">)</span> <span class="main">⟷</span>
    sat <span class="free">j</span> <span class="main">(</span>MatchP <span class="free">I</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main"><span class="keyword3">,</span></span> <span class="operator">erule</span> disjE<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">q</span> <span class="main">∈</span> mmap_keys <span class="skolem">e'</span><span class="main">.</span> <span class="free">t</span> <span class="main">≤</span> the <span class="main">(</span>mmap_lookup <span class="skolem">e'</span> <span class="bound">q</span><span class="main">)</span> <span class="main">+</span> right <span class="free">I</span> <span class="main">∧</span>
      accept <span class="bound">q</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">∈</span> mmap_keys <span class="skolem">e'</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤</span> the <span class="main">(</span>mmap_lookup <span class="skolem">e'</span> <span class="skolem">q</span><span class="main">)</span> <span class="main">+</span> right <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"accept <span class="skolem">q</span> <span class="free">b</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ts'</span></span> <span class="keyword2"><span class="keyword">where</span></span> ts_def<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="skolem">e'</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="skolem">ts'</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sup_leadsto init step <span class="skolem">rho'</span> <span class="skolem">i'</span> <span class="free">j</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="skolem">ts'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lookup_e' ts_def q_def valid_after<span class="main">(</span>4<span class="main">,</span>7<span class="main">,</span>8<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def sup_leadsto_app_cong<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"steps step <span class="skolem">rho'</span> init <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
      <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho'</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">ts'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sup_leadsto_SomeE<span class="main">[</span><span class="operator">OF</span> i'_le_j<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> i'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> l_le_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_def<span class="main">(</span>1<span class="main">)</span> i'_le_j <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> i'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> tau_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> fst <span class="main">(</span><span class="free">rho</span> <span class="main">!</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> run_t_sound'<span class="main">[</span><span class="operator">OF</span> reach_sub_tj'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span><span class="main">]</span> length_rho
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> tau_l_left<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts'</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> l_def<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> tj_def'<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">using</span></span> i'_set l_def<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> i'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> match <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> accept_match<span class="main">[</span><span class="operator">OF</span> reach_sub_sj' l_le_j<span class="main">]</span> q_def<span class="main">(</span>3<span class="main">)</span> length_rho init_def l_def<span class="main">(</span>2<span class="main">)</span>
        rho'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def l_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> rho'_def<span class="main"><span class="main">]</span></span> bs_at_def nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">j</span> <span class="main">(</span>MatchP <span class="free">I</span> <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_le_j q_def<span class="main">(</span>2<span class="main">)</span> ts_at_tau<span class="main">[</span><span class="operator">OF</span> reach_sub_tj'<span class="main">]</span> tau_l_left
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mem_def tj_def' rho'_def ts_def l_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> tau_l tj_def ts_at_def
          nth_append length_rho <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">l</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="free">j</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">j</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> right_I_add_mono<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mem <span class="free">t</span> <span class="free">t</span> <span class="free">I</span> <span class="main">∧</span> accept <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="free">b</span> <span class="main">⟹</span> sat <span class="free">j</span> <span class="main">(</span>MatchP <span class="free">I</span> <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> accept_match<span class="main">[</span><span class="operator">OF</span> reach_sub_sj' order.refl j_len_rho'<span class="main">,</span> <span class="operator">unfolded</span> steps_refl<span class="main">]</span> bj_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mem_def tj_def'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bs_at_def nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">j</span> <span class="main">(</span>MatchP <span class="free">I</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="free">j</span><span class="main">)</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">∈</span> match <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">∃</span><span class="bound">q</span><span class="main">∈</span>mmap_keys <span class="skolem">e'</span><span class="main">.</span> <span class="free">t</span> <span class="main">≤</span> the <span class="main">(</span>mmap_lookup <span class="skolem">e'</span> <span class="bound">q</span><span class="main">)</span> <span class="main">+</span> right <span class="free">I</span> <span class="main">∧</span>
      accept <span class="bound">q</span> <span class="free">b</span><span class="main">)</span> <span class="main">∨</span> mem <span class="free">t</span> <span class="free">t</span> <span class="free">I</span> <span class="main">∧</span> accept <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="free">b</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">=</span> <span class="free">j</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> accept_match<span class="main">[</span><span class="operator">OF</span> reach_sub_sj' l_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> j_len_rho'<span class="main">]</span> l_def<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> steps_refl
        <span class="keyword1"><span class="command">unfolding</span></span> True
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tj_def'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> bs_at_def nth_append bj_def<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_lt_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> l_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ts_at_l_j<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho'</span> <span class="skolem">l</span> <span class="main">≤</span> ts_at <span class="skolem">rho'</span> <span class="free">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ts_at_mono<span class="main">[</span><span class="operator">OF</span> reach_sub' _ j_len_rho'<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def length_rho<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> ts_j_l<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho'</span> <span class="skolem">l</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> ts_at <span class="skolem">rho'</span> <span class="free">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> l_def<span class="main">(</span>2<span class="main">)</span> ts_at_tau<span class="main">[</span><span class="operator">OF</span> reach_sub_tj'<span class="main">]</span> l_lt_j length_rho tj_def'<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> rho'_def mem_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="free">j</span> <span class="main">∨</span> <span class="main">¬</span>ts_at <span class="skolem">rho'</span> <span class="skolem">i'</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> ts_at <span class="skolem">rho'</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> Meson.disj_comm<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> disjCI<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">≠</span> <span class="free">j</span>"</span></span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i'_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> valid_after
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">t'</span></span> <span class="skolem"><span class="skolem">b'</span></span> <span class="keyword2"><span class="keyword">where</span></span> tbi_cur_def<span class="main">:</span> <span class="quoted"><span class="quoted">"w_read_t <span class="free">args</span> <span class="skolem">ti'</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span>
          <span class="quoted"><span class="quoted">"w_read_sub <span class="free">args</span> <span class="skolem">si'</span> <span class="main">=</span> Some <span class="skolem">b'</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">t'</span> <span class="main">=</span> ts_at <span class="free">rho</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b'</span> <span class="main">=</span> bs_at <span class="free">rho</span> <span class="skolem">i'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> reach_window_run_ti<span class="main">[</span><span class="operator">OF</span> valid_after<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> i'_j<span class="main">]</span>
            reach_window_run_si<span class="main">[</span><span class="operator">OF</span> valid_after<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> i'_j<span class="main">]</span> run_t_read run_sub_read
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>ts_at <span class="skolem">rho'</span> <span class="skolem">i'</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> ts_at <span class="skolem">rho'</span> <span class="free">j</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> loop tbi_cur_def<span class="main">(</span>1<span class="main">)</span> i'_j length_rho
          <span class="keyword1"><span class="command">unfolding</span></span> matchP_loop_inv_def matchP_loop_cond_def tj_def'<span class="main">(</span>2<span class="main">)</span> adv_loop_bounds
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tbi_cur_def ts_at_def rho'_def nth_append i'_def<span class="main">)</span>
             <span class="main">(</span><span class="operator">metis</span> i'_def option.sel tbi_cur_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tbi_cur_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> ti'_def ts_at_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_lt_i'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> disjE<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> ts_at <span class="skolem">rho'</span> <span class="skolem">i'</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> ts_at <span class="skolem">rho'</span> <span class="free">j</span>"</span></span>
        <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
          <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ts_at_i'_l<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho'</span> <span class="skolem">i'</span> <span class="main">≤</span> ts_at <span class="skolem">rho'</span> <span class="skolem">l</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> ts_at_mono<span class="main">[</span><span class="operator">OF</span> reach_sub'<span class="main">]</span> l_lt_j length_rho
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def length_rho<span class="main">)</span>
          <span class="keyword3"><span class="command">show</span></span> <span class="quoted">False</span>
            <span class="keyword1"><span class="command">using</span></span> add_mono_comm<span class="main">[</span><span class="operator">OF</span> ts_at_i'_l<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"left <span class="free">I</span>"</span></span><span class="main">]</span> ts_j_l assm order_trans
            <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> l_lt_j<span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> steps step <span class="skolem">rho'</span> init <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> l'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_leadsto init step <span class="skolem">rho'</span> <span class="skolem">i'</span> <span class="free">j</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span>ts_at <span class="skolem">rho'</span> <span class="skolem">l'</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">l'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">&lt;</span> <span class="skolem">i'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sup_leadsto_SomeI<span class="main">[</span><span class="operator">OF</span> l_lt_i'<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
      <span class="keyword1"><span class="command">have</span></span> ts_j_l'<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho'</span> <span class="free">j</span> <span class="main">≤</span> ts_at <span class="skolem">rho'</span> <span class="skolem">l'</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
        <span class="keyword1"><span class="command">have</span></span> ts_at_l_l'<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho'</span> <span class="skolem">l</span> <span class="main">≤</span> ts_at <span class="skolem">rho'</span> <span class="skolem">l'</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> ts_at_mono<span class="main">[</span><span class="operator">OF</span> reach_sub' l'_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> l'_def<span class="main">(</span>3<span class="main">)</span> i'_le_j length_rho valid_after<span class="main">(</span>4<span class="main">,</span>7<span class="main">,</span>8<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> rho'_def length_rho dual_order.order_iff_strict<span class="main">)</span>
        <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
          <span class="keyword1"><span class="command">using</span></span> l_def<span class="main">(</span>2<span class="main">)</span> add_mono_comm<span class="main">[</span><span class="operator">OF</span> ts_at_l_l'<span class="main">]</span> order_trans
            ts_at_tau<span class="main">[</span><span class="operator">OF</span> reach_sub_tj'<span class="main">]</span> l'_def<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> i'_le_j length_rho valid_after<span class="main">(</span>4<span class="main">,</span>7<span class="main">,</span>8<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mem_def rho'_def length_rho<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">have</span></span> lookup_e'_q<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="skolem">e'</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span>ts_at <span class="skolem">rho'</span> <span class="skolem">l'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lookup_e' l'_def<span class="main">(</span>1<span class="main">)</span> valid_after<span class="main">(</span>4<span class="main">,</span>7<span class="main">,</span>8<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def sup_leadsto_app_cong<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> accept_match<span class="main">[</span><span class="operator">OF</span> reach_sub_sj' l_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> length_rho l_def<span class="main">(</span>3<span class="main">)</span> ts_j_l' lookup_e'_q
          q_def<span class="main">[</span><span class="operator">unfolded</span> rho'_def<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> tj_def'<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> rho'_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bs_at_def nth_append init_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> bexI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main"><span class="main">]</span></span>
            Mapping_keys_intro<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i''</span> <span class="main">=</span> w_i <span class="skolem">w''</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tj''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj''</span> <span class="main">=</span> w_tj <span class="skolem">w''</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> rho_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ts_at_mono<span class="main">[</span><span class="operator">OF</span> reach_sub'<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"length <span class="free">rho</span>"</span></span><span class="main">]</span> nat_less_le
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def ts_at_def nth_append in_set_conv_nth <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t'</span> <span class="bound">l</span><span class="main">.</span> w_read_t <span class="free">args</span> <span class="skolem">tj''</span> <span class="main">=</span> Some <span class="bound">t'</span> <span class="main">⟹</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="skolem">i''</span> <span class="main">⟹</span> ts_at <span class="skolem">rho'</span> <span class="bound">l</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> <span class="bound">t'</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">t'</span> <span class="skolem">l</span>
    <span class="keyword3"><span class="command">assume</span></span> lassms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>w_read_t <span class="free">args</span><span class="main">)</span> <span class="skolem">tj''</span> <span class="main">=</span> Some <span class="skolem">t'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">i''</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tj''''</span></span> <span class="keyword2"><span class="keyword">where</span></span> reach_sub_tj''''<span class="main">:</span>
      <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">rho'</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">t'</span><span class="main">,</span> undefined<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tj''''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reach_sub_app<span class="main">[</span><span class="operator">OF</span> reach_sub_tj'<span class="main">]</span> read_t_run<span class="main">[</span><span class="operator">OF</span> lassms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        adv_last_bounds tj''_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">≤</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ts_at_mono<span class="main">[</span><span class="operator">OF</span> reach_sub_tj''''<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="free">rho</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">rho'</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_at_def nth_append rho'_def<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho'</span> <span class="skolem">l</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> <span class="skolem">t'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> loop lassms<span class="main">(</span>2<span class="main">)</span> j''_j adv_last_bounds<span class="main">(</span>1<span class="main">)</span> i''_def i'_le_j length_rho
      <span class="keyword1"><span class="command">unfolding</span></span> adv_last_bounds matchP_loop_inv_def rho'_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> adv_last_bounds ts_at_def bs_at_def nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="skolem">rho'</span> <span class="main">(</span>w_i <span class="skolem">w''</span><span class="main">,</span> w_ti <span class="skolem">w''</span><span class="main">,</span> w_si <span class="skolem">w''</span><span class="main">,</span> w_j <span class="skolem">w''</span><span class="main">,</span> w_tj <span class="skolem">w''</span><span class="main">,</span> w_sj <span class="skolem">w''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_window_app<span class="main">[</span><span class="operator">OF</span> valid_after<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
        before_end<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> tj_def<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main">]</span></span> sj_def<span class="main"><span class="main">[</span></span><span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> adv_last_bounds i'_def ti'_def si'_def rho'_def valid_before adv_loop_bounds
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">w''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_adv_end<span class="main">[</span><span class="operator">OF</span> valid_w' before_end<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> tj_def sj_def adv_loop_bounds<span class="main"><span class="main">]</span></span> rho_mono<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> adv_end_last<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_matchP <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="skolem">rho'</span> <span class="main">(</span>Suc <span class="free">j</span><span class="main">)</span> <span class="main">(</span>adv_end <span class="free">args</span> <span class="main">(</span><span class="skolem">w'</span><span class="main">⦇</span>w_ac <span class="main">:=</span> <span class="skolem">ac''</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> valid_window_matchP_def adv_end_last<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> adv_loop_bounds adv_last_bounds length_rho valid_after<span class="main">(</span>6<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def i'_def i''_def tj''_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_mP <span class="free">I</span> <span class="free">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> sat <span class="free">j</span> <span class="main">(</span>MatchP <span class="free">I</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> read_t_def read_sub_def Let_def loop_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        ac'_def<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ac_def e'_def<span class="main"><span class="main">]</span></span> ac''_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> adv_end_last trans<span class="main"><span class="main">[</span></span><span class="operator">OF</span> β'_def<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> b_alt<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> adv_end_last rho'_def tj_def'
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_eval_matchF_Some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_before'<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_matchF <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">i</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_mF <span class="free">I</span> <span class="free">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">,</span> <span class="free">w''</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_ts <span class="main">(</span>right <span class="free">I</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">rho'</span> <span class="bound">t</span> <span class="bound">tm</span><span class="main">.</span> reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="main">(</span>w_tj <span class="free">w</span><span class="main">)</span> <span class="main">(</span>map fst <span class="bound">rho'</span><span class="main">)</span> <span class="main">(</span>w_tj <span class="free">w''</span><span class="main">)</span> <span class="main">∧</span>
    reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="main">(</span>w_sj <span class="free">w</span><span class="main">)</span> <span class="main">(</span>map snd <span class="bound">rho'</span><span class="main">)</span> <span class="main">(</span>w_sj <span class="free">w''</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span>w_read_t <span class="free">args</span><span class="main">)</span> <span class="main">(</span>w_ti <span class="free">w</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">t</span> <span class="main">∧</span>
    <span class="main">(</span>w_read_t <span class="free">args</span><span class="main">)</span> <span class="main">(</span>w_tj <span class="free">w''</span><span class="main">)</span> <span class="main">=</span> Some <span class="bound">tm</span> <span class="main">∧</span>
    <span class="main">¬</span><span class="bound">tm</span> <span class="main">≤</span> <span class="bound">t</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> w_st <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ti</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ti</span> <span class="main">=</span> w_ti <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">si</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">si</span> <span class="main">=</span> w_si <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> w_j <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj</span> <span class="main">=</span> w_tj <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sj</span> <span class="main">=</span> w_sj <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> w_s <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> w_e <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="skolem">ti</span><span class="main">,</span> <span class="skolem">si</span><span class="main">,</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">tj</span><span class="main">,</span> <span class="skolem">sj</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">rho</span> <span class="main">⟹</span> ts_at <span class="free">rho</span> <span class="bound">i</span> <span class="main">≤</span> ts_at <span class="free">rho</span> <span class="bound">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> mmap_lookup <span class="skolem">e</span> <span class="bound">q</span> <span class="main">=</span> sup_leadsto init step <span class="free">rho</span> <span class="free">i</span> <span class="skolem">j</span> <span class="bound">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"valid_s init step <span class="skolem">st</span> accept <span class="free">rho</span> <span class="free">i</span> <span class="free">i</span> <span class="skolem">j</span> <span class="skolem">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> w_i <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">rho</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before'<span class="main">[</span><span class="operator">unfolded</span> valid_window_matchF_def<span class="main">]</span> ti_def
      si_def j_def tj_def sj_def s_def e_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_def Let_def init_def step_def st_def accept_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ti'''</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="keyword2"><span class="keyword">where</span></span> tbi_def<span class="main">:</span> <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="skolem">ti</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ti'''</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval read_t_run read_sub_run
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def ti_def si_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> t_tau<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> run_t_sound<span class="main">[</span><span class="operator">OF</span> _ tbi_def<span class="main">]</span> valid_before<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>full_types<span class="main"><span class="main">)</span></span> min_less_iff_conj nat_less_le nat_neq_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> t_def <span class="main">=</span> run_t_read<span class="main">[</span><span class="operator">OF</span> tbi_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> loop_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">=</span> while <span class="main">(</span>matchF_cond <span class="free">I</span> <span class="skolem">t</span><span class="main">)</span> <span class="main">(</span>adv_end <span class="free">args</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> adv_start_last<span class="main">:</span>
    <span class="quoted"><span class="quoted">"adv_start <span class="free">args</span> <span class="skolem">w'</span> <span class="main">=</span> <span class="free">w''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval loop_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> run_t_read<span class="main">[</span><span class="operator">OF</span> tbi_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ti_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> inv_before<span class="main">:</span> <span class="quoted"><span class="quoted">"matchF_inv' <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">i</span> <span class="skolem">ti</span> <span class="skolem">si</span> <span class="skolem">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before<span class="main">(</span>1<span class="main">)</span> valid_before'
    <span class="keyword1"><span class="command">unfolding</span></span> matchF_loop_inv'_def valid_before<span class="main">(</span>6<span class="main">)</span> valid_window_matchF_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ti_def si_def j_def tj_def sj_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> reach_window.simps
        <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> reach_window_shift_all <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> i_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">rho</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j''</span> <span class="main">=</span> w_j <span class="free">w''</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tj''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj''</span> <span class="main">=</span> w_tj <span class="free">w''</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sj''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sj''</span> <span class="main">=</span> w_sj <span class="free">w''</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> loop<span class="main">:</span> <span class="quoted"><span class="quoted">"matchF_inv' <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">i</span> <span class="skolem">ti</span> <span class="skolem">si</span> <span class="skolem">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="skolem">w'</span> <span class="main">∧</span> <span class="main">¬</span> matchF_cond <span class="free">I</span> <span class="skolem">t</span> <span class="skolem">w'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> loop_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> while_rule_lemma<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"matchF_inv' <span class="free"><span class="free">t0</span></span> <span class="free"><span class="free">sub</span></span> <span class="free"><span class="free">rho</span></span> <span class="free"><span class="free">i</span></span> <span class="skolem"><span class="skolem">ti</span></span> <span class="skolem"><span class="skolem">si</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">tj</span></span> <span class="skolem"><span class="skolem">sj</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w_cur</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool iarray<span class="main">,</span> nat set<span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> window"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"matchF_inv' <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">i</span> <span class="skolem">ti</span> <span class="skolem">si</span> <span class="skolem">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="skolem">w_cur</span>"</span></span> <span class="quoted"><span class="quoted">"matchF_cond <span class="free">I</span> <span class="skolem">t</span> <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j_cur</span> <span class="main">=</span> w_j <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tj_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj_cur</span> <span class="main">=</span> w_tj <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sj_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sj_cur</span> <span class="main">=</span> w_sj <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rho'</span></span> <span class="keyword2"><span class="keyword">where</span></span> rho'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="skolem">rho'</span><span class="main">)</span> <span class="skolem">w_cur</span>"</span></span>
      <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="skolem">rho'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">tj</span><span class="main">,</span> <span class="skolem">sj</span><span class="main">,</span> w_j <span class="skolem">w_cur</span><span class="main">,</span> w_tj <span class="skolem">w_cur</span><span class="main">,</span> w_sj <span class="skolem">w_cur</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> matchF_loop_inv'_def valid_window_matchF_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tj'</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">sj'</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> append<span class="main">:</span> <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="skolem">tj_cur</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">tj'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span> <span class="skolem">sj_cur</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">sj'</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">[</span><span class="operator">unfolded</span> matchF_loop_cond_def<span class="main">]</span> read_t_run read_sub_run
      <span class="keyword1"><span class="command">unfolding</span></span> tj_cur_def sj_cur_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">note</span></span> append' <span class="main">=</span> append<span class="main">[</span><span class="operator">unfolded</span> tj_cur_def sj_cur_def<span class="main">]</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rho''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rho''</span> <span class="main">=</span> <span class="free">rho</span> <span class="main">@</span> <span class="skolem">rho'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">rho''</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> undefined<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tj'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reach_sub_app<span class="main">[</span><span class="operator">OF</span> reach_window_run_tj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rho'_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> append'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho''_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">rho''</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ts_at_mono<span class="main">[</span><span class="operator">OF</span> reach<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"length <span class="skolem">rho''</span>"</span></span><span class="main">]</span> nat_less_le
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_at_def nth_append in_set_conv_nth <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"matchF_inv' <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">i</span> <span class="skolem">ti</span> <span class="skolem">si</span> <span class="skolem">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="main">(</span>adv_end <span class="free">args</span> <span class="skolem">w_cur</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> reach_window_app<span class="main">[</span><span class="operator">OF</span> rho'_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> append<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> tj_cur_def sj_cur_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
        valid_adv_end<span class="main">[</span><span class="operator">OF</span> rho'_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> append' mono<span class="main">]</span> adv_end_bounds<span class="main">[</span><span class="operator">OF</span> append'<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> matchF_loop_inv'_def matchF_loop_cond_def rho''_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>τ <span class="free">σ</span> <span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> t_tau
      <span class="keyword1"><span class="command">using</span></span> ex_lt_τ<span class="main">[</span><span class="operator">OF</span> bounded<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w1</span> <span class="skolem">w2</span>
      <span class="keyword3"><span class="command">assume</span></span> lassms<span class="main">:</span> <span class="quoted"><span class="quoted">"matchF_inv' <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">i</span> <span class="skolem">ti</span> <span class="skolem">si</span> <span class="skolem">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="skolem">w1</span>"</span></span> <span class="quoted"><span class="quoted">"matchF_cond <span class="free">I</span> <span class="skolem">t</span> <span class="skolem">w1</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">=</span> adv_end <span class="free">args</span> <span class="skolem">w1</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j_cur</span> <span class="main">=</span> w_j <span class="skolem">w1</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tj_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj_cur</span> <span class="main">=</span> w_tj <span class="skolem">w1</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sj_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sj_cur</span> <span class="main">=</span> w_sj <span class="skolem">w1</span>"</span></span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rho'</span></span> <span class="keyword2"><span class="keyword">where</span></span> rho'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="skolem">rho'</span><span class="main">)</span> <span class="skolem">w1</span>"</span></span>
        <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="skolem">rho'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">tj</span><span class="main">,</span> <span class="skolem">sj</span><span class="main">,</span> w_j <span class="skolem">w1</span><span class="main">,</span> w_tj <span class="skolem">w1</span><span class="main">,</span> w_sj <span class="skolem">w1</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> matchF_loop_inv'_def valid_window_matchF_def<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tj'</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">sj'</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> append<span class="main">:</span> <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="skolem">tj_cur</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">tj'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span> <span class="skolem">sj_cur</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">sj'</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">[</span><span class="operator">unfolded</span> matchF_loop_cond_def<span class="main">]</span> read_t_run read_sub_run
        <span class="keyword1"><span class="command">unfolding</span></span> tj_cur_def sj_cur_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">note</span></span> append' <span class="main">=</span> append<span class="main">[</span><span class="operator">unfolded</span> tj_cur_def sj_cur_def<span class="main">]</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rho''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rho''</span> <span class="main">=</span> <span class="free">rho</span> <span class="main">@</span> <span class="skolem">rho'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> reach<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">rho''</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> undefined<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tj'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> reach_sub_app<span class="main">[</span><span class="operator">OF</span> reach_window_run_tj<span class="main"><span class="main">[</span></span><span class="operator">OF</span> rho'_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span> append'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho''_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="skolem">rho''</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ts_at_mono<span class="main">[</span><span class="operator">OF</span> reach<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="quoted">"length <span class="skolem">rho''</span>"</span></span><span class="main">]</span> nat_less_le
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_at_def nth_append in_set_conv_nth <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> t_cur_tau<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="skolem">j_cur</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ts_at_tau<span class="main">[</span><span class="operator">OF</span> reach<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"length <span class="skolem">rho''</span>"</span></span><span class="main">]</span> rho'_def<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_at_def j_cur_def rho''_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j_cur</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lassms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> matchF_loop_cond_def<span class="main">]</span>
          l_def τ_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">j_cur</span></span> <span class="quoted"><span class="free">σ</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> run_t_read<span class="main">[</span><span class="operator">OF</span> append<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> t_cur_tau tj_cur_def<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> leI option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> order.trans<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"w_j <span class="skolem">w2</span> <span class="main">=</span> Suc <span class="skolem">j_cur</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> adv_end_bounds<span class="main">[</span><span class="operator">OF</span> append'<span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> lassms<span class="main">(</span>3<span class="main">)</span> j_cur_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">-</span> w_j <span class="skolem">w2</span> <span class="main">&lt;</span> <span class="skolem">l</span> <span class="main">-</span> w_j <span class="skolem">w1</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> j_cur_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">ta</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> matchF_inv' <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">i</span> <span class="skolem">ti</span> <span class="skolem">si</span> <span class="skolem">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="bound">s</span> <span class="main">∧</span> matchF_cond <span class="free">I</span> <span class="skolem">t</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="bound">ta</span> <span class="main">=</span> adv_end <span class="free">args</span> <span class="bound">s</span><span class="main">}</span> <span class="main">⊆</span> measure <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> <span class="skolem">l</span> <span class="main">-</span> w_j <span class="bound">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">ta</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> matchF_inv' <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">i</span> <span class="skolem">ti</span> <span class="skolem">si</span> <span class="skolem">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="bound">s</span> <span class="main">∧</span> matchF_cond <span class="free">I</span> <span class="skolem">t</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="bound">ta</span> <span class="main">=</span> adv_end <span class="free">args</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_measure wf_subset
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_before<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> w_i <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ti'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ti'</span> <span class="main">=</span> w_ti <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">si'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">si'</span> <span class="main">=</span> w_si <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">=</span> w_j <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tj'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj'</span> <span class="main">=</span> w_tj <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sj'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sj'</span> <span class="main">=</span> w_sj <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rho'</span></span> <span class="keyword2"><span class="keyword">where</span></span> rho'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="skolem">rho'</span><span class="main">)</span> <span class="skolem">w'</span>"</span></span>
    <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="skolem">rho'</span><span class="main">)</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">tj</span><span class="main">,</span> <span class="skolem">sj</span><span class="main">,</span> <span class="skolem">j'</span><span class="main">,</span> <span class="skolem">tj'</span><span class="main">,</span> <span class="skolem">sj'</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">≤</span> <span class="skolem">j'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> loop
    <span class="keyword1"><span class="command">unfolding</span></span> matchF_loop_inv'_def i'_def j'_def tj'_def sj'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tje</span></span> <span class="skolem"><span class="skolem">tm</span></span> <span class="keyword2"><span class="keyword">where</span></span> tm_def<span class="main">:</span> <span class="quoted"><span class="quoted">"w_read_t <span class="free">args</span> <span class="skolem">tj'</span> <span class="main">=</span> Some <span class="skolem">tm</span>"</span></span> <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="skolem">tj'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">tje</span><span class="main">,</span> <span class="skolem">tm</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval read_t_run loop_def t_def ti_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> t_def Let_def tj'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> drop_j_rho<span class="main">:</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">j</span> <span class="main">(</span>map fst <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="skolem">rho'</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> map fst <span class="skolem">rho'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i_j
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="skolem">ti</span> <span class="main">(</span>drop <span class="free">i</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tj</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="skolem">ti</span>
    <span class="main">(</span>drop <span class="free">i</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span> <span class="main">@</span> <span class="main">(</span>drop <span class="skolem">j</span> <span class="main">(</span>map fst <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="skolem">rho'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tj'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rho'_def reach_sub_trans
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="skolem">ti</span> <span class="main">(</span>drop <span class="free">i</span> <span class="main">(</span>map fst <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="skolem">rho'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tj'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> drop_j_rho
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> i_j<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> reach_tm<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="skolem">ti</span> <span class="main">(</span>drop <span class="free">i</span> <span class="main">(</span>map fst <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="skolem">rho'</span><span class="main">)</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="skolem">tm</span><span class="main">]</span><span class="main">)</span> <span class="skolem">tje</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_sub_app tm_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> run_tsi'<span class="main">:</span> <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="skolem">ti'</span> <span class="main">≠</span> None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tbi_def loop
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> matchF_loop_inv'_def ti'_def si'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> not_ets_tm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span> <span class="skolem">tm</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> eval run_tsi' loop_def t_def tm_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ti_def ti'_def si'_def tj'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> i_le_rho<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="free">rho</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rho''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rho''</span> <span class="main">=</span> <span class="free">rho</span> <span class="main">@</span> <span class="skolem">rho'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> i'_lt_j'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">j'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> rho'_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> rho''_def<span class="main">]</span> i_j reach_tm<span class="main">[</span><span class="operator">folded</span> rho''_def<span class="main">]</span> not_ets_tm tbi_def
      right_I_add_mono
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="skolem">j'</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reach_sub_NilD <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reach_sub.cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="skolem">tm</span><span class="main">]</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> adv_last_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j''</span> <span class="main">=</span> <span class="skolem">j'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj''</span> <span class="main">=</span> <span class="skolem">tj'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sj''</span> <span class="main">=</span> <span class="skolem">sj'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_adv_start_bounds<span class="main">[</span><span class="operator">OF</span> rho'_def<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span> i'_lt_j'<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">unfolded</span></span></span></span> i'_def j'_def<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> adv_start_last j'_def j''_def tj'_def tj''_def sj'_def sj''_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> eval rho'_def run_tsi' i_j<span class="main">(</span>2<span class="main">)</span> not_ets_tm adv_last_bounds tj''_def tj_def sj''_def sj_def
      loop_def t_def ti_def tj'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tm_def drop_map run_t_read<span class="main"><span class="main">[</span></span><span class="operator">OF</span> tbi_def<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main">]</span></span> Let_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits if_splits <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">rho'</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_eval_matchF_complete<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_before'<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_matchF <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">i</span> <span class="free">w</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> before_end<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="main">(</span>w_tj <span class="free">w</span><span class="main">)</span> <span class="main">(</span>map fst <span class="free">rho'</span><span class="main">)</span> <span class="free">tj'''</span>"</span></span>
    <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="main">(</span>w_sj <span class="free">w</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">rho'</span><span class="main">)</span> <span class="free">sj'''</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_read_t <span class="free">args</span> <span class="main">(</span>w_ti <span class="free">w</span><span class="main">)</span> <span class="main">=</span> Some <span class="free">t</span>"</span></span> <span class="quoted"><span class="quoted">"w_read_t <span class="free">args</span> <span class="free">tj'''</span> <span class="main">=</span> Some <span class="free">tm</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">tm</span> <span class="main">≤</span> <span class="free">t</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">w'</span><span class="main">.</span> eval_mF <span class="free">I</span> <span class="free">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span><span class="main">,</span> sat <span class="free">i</span> <span class="main">(</span>MatchF <span class="free">I</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="bound">w'</span><span class="main">)</span> <span class="main">∧</span>
    valid_matchF <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span>take <span class="main">(</span>w_j <span class="bound">w'</span><span class="main">)</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="free">rho'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="bound">w'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> w_st <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ti</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ti</span> <span class="main">=</span> w_ti <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">si</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">si</span> <span class="main">=</span> w_si <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> w_j <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj</span> <span class="main">=</span> w_tj <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sj</span> <span class="main">=</span> w_sj <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> w_s <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> w_e <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="skolem">ti</span><span class="main">,</span> <span class="skolem">si</span><span class="main">,</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">tj</span><span class="main">,</span> <span class="skolem">sj</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">rho</span> <span class="main">⟹</span> ts_at <span class="free">rho</span> <span class="bound">i</span> <span class="main">≤</span> ts_at <span class="free">rho</span> <span class="bound">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> mmap_lookup <span class="skolem">e</span> <span class="bound">q</span> <span class="main">=</span> sup_leadsto init step <span class="free">rho</span> <span class="free">i</span> <span class="skolem">j</span> <span class="bound">q</span>"</span></span>
    <span class="quoted"><span class="quoted">"valid_s init step <span class="skolem">st</span> accept <span class="free">rho</span> <span class="free">i</span> <span class="free">i</span> <span class="skolem">j</span> <span class="skolem">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> w_i <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="free">rho</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before'<span class="main">[</span><span class="operator">unfolded</span> valid_window_matchF_def<span class="main">]</span> ti_def
      si_def j_def tj_def sj_def s_def e_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_def Let_def init_def step_def st_def accept_def<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rho''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rho''</span> <span class="main">=</span> <span class="free">rho</span> <span class="main">@</span> <span class="free">rho'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ij_le<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> length <span class="free">rho</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> reach_tj<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>take <span class="skolem">j</span> <span class="main">(</span>map fst <span class="skolem">rho''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tj</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before<span class="main">(</span>1<span class="main">)</span> ij_le
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_map rho''_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> reach_window.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reach_window_run_tj<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> reach_ti<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span>map fst <span class="skolem">rho''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ti</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before<span class="main">(</span>1<span class="main">)</span> ij_le
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_map rho''_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> reach_si<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span>map snd <span class="skolem">rho''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">si</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before<span class="main">(</span>1<span class="main">)</span> ij_le
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_map rho''_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> reach_sj<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>take <span class="skolem">j</span> <span class="main">(</span>map snd <span class="skolem">rho''</span><span class="main">)</span><span class="main">)</span> <span class="skolem">sj</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before<span class="main">(</span>1<span class="main">)</span> ij_le
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> take_map rho''_def <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> reach_window.simps <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reach_window_run_sj<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> reach_tj'''<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>map fst <span class="skolem">rho''</span><span class="main">)</span> <span class="free">tj'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_sub_trans<span class="main">[</span><span class="operator">OF</span> reach_tj before_end<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> tj_def<span class="main"><span class="main">]</span></span><span class="main">]</span> ij_le<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_append <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho''_def take_map drop_map map_append<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> rho''_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="skolem">rho''</span> <span class="main">⟹</span> ts_at <span class="skolem">rho''</span> <span class="bound">i</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ts_at_mono<span class="main">[</span><span class="operator">OF</span> reach_tj'''<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tm'</span></span> <span class="keyword2"><span class="keyword">where</span></span> reach_tm<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span>
    <span class="main">(</span>map fst <span class="main">(</span><span class="skolem">rho''</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">tm</span><span class="main">,</span> undefined<span class="main">)</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tm'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_sub_app<span class="main">[</span><span class="operator">OF</span> reach_tj'''<span class="main">]</span> read_t_run<span class="main">[</span><span class="operator">OF</span> before_end<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> tj'''_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">tj_cur</span><span class="main">.</span> reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>map fst <span class="skolem">rho''</span><span class="main">)</span> <span class="bound">tj_cur</span> <span class="main">⟹</span>
    <span class="bound">tj_cur</span> <span class="main">=</span> <span class="free">tj'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_sub_inj<span class="main">[</span><span class="operator">OF</span> reach_tj'''<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> reach_sj'''<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>map snd <span class="skolem">rho''</span><span class="main">)</span> <span class="free">sj'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_sub_trans<span class="main">[</span><span class="operator">OF</span> reach_sj before_end<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">folded</span> sj_def<span class="main"><span class="main">]</span></span><span class="main">]</span> ij_le<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">del</span><span class="main"><span class="main">:</span></span> map_append <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho''_def take_map drop_map map_append<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> sj'''_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">sj_cur</span><span class="main">.</span> reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>map snd <span class="skolem">rho''</span><span class="main">)</span> <span class="bound">sj_cur</span> <span class="main">⟹</span>
    <span class="bound">sj_cur</span> <span class="main">=</span> <span class="free">sj'''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_sub_inj<span class="main">[</span><span class="operator">OF</span> reach_sj'''<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> reach_window_i<span class="main">:</span> <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="skolem">rho''</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="skolem">ti</span><span class="main">,</span> <span class="skolem">si</span><span class="main">,</span> length <span class="skolem">rho''</span><span class="main">,</span> <span class="free">tj'''</span><span class="main">,</span> <span class="free">sj'''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_windowI<span class="main">[</span><span class="operator">OF</span> reach_ti reach_si reach_tj''' reach_sj''' _ refl<span class="main">]</span> ij_le
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho''_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> reach_window_j<span class="main">:</span> <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="skolem">rho''</span> <span class="main">(</span><span class="skolem">j</span><span class="main">,</span> <span class="skolem">tj</span><span class="main">,</span> <span class="skolem">sj</span><span class="main">,</span> length <span class="skolem">rho''</span><span class="main">,</span> <span class="free">tj'''</span><span class="main">,</span> <span class="free">sj'''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_windowI<span class="main">[</span><span class="operator">OF</span> reach_tj reach_sj reach_tj''' reach_sj''' _ refl<span class="main">]</span> ij_le
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho''_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> i_lt_rho''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> length <span class="skolem">rho''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> ij_le before_end<span class="main">(</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span> reach_window_i
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> length <span class="skolem">rho''</span>"</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho''_def ti_def right_I_add_mono <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reach_sub_NilD<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ti'''</span></span> <span class="skolem"><span class="skolem">si'''</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> tbi_def<span class="main">:</span> <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="skolem">ti</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ti'''</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span> <span class="skolem">si</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">si'''</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> ts_at <span class="skolem">rho''</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> bs_at <span class="skolem">rho''</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_window_run_ti<span class="main">[</span><span class="operator">OF</span> reach_window_i i_lt_rho''<span class="main">]</span>
      reach_window_run_si<span class="main">[</span><span class="operator">OF</span> reach_window_i i_lt_rho''<span class="main">]</span>
      read_t_run<span class="main">[</span><span class="operator">OF</span> before_end<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">folded</span> ti_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> t_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> tbi_def<span class="main">(</span>3<span class="main">)</span> ts_at_tau<span class="main">[</span><span class="operator">OF</span> reach_tj''' i_lt_rho''<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">note</span></span> before_end' <span class="main">=</span> before_end<span class="main">(</span>5<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> read_ti<span class="main">:</span> <span class="quoted"><span class="quoted">"w_read_t <span class="free">args</span> <span class="skolem">ti</span> <span class="main">=</span> Some <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> run_t_read<span class="main">[</span><span class="operator">OF</span> tbi_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> read_si<span class="main">:</span> <span class="quoted"><span class="quoted">"w_read_sub <span class="free">args</span> <span class="skolem">si</span> <span class="main">=</span> Some <span class="skolem">b</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> run_sub_read<span class="main">[</span><span class="operator">OF</span> tbi_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w'</span></span> <span class="keyword2"><span class="keyword">where</span></span> loop_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w'</span> <span class="main">=</span> while <span class="main">(</span>matchF_cond <span class="free">I</span> <span class="free">t</span><span class="main">)</span> <span class="main">(</span>adv_end <span class="free">args</span><span class="main">)</span> <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">w''</span></span> <span class="keyword2"><span class="keyword">where</span></span> adv_start_last<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">w''</span> <span class="main">=</span> adv_start <span class="free">args</span> <span class="skolem">w'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> inv_before<span class="main">:</span> <span class="quoted"><span class="quoted">"matchF_inv <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="skolem">rho''</span> <span class="free">i</span> <span class="skolem">ti</span> <span class="skolem">si</span> <span class="free">tj'''</span> <span class="free">sj'''</span> <span class="free">w</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before' before_end<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>3<span class="main">)</span> reach_window_j ij_le ti_def si_def j_def tj_def sj_def
    <span class="keyword1"><span class="command">unfolding</span></span> matchF_loop_inv_def valid_window_matchF_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho''_def ts_at_def nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> i_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> loop<span class="main">:</span> <span class="quoted"><span class="quoted">"matchF_inv <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="skolem">rho''</span> <span class="free">i</span> <span class="skolem">ti</span> <span class="skolem">si</span> <span class="free">tj'''</span> <span class="free">sj'''</span> <span class="skolem">w'</span> <span class="main">∧</span> <span class="main">¬</span> matchF_cond <span class="free">I</span> <span class="free">t</span> <span class="skolem">w'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> loop_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> while_rule_lemma<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"matchF_inv <span class="free"><span class="free">I</span></span> <span class="free"><span class="free">t0</span></span> <span class="free"><span class="free">sub</span></span> <span class="skolem"><span class="skolem">rho''</span></span> <span class="free"><span class="free">i</span></span> <span class="skolem"><span class="skolem">ti</span></span> <span class="skolem"><span class="skolem">si</span></span> <span class="free"><span class="free">tj'''</span></span> <span class="free"><span class="free">sj'''</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w_cur</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span>bool iarray<span class="main">,</span> nat set<span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> window"</span></span>
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"matchF_inv <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="skolem">rho''</span> <span class="free">i</span> <span class="skolem">ti</span> <span class="skolem">si</span> <span class="free">tj'''</span> <span class="free">sj'''</span> <span class="skolem">w_cur</span>"</span></span> <span class="quoted"><span class="quoted">"matchF_cond <span class="free">I</span> <span class="free">t</span> <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j_cur</span> <span class="main">=</span> w_j <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tj_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj_cur</span> <span class="main">=</span> w_tj <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sj_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sj_cur</span> <span class="main">=</span> w_sj <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s_cur</span> <span class="main">=</span> w_s <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e_cur</span> <span class="main">=</span> w_e <span class="skolem">w_cur</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> loop<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span>take <span class="main">(</span>w_j <span class="skolem">w_cur</span><span class="main">)</span> <span class="skolem">rho''</span><span class="main">)</span> <span class="skolem">w_cur</span>"</span></span>
      <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="skolem">rho''</span> <span class="main">(</span><span class="skolem">j_cur</span><span class="main">,</span> <span class="skolem">tj_cur</span><span class="main">,</span> <span class="skolem">sj_cur</span><span class="main">,</span> length <span class="skolem">rho''</span><span class="main">,</span> <span class="free">tj'''</span><span class="main">,</span> <span class="free">sj'''</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span><span class="main">∈</span><span class="main">{</span>w_i <span class="skolem">w_cur</span><span class="main">..&lt;</span>w_j <span class="skolem">w_cur</span><span class="main">}</span> <span class="main">⟹</span> ts_at <span class="skolem">rho''</span> <span class="bound">l</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="free">i</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_cur_def tj_cur_def sj_cur_def s_cur_def e_cur_def
        assms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> matchF_loop_inv_def<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> j_cur_lt_rho''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j_cur</span> <span class="main">&lt;</span> length <span class="skolem">rho''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms tj'''_eq ij_le before_end<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> right_I_add_mono
      <span class="keyword1"><span class="command">unfolding</span></span> matchF_loop_inv_def matchF_loop_cond_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j_cur</span> <span class="main">=</span> length <span class="skolem">rho''</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> j_cur_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tj_cur'</span></span> <span class="skolem"><span class="skolem">sj_cur'</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">b_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> tbi_cur_def<span class="main">:</span> <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="skolem">tj_cur</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">tj_cur'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span> <span class="skolem">sj_cur</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">sj_cur'</span><span class="main">,</span> <span class="skolem">b_cur</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> ts_at <span class="skolem">rho''</span> <span class="skolem">j_cur</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b_cur</span> <span class="main">=</span> bs_at <span class="skolem">rho''</span> <span class="skolem">j_cur</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reach_window_run_ti<span class="main">[</span><span class="operator">OF</span> loop<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> j_cur_lt_rho''<span class="main">]</span>
        reach_window_run_si<span class="main">[</span><span class="operator">OF</span> loop<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> j_cur_lt_rho''<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> reach_window_j'_cur <span class="main">=</span> reach_window_shift<span class="main">[</span><span class="operator">OF</span> loop<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> j_cur_lt_rho'' tbi_cur_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">note</span></span> tbi_cur_def' <span class="main">=</span> tbi_cur_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> tj_cur_def sj_cur_def<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="main">(</span>take <span class="main">(</span>w_j <span class="skolem">w_cur</span><span class="main">)</span> <span class="skolem">rho''</span><span class="main">)</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="skolem">x</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> rho''_mono<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="skolem">j_cur</span></span><span class="main">]</span> j_cur_lt_rho'' nat_less_le
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tbi_cur_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> j_cur_def ts_at_def nth_append in_set_conv_nth
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> take_unfold<span class="main">:</span> <span class="quoted"><span class="quoted">"take <span class="main">(</span>w_j <span class="skolem">w_cur</span><span class="main">)</span> <span class="skolem">rho''</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">b_cur</span><span class="main">)</span><span class="main">]</span> <span class="main">=</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="main">(</span>w_j <span class="skolem">w_cur</span><span class="main">)</span><span class="main">)</span> <span class="skolem">rho''</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j_cur_lt_rho''
      <span class="keyword1"><span class="command">unfolding</span></span> tbi_cur_def<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_at_def bs_at_def j_cur_def take_Suc_conv_app_nth<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span><span class="main">{</span>w_i <span class="main">(</span>adv_end <span class="free">args</span> <span class="skolem">w_cur</span><span class="main">)</span><span class="main">..&lt;</span>w_j <span class="main">(</span>adv_end <span class="free">args</span> <span class="skolem">w_cur</span><span class="main">)</span><span class="main">}</span> <span class="main">⟹</span>
      ts_at <span class="skolem">rho''</span> <span class="bound">l</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="free">i</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> loop<span class="main">(</span>3<span class="main">)</span> assms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> adv_end_bounds<span class="main">[</span><span class="operator">OF</span> tbi_cur_def'<span class="main">]</span> matchF_loop_cond_def
        run_t_read<span class="main">[</span><span class="operator">OF</span> tbi_cur_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> tj_cur_def<span class="main"><span class="main">]</span></span><span class="main">]</span> tbi_cur_def<span class="main">(</span>3<span class="main">)</span> tbi_def<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> j_cur_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"matchF_inv <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="skolem">rho''</span> <span class="free">i</span> <span class="skolem">ti</span> <span class="skolem">si</span> <span class="free">tj'''</span> <span class="free">sj'''</span> <span class="main">(</span>adv_end <span class="free">args</span> <span class="skolem">w_cur</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> reach_window_j'_cur
        valid_adv_end<span class="main">[</span><span class="operator">OF</span> loop<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tbi_cur_def' mono<span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> matchF_loop_inv_def ti_def si_def j_cur_def valid_window_matchF_def take_unfold
        adv_end_bounds<span class="main">[</span><span class="operator">OF</span> tbi_cur_def'<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">{</span></span>
      <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w1</span> <span class="skolem">w2</span>
      <span class="keyword3"><span class="command">assume</span></span> lassms<span class="main">:</span> <span class="quoted"><span class="quoted">"matchF_inv <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="skolem">rho''</span> <span class="free">i</span> <span class="skolem">ti</span> <span class="skolem">si</span> <span class="free">tj'''</span> <span class="free">sj'''</span> <span class="skolem">w1</span>"</span></span> <span class="quoted"><span class="quoted">"matchF_cond <span class="free">I</span> <span class="free">t</span> <span class="skolem">w1</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">w2</span> <span class="main">=</span> adv_end <span class="free">args</span> <span class="skolem">w1</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j_cur</span> <span class="main">=</span> w_j <span class="skolem">w1</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tj_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj_cur</span> <span class="main">=</span> w_tj <span class="skolem">w1</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sj_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sj_cur</span> <span class="main">=</span> w_sj <span class="skolem">w1</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s_cur</span> <span class="main">=</span> w_s <span class="skolem">w1</span>"</span></span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e_cur</span> <span class="main">=</span> w_e <span class="skolem">w1</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> loop<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span>take <span class="main">(</span>w_j <span class="skolem">w1</span><span class="main">)</span> <span class="skolem">rho''</span><span class="main">)</span> <span class="skolem">w1</span>"</span></span>
        <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="skolem">rho''</span> <span class="main">(</span><span class="skolem">j_cur</span><span class="main">,</span> <span class="skolem">tj_cur</span><span class="main">,</span> <span class="skolem">sj_cur</span><span class="main">,</span> length <span class="skolem">rho''</span><span class="main">,</span> <span class="free">tj'''</span><span class="main">,</span> <span class="free">sj'''</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span><span class="main">∈</span><span class="main">{</span>w_i <span class="skolem">w1</span><span class="main">..&lt;</span>w_j <span class="skolem">w1</span><span class="main">}</span> <span class="main">⟹</span> ts_at <span class="skolem">rho''</span> <span class="bound">l</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="free">i</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> j_cur_def tj_cur_def sj_cur_def s_cur_def e_cur_def
          lassms<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> matchF_loop_inv_def<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> j_cur_lt_rho''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j_cur</span> <span class="main">&lt;</span> length <span class="skolem">rho''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> lassms tj'''_eq ij_le before_end<span class="main">(</span>4<span class="main">,</span>5<span class="main">)</span> right_I_add_mono
        <span class="keyword1"><span class="command">unfolding</span></span> matchF_loop_inv_def matchF_loop_cond_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j_cur</span> <span class="main">=</span> length <span class="skolem">rho''</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> j_cur_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tj_cur'</span></span> <span class="skolem"><span class="skolem">sj_cur'</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">b_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> tbi_cur_def<span class="main">:</span> <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="skolem">tj_cur</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">tj_cur'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span> <span class="skolem">sj_cur</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">sj_cur'</span><span class="main">,</span> <span class="skolem">b_cur</span><span class="main">)</span>"</span></span>
        <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> ts_at <span class="skolem">rho''</span> <span class="skolem">j_cur</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b_cur</span> <span class="main">=</span> bs_at <span class="skolem">rho''</span> <span class="skolem">j_cur</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> reach_window_run_ti<span class="main">[</span><span class="operator">OF</span> loop<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> j_cur_lt_rho''<span class="main">]</span>
          reach_window_run_si<span class="main">[</span><span class="operator">OF</span> loop<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> j_cur_lt_rho''<span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">note</span></span> tbi_cur_def' <span class="main">=</span> tbi_cur_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> tj_cur_def sj_cur_def<span class="main">]</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">rho''</span> <span class="main">-</span> w_j <span class="skolem">w2</span> <span class="main">&lt;</span> length <span class="skolem">rho''</span> <span class="main">-</span> w_j <span class="skolem">w1</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> j_cur_lt_rho'' adv_end_bounds<span class="main">[</span><span class="operator">OF</span> tbi_cur_def'<span class="main">,</span> <span class="operator">folded</span> lassms<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span></span></span>3<span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span></span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> j_cur_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">}</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">ta</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> matchF_inv <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="skolem">rho''</span> <span class="free">i</span> <span class="skolem">ti</span> <span class="skolem">si</span> <span class="free">tj'''</span> <span class="free">sj'''</span> <span class="bound">s</span> <span class="main">∧</span> matchF_cond <span class="free">I</span> <span class="free">t</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="bound">ta</span> <span class="main">=</span> adv_end <span class="free">args</span> <span class="bound">s</span><span class="main">}</span> <span class="main">⊆</span> measure <span class="main">(</span><span class="main">λ</span><span class="bound">w</span><span class="main">.</span> length <span class="skolem">rho''</span> <span class="main">-</span> w_j <span class="bound">w</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">ta</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> matchF_inv <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="skolem">rho''</span> <span class="free">i</span> <span class="skolem">ti</span> <span class="skolem">si</span> <span class="free">tj'''</span> <span class="free">sj'''</span> <span class="bound">s</span> <span class="main">∧</span> matchF_cond <span class="free">I</span> <span class="free">t</span> <span class="bound">s</span> <span class="main">∧</span>
      <span class="bound">ta</span> <span class="main">=</span> adv_end <span class="free">args</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_measure wf_subset
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> inv_before<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st'</span> <span class="main">=</span> w_st <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> w_i <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ti'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ti'</span> <span class="main">=</span> w_ti <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">si'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">si'</span> <span class="main">=</span> w_si <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">=</span> w_j <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tj'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj'</span> <span class="main">=</span> w_tj <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sj'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sj'</span> <span class="main">=</span> w_sj <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> w_s <span class="skolem">w'</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">=</span> w_e <span class="skolem">w'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> valid_after<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span>take <span class="main">(</span>w_j <span class="skolem">w'</span><span class="main">)</span> <span class="skolem">rho''</span><span class="main">)</span> <span class="skolem">w'</span>"</span></span>
    <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="skolem">rho''</span> <span class="main">(</span><span class="skolem">j'</span><span class="main">,</span> <span class="skolem">tj'</span><span class="main">,</span> <span class="skolem">sj'</span><span class="main">,</span> length <span class="skolem">rho''</span><span class="main">,</span> <span class="free">tj'''</span><span class="main">,</span> <span class="free">sj'''</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span><span class="main">∈</span><span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">j'</span><span class="main">}</span> <span class="main">⟹</span> ts_at <span class="skolem">rho''</span> <span class="bound">l</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="free">i</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">=</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ti'</span> <span class="main">=</span> <span class="skolem">ti</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">si'</span> <span class="main">=</span> <span class="skolem">si</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> loop
    <span class="keyword1"><span class="command">unfolding</span></span> matchF_loop_inv_def i'_def ti'_def si'_def j'_def tj'_def sj'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i''</span> <span class="main">=</span> w_i <span class="skolem">w''</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j''</span> <span class="main">=</span> w_j <span class="skolem">w''</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tj''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj''</span> <span class="main">=</span> w_tj <span class="skolem">w''</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sj''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sj''</span> <span class="main">=</span> w_sj <span class="skolem">w''</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> j'_le_rho''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">≤</span> length <span class="skolem">rho''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> loop
    <span class="keyword1"><span class="command">unfolding</span></span> matchF_loop_inv_def valid_window_matchF_def j'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">te</span></span> <span class="keyword2"><span class="keyword">where</span></span> tbj'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"w_read_t <span class="free">args</span> <span class="skolem">tj'</span> <span class="main">=</span> Some <span class="skolem">te</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">te</span> <span class="main">=</span> ts_at <span class="main">(</span><span class="skolem">rho''</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">tm</span><span class="main">,</span> undefined<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">j'</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">premises</span></span> prems
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">&lt;</span> length <span class="skolem">rho''</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> reach_window_run_ti<span class="main">[</span><span class="operator">OF</span> valid_after<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> True<span class="main">]</span> prems True
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_at_def nth_append <span class="quasi_keyword">dest</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> run_t_read<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj'</span> <span class="main">=</span> <span class="free">tj'''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">=</span> length <span class="skolem">rho''</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid_after<span class="main">(</span>2<span class="main">)</span> j'_le_rho'' tj'''_eq
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> prems before_end<span class="main">(</span>4<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_at_def nth_append<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> not_ets_te<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">te</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="free">i</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="main">¬</span><span class="skolem">te</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="free">i</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">te</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="free">i</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> run_sj'<span class="main">:</span> <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span> <span class="skolem">sj'</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> loop run_sub_read<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">sj'</span></span><span class="main">]</span> tbj'_def<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> matchF_loop_cond_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span> <span class="skolem">sj'</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span>  tbi_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> tj'_def sj'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">=</span> length <span class="skolem">rho''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sj'''_eq reach_window_run_si<span class="main">[</span><span class="operator">OF</span> valid_after<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> j'_le_rho''
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">j'</span> <span class="main">=</span> length <span class="skolem">rho''</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tbj'_def<span class="main">(</span>2<span class="main">)</span> before_end<span class="main">(</span>5<span class="main">)</span> contr i_lt_rho'' tbi_def<span class="main">(</span>3<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho''_def ts_at_def nth_append <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> i'_set<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">j'</span><span class="main">}</span> <span class="main">⟹</span> ts_at <span class="skolem">rho''</span> <span class="bound">l</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="free">i</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span>ts_at <span class="main">(</span><span class="skolem">rho''</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">tm</span><span class="main">,</span> undefined<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">j'</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="free">i</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> loop tbj'_def not_ets_te
    <span class="keyword1"><span class="command">unfolding</span></span> matchF_loop_inv_def matchF_loop_cond_def tbi_def<span class="main">(</span>3<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tbi_def tj'_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> valid_after atLeastLessThan_iff i'_def j'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> i_le_j'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_after<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> valid_after<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_def Let_def i'_def j'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> i_lt_j'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i_le_j' i'_set<span class="main">(</span>2<span class="main">)</span> right_I_add_mono<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"ts_at <span class="main">(</span><span class="skolem">rho''</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">tm</span><span class="main">,</span> undefined<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="skolem">j'</span>"</span></span> <span class="quoted"><span class="free">I</span></span><span class="main">]</span>
      i_lt_rho''
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">=</span> <span class="skolem">j'</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_at_def nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i'_lt_j'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i'</span> <span class="main">&lt;</span> <span class="skolem">j'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> valid_after
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> adv_last_bounds<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i''</span> <span class="main">=</span> Suc <span class="skolem">i'</span>"</span></span> <span class="quoted"><span class="quoted">"w_ti <span class="skolem">w''</span> <span class="main">=</span> <span class="skolem">ti'''</span>"</span></span> <span class="quoted"><span class="quoted">"w_si <span class="skolem">w''</span> <span class="main">=</span> <span class="skolem">si'''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j''</span> <span class="main">=</span> <span class="skolem">j'</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">tj''</span> <span class="main">=</span> <span class="skolem">tj'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sj''</span> <span class="main">=</span> <span class="skolem">sj'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_adv_start_bounds<span class="main">[</span><span class="operator">OF</span> valid_after<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>1<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span> i'_lt_j'<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">[</span></span></span></span></span><span class="operator"><span class="operator"><span class="operator"><span class="operator">unfolded</span></span></span></span> i'_def j'_def<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">]</span></span></span></span></span><span class="main">]</span>
      valid_adv_start_bounds'<span class="main">[</span><span class="operator">OF</span> valid_after<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">)</span></span></span> tbi_def<span class="main"><span class="main"><span class="main">(</span></span></span>1<span class="main"><span class="main"><span class="main">,</span></span></span>2<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">folded</span></span> valid_after<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">(</span></span></span></span></span>5<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">,</span></span></span></span></span>6<span class="main"><span class="main"><span class="main"><span class="main"><span class="main">)</span></span></span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span>
      <span class="operator"><span class="operator">unfolded</span></span> ti'_def si'_def<span class="main"><span class="main"><span class="main">]</span></span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> adv_start_last i'_def i''_def j'_def j''_def tj'_def tj''_def sj'_def sj''_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> i''_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i''</span> <span class="main">=</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_after adv_last_bounds <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> i_le_j'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">j'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_after i'_lt_j'
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i_le_rho<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> length <span class="skolem">rho''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_after<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_s init step <span class="skolem">st'</span> accept <span class="main">(</span>take <span class="skolem">j'</span> <span class="skolem">rho''</span><span class="main">)</span> <span class="free">i</span> <span class="free">i</span> <span class="skolem">j'</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_after<span class="main">(</span>1<span class="main">,</span>4<span class="main">)</span> i'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_def Let_def init_def step_def st'_def accept_def j'_def s'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> valid_s' <span class="main">=</span> this<span class="main">[</span><span class="operator">unfolded</span> valid_s_def<span class="main">]</span>
  <span class="keyword1"><span class="command">have</span></span> q0_in_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">∈</span> mmap_keys <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_s' init_def steps_refl <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">tstp</span></span> <span class="keyword2"><span class="keyword">where</span></span> lookup_s'<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="skolem">s'</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">tstp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lookup_sup_acc<span class="main">:</span> <span class="quoted"><span class="quoted">"snd <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="skolem">s'</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    sup_acc step accept <span class="main">(</span>take <span class="skolem">j'</span> <span class="skolem">rho''</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="free">i</span> <span class="skolem">j'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> conjunct2<span class="main">[</span><span class="operator">OF</span> valid_s'<span class="main">]</span> lookup_s'
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">smt</span> case_prodD option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> b_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="keyword1">case</span> snd <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="skolem">s'</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False
    <span class="main">|</span> Some <span class="bound">tstp</span> <span class="main">⇒</span> <span class="free">t</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> fst <span class="bound">tstp</span><span class="main">)</span> <span class="main">⟷</span> sat <span class="free">i</span> <span class="main">(</span>MatchF <span class="free">I</span> <span class="free">r</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> snd <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="skolem">s'</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False
      <span class="main">|</span> Some <span class="bound">tstp</span> <span class="main">⇒</span> <span class="free">t</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> fst <span class="bound">tstp</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="skolem"><span class="skolem">tp</span></span> <span class="keyword2"><span class="keyword">where</span></span> tstp_def<span class="main">:</span>
      <span class="quoted"><span class="quoted">"sup_acc step accept <span class="main">(</span>take <span class="skolem">j'</span> <span class="skolem">rho''</span><span class="main">)</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="free">i</span> <span class="skolem">j'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ts</span><span class="main">,</span> <span class="skolem">tp</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho''</span> <span class="free">i</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> <span class="skolem">ts</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> lookup_sup_acc
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tbi_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sup_acc_rho''<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_acc step accept <span class="skolem">rho''</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="free">i</span> <span class="skolem">j'</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ts</span><span class="main">,</span> <span class="skolem">tp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sup_acc_concat_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j'</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">j'</span> <span class="skolem">rho''</span>"</span></span> <span class="quoted">step</span> <span class="quoted">accept</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">j'</span> <span class="skolem">rho''</span>"</span></span><span class="main">]</span> j'_le_rho''
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> tp_props<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="skolem">j'</span><span class="main">}</span>"</span></span> <span class="quoted"><span class="quoted">"acc step accept <span class="skolem">rho''</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="skolem">tp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sup_acc_SomeE<span class="main">[</span><span class="operator">OF</span> sup_acc_rho''<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> ts_ts_at<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">ts</span> <span class="main">=</span> ts_at <span class="skolem">rho''</span> <span class="skolem">tp</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sup_acc_Some_ts<span class="main">[</span><span class="operator">OF</span> sup_acc_rho''<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">have</span></span> i_le_tp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="skolem">tp</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tp_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho''</span> <span class="skolem">tp</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="free">i</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i'_set<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> tp_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>ts_at <span class="skolem">rho''</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>ts_at <span class="skolem">rho''</span> <span class="skolem">tp</span><span class="main">)</span> <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> tstp_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> ts_ts_at mem_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">i</span> <span class="main">(</span>MatchF <span class="free">I</span> <span class="free">r</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> i_le_tp acc_match<span class="main">[</span><span class="operator">OF</span> reach_sj''' i_le_tp<span class="main">]</span> tp_props<span class="main">(</span>2<span class="main">)</span> ts_at_tau<span class="main">[</span><span class="operator">OF</span> reach_tj'''<span class="main">]</span>
        tp_props<span class="main">(</span>1<span class="main">)</span> j'_le_rho''
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"sat <span class="free">i</span> <span class="main">(</span>MatchF <span class="free">I</span> <span class="free">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≥</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"mem <span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span><span class="main">)</span> <span class="main">(</span>τ <span class="free">σ</span> <span class="skolem">l</span><span class="main">)</span> <span class="free">I</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="skolem">l</span><span class="main">)</span> <span class="main">∈</span> match <span class="free">r</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> l_lt_rho<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> length <span class="skolem">rho''</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">l</span> <span class="main">&lt;</span> length <span class="skolem">rho''</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">tm</span> <span class="main">=</span> ts_at <span class="main">(</span><span class="skolem">rho''</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">tm</span><span class="main">,</span> undefined<span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>length <span class="skolem">rho''</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i_le_rho
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> ts_at_def rho''_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> τ_mono ts_at_tau<span class="main">[</span><span class="operator">OF</span> reach_tm<span class="main">]</span> i_le_rho contr
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> One_nat_def Suc_eq_plus1 length_append lessI list.size<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span>
            list.size<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span> not_le_imp_less<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"τ <span class="free">σ</span> <span class="skolem">l</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">i</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> l_def<span class="main">(</span>2<span class="main">)</span>
        <span class="keyword1"><span class="command">unfolding</span></span> mem_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">tm</span> <span class="main">≤</span> τ <span class="free">σ</span> <span class="free">i</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
        <span class="keyword1"><span class="command">using</span></span> before_end' ts_at_tau<span class="main">[</span><span class="operator">OF</span> reach_tj''' i_lt_rho''<span class="main">]</span> tbi_def<span class="main">(</span>3<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho''_def<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">have</span></span> l_lt_j'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">j'</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
      <span class="keyword3"><span class="command">assume</span></span> contr<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">j'</span>"</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> ts_at_j'_l<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho''</span> <span class="skolem">j'</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="skolem">l</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> ts_at_mono<span class="main">[</span><span class="operator">OF</span> reach_tj'''<span class="main">]</span> l_lt_rho
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> order.not_eq_order_implies_strict<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> ts_at_l_iu<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho''</span> <span class="skolem">l</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="free">i</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> l_def<span class="main">(</span>2<span class="main">)</span> ts_at_tau<span class="main">[</span><span class="operator">OF</span> reach_tj''' l_lt_rho<span class="main">]</span> ts_at_tau<span class="main">[</span><span class="operator">OF</span> reach_tj''' i_lt_rho''<span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> mem_def
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
        <span class="keyword1"><span class="command">using</span></span> i'_set<span class="main">(</span>2<span class="main">)</span> order_trans ts_at_j'_l ts_at_l_iu contr l_lt_rho
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_at_def nth_append <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">tp</span></span> <span class="keyword2"><span class="keyword">where</span></span> tstp_def<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_acc step accept <span class="skolem">rho''</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span> <span class="free">i</span> <span class="skolem">j'</span> <span class="main">=</span> Some <span class="main">(</span>ts_at <span class="skolem">rho''</span> <span class="skolem">tp</span><span class="main">,</span> <span class="skolem">tp</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">tp</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">&lt;</span> <span class="skolem">j'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> sup_acc_SomeI<span class="main">[</span><span class="operator">unfolded</span> acc_is_accept<span class="main">,</span> <span class="operator">of</span> <span class="quoted">step</span> <span class="quoted">accept</span><span class="main">]</span> l_def<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> l_lt_j' l_lt_rho
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">meson</span> accept_match<span class="main"><span class="main">[</span></span><span class="operator">OF</span> reach_sj''' l_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> steps_is_run<span class="main"><span class="main">]</span></span> acc_is_accept
          atLeastLessThan_iff sup_acc_SomeI<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho''</span> <span class="free">i</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="skolem">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> l_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> ts_at_tau<span class="main">[</span><span class="operator">OF</span> reach_tj''' i_lt_rho''<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span>
        ts_at_tau<span class="main">[</span><span class="operator">OF</span> reach_tj''' l_lt_rho<span class="main">,</span> <span class="operator">symmetric</span><span class="main">]</span> mem_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho''</span> <span class="free">i</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="skolem">tp</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> ts_at_mono<span class="main">[</span><span class="operator">OF</span> reach_tj''' tstp_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> tstp_def<span class="main">(</span>3<span class="main">)</span> j'_le_rho''
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="keyword1">case</span> snd <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="skolem">s'</span> <span class="main">{</span><span class="main">0</span><span class="main">}</span><span class="main">)</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> False
      <span class="main">|</span> Some <span class="bound">tstp</span> <span class="main">⇒</span> <span class="free">t</span> <span class="main">+</span> left <span class="free">I</span> <span class="main">≤</span> fst <span class="bound">tstp</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lookup_sup_acc tstp_def j'_le_rho''
        sup_acc_concat_cong<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">j'</span></span> <span class="quoted"><span class="quoted">"take <span class="skolem">j'</span> <span class="skolem">rho''</span>"</span></span> <span class="quoted">step</span> <span class="quoted">accept</span> <span class="quoted"><span class="quoted">"drop <span class="skolem">j'</span> <span class="skolem">rho''</span>"</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tbi_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_matchF <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span>take <span class="skolem">j''</span> <span class="skolem">rho''</span><span class="main">)</span> <span class="skolem">i''</span> <span class="main">(</span>adv_start <span class="free">args</span> <span class="skolem">w'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i'</span><span class="main">..&lt;</span><span class="skolem">j'</span><span class="main">}</span><span class="main">.</span> ts_at <span class="skolem">rho''</span> <span class="bound">l</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="skolem">i'</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> loop i'_def j'_def valid_after
      <span class="keyword1"><span class="command">unfolding</span></span> matchF_loop_inv_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j'</span> <span class="main">⟹</span> ts_at <span class="skolem">rho''</span> <span class="free">i</span> <span class="main">+</span> right <span class="free">I</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword3"><span class="command">assume</span></span> lassm<span class="main">:</span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">j'</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho''</span> <span class="free">i</span> <span class="main">+</span> right <span class="free">I</span> <span class="main">=</span> right <span class="free">I</span> <span class="main">+</span> ts_at <span class="skolem">rho''</span> <span class="free">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">≤</span> right <span class="free">I</span> <span class="main">+</span> ts_at <span class="skolem">rho''</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> add_mono ts_at_mono<span class="main">[</span><span class="operator">OF</span> reach_tj'''<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="quoted">"Suc <span class="free">i</span>"</span></span><span class="main">]</span> lassm j'_le_rho''
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">…</span> <span class="main">=</span> ts_at <span class="skolem">rho''</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> add.commute<span class="main">)</span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">l</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">i''</span><span class="main">..&lt;</span><span class="skolem">j''</span><span class="main">}</span><span class="main">.</span> ts_at <span class="skolem">rho''</span> <span class="bound">l</span> <span class="main">≤</span> ts_at <span class="skolem">rho''</span> <span class="skolem">i''</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> i''_i valid_after adv_last_bounds
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> l
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">drule</span> ballE<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">l</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span>take <span class="skolem">j''</span> <span class="skolem">rho''</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i''</span><span class="main">,</span> <span class="skolem">ti'''</span><span class="main">,</span> <span class="skolem">si'''</span><span class="main">,</span> <span class="skolem">j''</span><span class="main">,</span> <span class="skolem">tj''</span><span class="main">,</span> <span class="skolem">sj''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
      <span class="keyword1"><span class="command">have</span></span> rw<span class="main">:</span> <span class="quoted"><span class="quoted">"rw <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span>take <span class="skolem">j'</span> <span class="skolem">rho''</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i'</span><span class="main">,</span> <span class="skolem">ti'</span><span class="main">,</span> <span class="skolem">si'</span><span class="main">,</span> <span class="skolem">j'</span><span class="main">,</span> <span class="skolem">tj'</span><span class="main">,</span> <span class="skolem">sj'</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid_after<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_def Let_def i'_def ti'_def si'_def j'_def tj'_def sj'_def<span class="main">)</span>
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> reach_window_shift<span class="main">[</span><span class="operator">OF</span> rw i'_lt_j'
            tbi_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> valid_after<span class="main"><span class="main"><span class="main">(</span></span></span>5<span class="main"><span class="main"><span class="main">,</span></span></span>6<span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">[</span></span></span><span class="operator"><span class="operator">symmetric</span></span><span class="main"><span class="main"><span class="main">]</span></span></span><span class="main"><span class="main">]</span></span><span class="main">]</span> adv_last_bounds
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span>take <span class="skolem">j'</span> <span class="skolem">rho''</span><span class="main">)</span> <span class="skolem">w''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_adv_start<span class="main">[</span><span class="operator">OF</span> valid_after<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> i'_lt_j'<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> i'_def j'_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> adv_start_last j'_def <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid_matchF <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span>take <span class="skolem">j''</span> <span class="skolem">rho''</span><span class="main">)</span> <span class="skolem">i''</span> <span class="main">(</span>adv_start <span class="free">args</span> <span class="skolem">w'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> j'_le_rho''
      <span class="keyword1"><span class="command">unfolding</span></span> valid_window_matchF_def adv_last_bounds adv_start_last<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> i''_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
        j'_def j''_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> tj'_def tj''_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> sj'_def sj''_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_at_def<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"eval_mF <span class="free">I</span> <span class="free">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span>τ <span class="free">σ</span> <span class="free">i</span><span class="main">,</span> sat <span class="free">i</span> <span class="main">(</span>MatchF <span class="free">I</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span><span class="main">,</span> <span class="skolem">w''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> j''_def adv_start_last<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> adv_last_bounds valid_after rho''_def
      eval_matchF.simps run_t_read<span class="main">[</span><span class="operator">OF</span> tbi_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> ti_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
      run_sub_read<span class="main">[</span><span class="operator">OF</span> tbi_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> si_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">using</span></span> loop_def tbj'_def<span class="main">[</span><span class="operator">unfolded</span> tj'_def<span class="main">]</span> not_ets_te<span class="main">[</span><span class="operator">folded</span> tbi_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      b_alt<span class="main">[</span><span class="operator">unfolded</span> s'_def<span class="main">]</span> t_def adv_start_last
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">only</span><span class="main"><span class="main">:</span></span> Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> j''_def adv_start_last<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> adv_last_bounds valid_after rho''_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_eval_matchF_sound<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_matchF <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">i</span> <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> eval<span class="main">:</span> <span class="quoted"><span class="quoted">"eval_mF <span class="free">I</span> <span class="free">w</span> <span class="main">=</span> Some <span class="main">(</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">,</span> <span class="free">w''</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> bounded<span class="main">:</span> <span class="quoted"><span class="quoted">"finite_ts <span class="main">(</span>right <span class="free">I</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">t</span> <span class="main">=</span> τ <span class="free">σ</span> <span class="free">i</span> <span class="main">∧</span> <span class="free">b</span> <span class="main">=</span> sat <span class="free">i</span> <span class="main">(</span>MatchF <span class="free">I</span> <span class="free">r</span><span class="main">)</span> <span class="main">∧</span> <span class="main">(</span><span class="main">∃</span><span class="bound">rho'</span><span class="main">.</span> valid_matchF <span class="free">I</span> <span class="free">t0</span> <span class="free">sub</span> <span class="bound">rho'</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="free">w''</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">rho'</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">tm</span></span> <span class="keyword2"><span class="keyword">where</span></span> rho'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="main">(</span>w_tj <span class="free">w</span><span class="main">)</span> <span class="main">(</span>map fst <span class="skolem">rho'</span><span class="main">)</span> <span class="main">(</span>w_tj <span class="free">w''</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="main">(</span>w_sj <span class="free">w</span><span class="main">)</span> <span class="main">(</span>map snd <span class="skolem">rho'</span><span class="main">)</span> <span class="main">(</span>w_sj <span class="free">w''</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_read_t <span class="free">args</span> <span class="main">(</span>w_ti <span class="free">w</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">t</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_read_t <span class="free">args</span> <span class="main">(</span>w_tj <span class="free">w''</span><span class="main">)</span> <span class="main">=</span> Some <span class="skolem">tm</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="skolem">tm</span> <span class="main">≤</span> <span class="skolem">t</span> <span class="main">+</span> right <span class="free">I</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_eval_matchF_Some<span class="main">[</span><span class="operator">OF</span> assms<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_eval_matchF_complete<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> rho'_def<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> eval
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">thm</span></span> valid_eval_matchP
<span class="keyword1"><span class="command">thm</span></span> valid_eval_matchF_sound
<span class="keyword1"><span class="command">thm</span></span> valid_eval_matchF_complete

<span class="keyword2"><span class="keyword">end</span></span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>