<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><link rel="stylesheet" type="text/css" href="isabelle.css"/>
<title>Theory Window</title>
</head>


<body>
<div class="head">
<h1>Theory Window</h1>
</div>

<pre class="source"><span class="keyword1"><span class="command">theory</span></span> Window
  <span class="keyword2"><span class="keyword">imports</span></span> <span class="quoted">"<a href="../../HOL/HOL-Library/AList.html">HOL-Library.AList</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Library/Mapping.html">HOL-Library.Mapping</a>"</span> <span class="quoted">"<a href="../../HOL/HOL-Library/While_Combinator.html">HOL-Library.While_Combinator</a>"</span> <a href="Timestamp.html">Timestamp</a>
<span class="keyword2"><span class="keyword">begin</span></span>

<span class="keyword1"><span class="command">type_synonym</span></span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mmap <span class="main">=</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list"</span></span>

<span class="comment1">(* 'b is a polymorphic input symbol; 'c is a polymorphic DFA state;
   'd is a timestamp; 'e is a submonitor state *)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">chain_le</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> <span class="main">::</span> timestamp list <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  chain_le_Nil<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">chain_le</span> <span class="main">[]</span>"</span></span>
<span class="main">|</span> chain_le_singleton<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">chain_le</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">x</span></span></span><span class="main">]</span>"</span></span>
<span class="main">|</span> chain_le_cons<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">chain_le</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">⟹</span> <span class="free">chain_le</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">x</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">y</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">xs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chain_le_app<span class="main">:</span> <span class="quoted"><span class="quoted">"chain_le <span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="main">[</span><span class="free">z</span><span class="main">]</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">z</span> <span class="main">≤</span> <span class="free">w</span> <span class="main">⟹</span> chain_le <span class="main">(</span><span class="main">(</span><span class="free">zs</span> <span class="main">@</span> <span class="main">[</span><span class="free">z</span><span class="main">]</span><span class="main">)</span> <span class="main">@</span> <span class="main">[</span><span class="free">w</span><span class="main">]</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">zs</span> <span class="main">@</span> <span class="main">[</span><span class="free">z</span><span class="main">]</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">zs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chain_le.induct<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> chain_le.intros<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> y xs x zs
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">zs</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> append.assoc append_Cons append_Nil chain_le_cons<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">reach_sub</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'f</span><span class="main">)</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'f</span> list <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">run</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'f</span><span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">reach_sub</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">[]</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">reach_sub</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span> <span class="free"><span class="bound"><span class="entity">s''</span></span></span> <span class="main">⟹</span> <span class="free">reach_sub</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">vs</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s''</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reach_sub_split<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="free">run</span> <span class="free">s</span> <span class="free">vs</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">&lt;</span> length <span class="free">vs</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">s''</span> <span class="bound">s'''</span><span class="main">.</span> reach_sub <span class="free">run</span> <span class="free">s</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">vs</span><span class="main">)</span> <span class="bound">s''</span> <span class="main">∧</span> <span class="free">run</span> <span class="bound">s''</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">s'''</span><span class="main">,</span> <span class="free">vs</span> <span class="main">!</span> <span class="free">i</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reach_sub.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">s''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reach_sub.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reach_sub.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_sub_split'<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="free">run</span> <span class="free">s</span> <span class="free">vs</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> length <span class="free">vs</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">s''</span> <span class="main">.</span> reach_sub <span class="free">run</span> <span class="free">s</span> <span class="main">(</span>take <span class="free">i</span> <span class="free">vs</span><span class="main">)</span> <span class="bound">s''</span> <span class="main">∧</span> reach_sub <span class="free">run</span> <span class="bound">s''</span> <span class="main">(</span>drop <span class="free">i</span> <span class="free">vs</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reach_sub.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">s''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> 2
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Suc <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reach_sub.intros<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reach_sub.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reach_sub.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_sub_split_app<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="free">run</span> <span class="free">s</span> <span class="main">(</span><span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">)</span> <span class="free">s'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">s''</span><span class="main">.</span> reach_sub <span class="free">run</span> <span class="free">s</span> <span class="free">vs</span> <span class="bound">s''</span> <span class="main">∧</span> reach_sub <span class="free">run</span> <span class="bound">s''</span> <span class="free">vs'</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reach_sub_split'<span class="main">[</span><span class="keyword2"><span class="keyword"><span class="operator">where</span></span></span> i<span class="main"><span class="main">=</span></span><span class="quoted"><span class="quoted">"length <span class="free">vs</span>"</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">run</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"<span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span>"</span></span> <span class="quoted"><span class="free">s'</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_sub_inj<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="free">run</span> <span class="free">s</span> <span class="free">vs</span> <span class="free">t</span> <span class="main">⟹</span> reach_sub <span class="free">run</span> <span class="free">s</span> <span class="free">vs'</span> <span class="free">t'</span> <span class="main">⟹</span>
  length <span class="free">vs</span> <span class="main">=</span> length <span class="free">vs'</span> <span class="main">⟹</span> <span class="free">vs</span> <span class="main">=</span> <span class="free">vs'</span> <span class="main">∧</span> <span class="free">t</span> <span class="main">=</span> <span class="free">t'</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quoted"><span class="free">t</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">vs'</span></span> <span class="quoted"><span class="free">t'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reach_sub.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> reach_sub.cases<span class="main">)</span><span class="main"><span class="keyword3">[</span></span>1<span class="main"><span class="keyword3">]</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s s' v vs s'' vs' t'
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">rule</span> reach_sub.cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">run</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s'</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">vs</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s''</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main"><span class="keyword3">;</span></span> <span class="operator">rule</span> reach_sub.cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="free"><span class="quoted"><span class="free">run</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">s</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">vs'</span></span></span></span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">t'</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
            <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">assumption</span><span class="main"><span class="keyword3">+</span></span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span><span class="main"><span class="keyword3">[</span></span>2<span class="main"><span class="keyword3">]</span></span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> length_0_conv list.discI<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Pair_inject length_Cons nat.inject option.inject<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> reach_sub_split_last<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="free">run</span> <span class="free">s</span> <span class="main">(</span><span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">s''</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">s'</span><span class="main">.</span> reach_sub <span class="free">run</span> <span class="free">s</span> <span class="free">xs</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="free">run</span> <span class="bound">s'</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">s''</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="quoted">"<span class="free">xs</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span>"</span></span> <span class="quoted"><span class="free">s''</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">xs</span></span> <span class="quoted"><span class="free">x</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reach_sub.induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">subgoal</span></span></span></span> <span class="keyword2"><span class="keyword">for</span></span> s s' v vs s'' xs x
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">vs</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_cases<span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> reach_sub.cases <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reach_sub.intros<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> reach_sub_rev_induct<span class="main">[</span><span class="operator">consumes</span> 1<span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="free">run</span> <span class="free">s</span> <span class="free">vs</span> <span class="free">s'</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span><span class="main">.</span> <span class="free">P</span> <span class="bound">s</span> <span class="main">[]</span> <span class="bound">s</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">s</span> <span class="bound">s'</span> <span class="bound">v</span> <span class="bound">vs</span> <span class="bound">s''</span><span class="main">.</span> reach_sub <span class="free">run</span> <span class="bound">s</span> <span class="bound">vs</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="free">P</span> <span class="bound">s</span> <span class="bound">vs</span> <span class="bound">s'</span> <span class="main">⟹</span> <span class="free">run</span> <span class="bound">s'</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">s''</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="free">P</span> <span class="bound">s</span> <span class="main">(</span><span class="bound">vs</span> <span class="main">@</span> <span class="main">[</span><span class="bound">v</span><span class="main">]</span><span class="main">)</span> <span class="bound">s''</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">P</span> <span class="free">s</span> <span class="free">vs</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>snoc <span class="skolem">x</span> <span class="skolem">xs</span><span class="main">)</span>
  <span class="keyword1"><span class="command">from</span></span> snoc<span class="main">(</span>2<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="keyword2"><span class="keyword">where</span></span> s''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="free">run</span> <span class="skolem">s</span> <span class="skolem">xs</span> <span class="skolem">s''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="skolem">s''</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">x</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_sub_split_last
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> snoc<span class="main">(</span>4<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> s''_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> _ s''_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> snoc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> s''_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> snoc<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> reach_sub.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_sub_app<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="free">run</span> <span class="free">s</span> <span class="free">vs</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">run</span> <span class="free">s'</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">s''</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">⟹</span>
  reach_sub <span class="free">run</span> <span class="free">s</span> <span class="main">(</span><span class="free">vs</span> <span class="main">@</span> <span class="main">[</span><span class="free">v</span><span class="main">]</span><span class="main">)</span> <span class="free">s''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reach_sub.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reach_sub.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_sub_trans<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="free">run</span> <span class="free">s</span> <span class="free">vs</span> <span class="free">s'</span> <span class="main">⟹</span> reach_sub <span class="free">run</span> <span class="free">s'</span> <span class="free">vs'</span> <span class="free">s''</span> <span class="main">⟹</span>
  reach_sub <span class="free">run</span> <span class="free">s</span> <span class="main">(</span><span class="free">vs</span> <span class="main">@</span> <span class="free">vs'</span><span class="main">)</span> <span class="free">s''</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reach_sub.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reach_sub.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_subD<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="free">run</span> <span class="free">s</span> <span class="main">(</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span> <span class="main">#</span> <span class="free">vs</span><span class="main">)</span> <span class="free">s'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">s''</span><span class="main">.</span> <span class="free">run</span> <span class="free">s</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">s''</span><span class="main">,</span> <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">b</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> reach_sub <span class="free">run</span> <span class="bound">s''</span> <span class="free">vs</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> reach_sub.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_sub_setD<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="free">run</span> <span class="free">s</span> <span class="free">vs</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> set <span class="free">vs</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">vs'</span> <span class="bound">vs''</span> <span class="bound">s''</span><span class="main">.</span> reach_sub <span class="free">run</span> <span class="free">s</span> <span class="main">(</span><span class="bound">vs'</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="bound">s''</span> <span class="main">∧</span> reach_sub <span class="free">run</span> <span class="bound">s''</span> <span class="bound">vs''</span> <span class="free">s'</span> <span class="main">∧</span> <span class="free">vs</span> <span class="main">=</span> <span class="bound">vs'</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="bound">vs''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reach_sub_rev_induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>2 <span class="skolem">s</span> <span class="skolem">s'</span> <span class="skolem">v</span> <span class="skolem">vs</span> <span class="skolem">s''</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> set <span class="skolem">vs</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> True
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs'</span></span> <span class="skolem"><span class="skolem">vs''</span></span> <span class="skolem"><span class="skolem">s'''</span></span> <span class="keyword2"><span class="keyword">where</span></span> split_def<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="free">run</span> <span class="skolem">s</span> <span class="main">(</span><span class="skolem">vs'</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="skolem">s'''</span>"</span></span>
      <span class="quoted"><span class="quoted">"reach_sub <span class="free">run</span> <span class="skolem">s'''</span> <span class="skolem">vs''</span> <span class="skolem">s'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">vs'</span> <span class="main">@</span> <span class="free">x</span> <span class="main">#</span> <span class="skolem">vs''</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> True<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> split_def<span class="main">(</span>1<span class="main">,</span>3<span class="main">)</span> reach_sub_app<span class="main">[</span><span class="operator">OF</span> split_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> 2<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> False
    <span class="keyword1"><span class="command">have</span></span> x_v<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">=</span> <span class="skolem">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> 2<span class="main">(</span>4<span class="main">)</span> False
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> x_v
      <span class="keyword1"><span class="command">using</span></span> reach_sub_app<span class="main">[</span><span class="operator">OF</span> 2<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> reach_sub.intros<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">run</span></span> <span class="quoted"><span class="skolem">s''</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">qed</span></span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_sub_len<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">vs</span> <span class="bound">s'</span><span class="main">.</span> reach_sub <span class="free">run</span> <span class="free">s</span> <span class="bound">vs</span> <span class="bound">s'</span> <span class="main">∧</span> <span class="main">(</span>length <span class="bound">vs</span> <span class="main">=</span> <span class="free">n</span> <span class="main">∨</span> <span class="free">run</span> <span class="bound">s'</span> <span class="main">=</span> None<span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">n</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">x</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">x</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="keyword2"><span class="keyword">where</span></span> s''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="free">run</span> <span class="skolem">s'</span> <span class="skolem">vs</span> <span class="skolem">s''</span>"</span></span> <span class="quoted"><span class="quoted">"length <span class="skolem">vs</span> <span class="main">=</span> <span class="skolem">n</span> <span class="main">∨</span> <span class="free">run</span> <span class="skolem">s''</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">s'</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> reach_sub.intros<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> Some<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> x_def<span class="main"><span class="main">]</span></span> s''_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> s''_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reach_sub.intros<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reach_sub.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_sub_NilD<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="free">run</span> <span class="free">q</span> <span class="main">[]</span> <span class="free">q'</span> <span class="main">⟹</span> <span class="free">q</span> <span class="main">=</span> <span class="free">q'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> reach_sub.cases<span class="main">)</span>

<span class="keyword1"><span class="command">inductive</span></span> <span class="entity">reaches</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'f</span><span class="main">)</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> bool"</span></span>
  <span class="keyword2"><span class="keyword">for</span></span> <span class="entity">run</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'f</span><span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
    <span class="quoted"><span class="quoted">"<span class="free">reaches</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">0</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span>"</span></span>
  <span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">run</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">s'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">⟹</span> <span class="free">reaches</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">s'</span></span></span> <span class="free"><span class="bound"><span class="entity">n</span></span></span> <span class="free"><span class="bound"><span class="entity">s''</span></span></span> <span class="main">⟹</span> <span class="free">reaches</span> <span class="free">run</span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">(</span>Suc <span class="free"><span class="bound"><span class="entity">n</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">s''</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reach_sub_n<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="free">run</span> <span class="free">s</span> <span class="free">vs</span> <span class="free">s'</span> <span class="main">⟹</span> reaches <span class="free">run</span> <span class="free">s</span> <span class="main">(</span>length <span class="free">vs</span><span class="main">)</span> <span class="free">s'</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">vs</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reach_sub.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reaches.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reaches_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"reaches <span class="free">run</span> <span class="free">s</span> <span class="free">n</span> <span class="free">s'</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">vs</span><span class="main">.</span> reach_sub <span class="free">run</span> <span class="free">s</span> <span class="bound">vs</span> <span class="free">s'</span> <span class="main">∧</span> length <span class="bound">vs</span> <span class="main">=</span> <span class="free">n</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">s</span></span> <span class="quoted"><span class="free">n</span></span> <span class="quoted"><span class="free">s'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> reaches.induct<span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reach_sub.intros<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">ts_at</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'d</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">ts_at</span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> fst <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">bs_at</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'b</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">bs_at</span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> snd <span class="main">(</span><span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">!</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">sub_bs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'b</span> list"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sub_bs</span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">=</span> map <span class="main">(</span>bs_at <span class="free"><span class="bound"><span class="entity">rho</span></span></span><span class="main">)</span> <span class="main">[</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">]</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">steps</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> nat <span class="main">×</span> nat <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">steps</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">ij</span></span></span> <span class="main">=</span> foldl <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">(</span>sub_bs <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">ij</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">acc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span>
  <span class="tfree">'c</span> <span class="main">⇒</span> nat <span class="main">×</span> nat <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">acc</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">ij</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="main">(</span>steps <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">ij</span></span></span><span class="main">)</span> <span class="main">(</span>bs_at <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">(</span>snd <span class="free"><span class="bound"><span class="entity">ij</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sup_acc</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span>
  <span class="tfree">'c</span> <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> nat<span class="main">)</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sup_acc</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">L'</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">..&lt;</span><span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">}</span><span class="main">.</span> acc <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">}</span><span class="main">;</span> <span class="bound">m</span> <span class="main">=</span> Max <span class="bound">L'</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">L'</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>ts_at <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">m</span><span class="main">,</span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">sup_leadsto</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span>
  nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'d</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">sup_leadsto</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">L'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">∧</span> steps <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">}</span><span class="main">;</span> <span class="bound">m</span> <span class="main">=</span> Max <span class="bound">L'</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">L'</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>ts_at <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">m</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mmap_keys</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mmap <span class="main">⇒</span> <span class="tfree">'a</span> set"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mmap_keys</span> <span class="free"><span class="bound"><span class="entity">kvs</span></span></span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">kvs</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mmap_lookup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mmap <span class="main">⇒</span> <span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mmap_lookup</span> <span class="main">=</span> map_of"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> mapping <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> nat<span class="main">)</span> option<span class="main">)</span> mmap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
 <span class="quoted"><span class="quoted">"<span class="free">valid_s</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">≡</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span>  
  <span class="main">(</span>mmap_keys <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">l</span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span><span class="main">.</span> steps <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="bound">q</span><span class="main">)</span><span class="main">}</span> <span class="main">∧</span> distinct <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> <span class="keyword1">case</span> mmap_lookup <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">q</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True
  <span class="main">|</span> Some <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">tstp</span><span class="main">)</span> <span class="main">⇒</span> steps <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">q</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="bound">q'</span> <span class="main">∧</span> <span class="bound">tstp</span> <span class="main">=</span> sup_acc <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">q</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> args <span class="main">=</span>
  w_init <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'c</span></span></span>
  w_step <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span>"</span></span>
  w_accept <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool"</span></span>
  w_run_t <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> option"</span></span>
  w_read_t <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'t</span> <span class="main">⇒</span> <span class="tfree">'d</span> option"</span></span>
  w_run_sub <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> option"</span></span>
  w_read_sub <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'b</span> option"</span></span>

<span class="keyword1"><span class="command">record</span></span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> window <span class="main">=</span>
  w_st <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> mapping"</span></span>
  w_ac <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> bool<span class="main">)</span> mapping"</span></span>
  w_i <span class="main">::</span> <span class="quoted">nat</span>
  w_ti <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'t</span></span></span>
  w_si <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'e</span></span></span>
  w_j <span class="main">::</span> <span class="quoted">nat</span>
  w_tj <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'t</span></span></span>
  w_sj <span class="main">::</span> <span class="tfree"><span class="quoted"><span class="tfree">'e</span></span></span>
  w_s <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> nat<span class="main">)</span> option<span class="main">)</span> mmap"</span></span>
  w_e <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> mmap"</span></span>

<span class="keyword1"><span class="command">copy_bnf</span></span> <span class="main">(</span>dead <span class="tfree">'b</span><span class="main">,</span> dead <span class="tfree">'c</span><span class="main">,</span> dead <span class="tfree">'d</span><span class="main">,</span> dead <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">,</span> dead <span class="tfree">'ext</span><span class="main">)</span> window_ext

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">reach_window</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> args <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span> nat <span class="main">×</span> <span class="tfree">'t</span> <span class="main">×</span> <span class="tfree">'e</span> <span class="main">×</span> nat <span class="main">×</span> <span class="tfree">'t</span> <span class="main">×</span> <span class="tfree">'e</span> <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">reach_window</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">i</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">si</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tj</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sj</span></span></span><span class="main">)</span> <span class="main">⟷</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">≤</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> length <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span>
    reach_sub <span class="main">(</span>w_run_t <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">rho</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span> <span class="main">∧</span>
    reach_sub <span class="main">(</span>w_run_t <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">ti</span></span></span> <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>map fst <span class="free"><span class="bound"><span class="entity">rho</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">tj</span></span></span> <span class="main">∧</span>
    reach_sub <span class="main">(</span>w_run_sub <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">(</span>take <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>map snd <span class="free"><span class="bound"><span class="entity">rho</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="main">∧</span>
    reach_sub <span class="main">(</span>w_run_sub <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">si</span></span></span> <span class="main">(</span>drop <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>map snd <span class="free"><span class="bound"><span class="entity">rho</span></span></span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">sj</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reach_windowI<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span><span class="main">)</span> <span class="free">ti</span> <span class="main">⟹</span>
  reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span><span class="main">)</span> <span class="free">si</span> <span class="main">⟹</span>
  reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span> <span class="free">tj</span> <span class="main">⟹</span>
  reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span> <span class="free">sj</span> <span class="main">⟹</span>
  <span class="free">i</span> <span class="main">≤</span> length <span class="free">rho</span> <span class="main">⟹</span> length <span class="free">rho</span> <span class="main">=</span> <span class="free">j</span> <span class="main">⟹</span>
  reach_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">ti</span><span class="main">,</span> <span class="free">si</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">tj</span><span class="main">,</span> <span class="free">sj</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> reach_sub_split'<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free"><span class="quoted"><span class="free"><span class="quoted"><span class="free">i</span></span></span></span></span></span><span class="main"><span class="main">]</span></span> length_map reach_sub_inj<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> reach_window_shift<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"reach_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">ti</span><span class="main">,</span> <span class="free">si</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">tj</span><span class="main">,</span> <span class="free">sj</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="free">ti</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ti'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span> <span class="free">si</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">si'</span><span class="main">,</span> <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"reach_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">,</span> <span class="free">ti'</span><span class="main">,</span> <span class="free">si'</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">tj</span><span class="main">,</span> <span class="free">sj</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reach_sub_app<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span>"</span></span> <span class="quoted"><span class="free">t0</span></span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">ti</span></span> <span class="quoted"><span class="free">ti'</span></span> <span class="quoted"><span class="free">t</span></span><span class="main">]</span>
    reach_sub_app<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span>"</span></span> <span class="quoted"><span class="free">sub</span></span> <span class="quoted"><span class="quoted">"take <span class="free">i</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="free">si</span></span> <span class="quoted"><span class="free">si'</span></span> <span class="quoted"><span class="free">s</span></span><span class="main">]</span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> append_take_drop_id id_take_nth_drop length_map list.discI list.inject
      option.inject reach_sub.cases same_append_eq snd_conv take_Suc_conv_app_nth<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> Cons_nth_drop_Suc fst_conv length_map list.discI list.inject option.inject
      reach_sub.cases<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> append_take_drop_id id_take_nth_drop length_map list.discI list.inject
      option.inject reach_sub.cases same_append_eq snd_conv take_Suc_conv_app_nth<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> Cons_nth_drop_Suc fst_conv length_map list.discI list.inject option.inject
      reach_sub.cases<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> reach_window_run_ti<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">ti</span><span class="main">,</span> <span class="free">si</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">tj</span><span class="main">,</span> <span class="free">sj</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">ti'</span><span class="main">.</span> reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span><span class="main">)</span> <span class="free">ti</span> <span class="main">∧</span>
  w_run_t <span class="free">args</span> <span class="free">ti</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">ti'</span><span class="main">,</span> ts_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span>
  reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="bound">ti'</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span><span class="main">)</span> <span class="free">tj</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_at_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reach_sub.cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span>"</span></span> <span class="quoted"><span class="free">ti</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">i</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> nth_via_drop <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_nth_drop_Suc length_map list.inject<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_window_run_si<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">ti</span><span class="main">,</span> <span class="free">si</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">tj</span><span class="main">,</span> <span class="free">sj</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">si'</span><span class="main">.</span> reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>take <span class="free">i</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span><span class="main">)</span> <span class="free">si</span> <span class="main">∧</span>
  w_run_sub <span class="free">args</span> <span class="free">si</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">si'</span><span class="main">,</span> bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span> <span class="main">∧</span>
  reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="bound">si'</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="free">i</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span><span class="main">)</span> <span class="free">sj</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bs_at_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reach_sub.cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span>"</span></span> <span class="quoted"><span class="free">si</span></span> <span class="quoted"><span class="quoted">"drop <span class="free">i</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span>"</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> nth_via_drop <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_nth_drop_Suc length_map list.inject<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_window_run_tj<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">ti</span><span class="main">,</span> <span class="free">si</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">tj</span><span class="main">,</span> <span class="free">sj</span><span class="main">)</span> <span class="main">⟹</span>
  reach_sub <span class="main">(</span>w_run_t <span class="free">args</span><span class="main">)</span> <span class="free">t0</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span> <span class="free">tj</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reach_sub_trans
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_window_run_sj<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">ti</span><span class="main">,</span> <span class="free">si</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">tj</span><span class="main">,</span> <span class="free">sj</span><span class="main">)</span> <span class="main">⟹</span>
  reach_sub <span class="main">(</span>w_run_sub <span class="free">args</span><span class="main">)</span> <span class="free">sub</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span> <span class="free">sj</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reach_sub_trans
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_window_shift_all<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">si</span><span class="main">,</span> <span class="free">ti</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">sj</span><span class="main">,</span> <span class="free">tj</span><span class="main">)</span> <span class="main">⟹</span>
  reach_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="free">j</span><span class="main">,</span> <span class="free">sj</span><span class="main">,</span> <span class="free">tj</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">sj</span><span class="main">,</span> <span class="free">tj</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> reach_window_run_tj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">args</span></span> <span class="quoted"><span class="free">t0</span></span> <span class="quoted"><span class="free">sub</span></span> <span class="quoted"><span class="free">rho</span></span><span class="main">]</span> reach_window_run_sj<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="free">args</span></span> <span class="quoted"><span class="free">t0</span></span> <span class="quoted"><span class="free">sub</span></span> <span class="quoted"><span class="free">rho</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reach_sub.intros<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> reach_window_app<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">si</span><span class="main">,</span> <span class="free">ti</span><span class="main">,</span> <span class="free">j</span><span class="main">,</span> <span class="free">tj</span><span class="main">,</span> <span class="free">sj</span><span class="main">)</span> <span class="main">⟹</span>
  w_run_t <span class="free">args</span> <span class="free">tj</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">tj'</span><span class="main">,</span> <span class="free">x</span><span class="main">)</span> <span class="main">⟹</span> w_run_sub <span class="free">args</span> <span class="free">sj</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">sj'</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span> <span class="main">⟹</span>
  reach_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">x</span><span class="main">,</span> <span class="free">y</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">si</span><span class="main">,</span> <span class="free">ti</span><span class="main">,</span> Suc <span class="free">j</span><span class="main">,</span> <span class="free">tj'</span><span class="main">,</span> <span class="free">sj'</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> reach_sub_app<span class="main">)</span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">init_args</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'t</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'t</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> option<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'t</span> <span class="main">⇒</span> <span class="tfree">'d</span> option<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> option<span class="main">)</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'e</span> <span class="main">⇒</span> <span class="tfree">'b</span> option<span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> args"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init_args</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">init</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">run_t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">read_t</span></span></span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">run_sub</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">read_sub</span></span></span><span class="main">)</span> <span class="main">=</span>
  <span class="main">⦇</span>w_init <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span><span class="main">,</span> w_step <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span><span class="main">,</span> w_accept <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span><span class="main">,</span> w_run_t <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">run_t</span></span></span><span class="main">,</span> w_read_t <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">read_t</span></span></span><span class="main">,</span>
  w_run_sub <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">run_sub</span></span></span><span class="main">,</span> w_read_sub <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">read_sub</span></span></span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">init_window</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> args <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> window"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">init_window</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="main">=</span> <span class="main">⦇</span>w_st <span class="main">=</span> Mapping.empty<span class="main">,</span> w_ac <span class="main">=</span> Mapping.empty<span class="main">,</span>
  w_i <span class="main">=</span> <span class="main">0</span><span class="main">,</span> w_ti <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span><span class="main">,</span> w_si <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">,</span> w_j <span class="main">=</span> <span class="main">0</span><span class="main">,</span> w_tj <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span><span class="main">,</span> w_sj <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span><span class="main">,</span>
  w_s <span class="main">=</span><span class="main">[</span><span class="main">(</span>w_init <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">,</span> <span class="main">(</span>w_init <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">,</span> None<span class="main">)</span><span class="main">)</span><span class="main">]</span><span class="main">,</span> w_e <span class="main">=</span> <span class="main">[]</span><span class="main">⦈</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">valid_window</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">::</span> timestamp<span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> args <span class="main">⇒</span> <span class="tfree">'t</span> <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">)</span> list <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> window <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">valid_window</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">⟷</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">init</span> <span class="main">=</span> w_init <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">;</span> <span class="bound">step</span> <span class="main">=</span> w_step <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">;</span> <span class="bound">accept</span> <span class="main">=</span> w_accept <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">;</span>
    <span class="bound">run_t</span> <span class="main">=</span> w_run_t <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">;</span> <span class="bound">run_sub</span> <span class="main">=</span> w_run_sub <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">;</span>
    <span class="bound">st</span> <span class="main">=</span> w_st <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">ac</span> <span class="main">=</span> w_ac <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span>
    <span class="bound">i</span> <span class="main">=</span> w_i <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">ti</span> <span class="main">=</span> w_ti <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">si</span> <span class="main">=</span> w_si <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">j</span> <span class="main">=</span> w_j <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">tj</span> <span class="main">=</span> w_tj <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">sj</span> <span class="main">=</span> w_sj <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span>
    <span class="bound">s</span> <span class="main">=</span> w_s <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">e</span> <span class="main">=</span> w_e <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span>reach_window <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">ti</span><span class="main">,</span> <span class="bound">si</span><span class="main">,</span> <span class="bound">j</span><span class="main">,</span> <span class="bound">tj</span><span class="main">,</span> <span class="bound">sj</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">∧</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">⟶</span> ts_at <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">i</span> <span class="main">≤</span> ts_at <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">j</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="bound">ac</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="bound">accept</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">q</span><span class="main">.</span> mmap_lookup <span class="bound">e</span> <span class="bound">q</span> <span class="main">=</span> sup_leadsto <span class="bound">init</span> <span class="bound">step</span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">q</span><span class="main">)</span> <span class="main">∧</span> distinct <span class="main">(</span>map fst <span class="bound">e</span><span class="main">)</span> <span class="main">∧</span>
    valid_s <span class="bound">init</span> <span class="bound">step</span> <span class="bound">st</span> <span class="bound">accept</span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="bound">i</span> <span class="bound">i</span> <span class="bound">j</span> <span class="bound">s</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_init_window<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">[]</span> <span class="main">(</span>init_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_def mmap_keys_def mmap_lookup_def sup_leadsto_def
      valid_s_def steps_def sup_acc_def Mapping.lookup_empty
      <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> reach_sub.intros <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> steps_app_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">rho</span> <span class="main">⟹</span> steps <span class="free">step</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span>
  steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">rho</span>"</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> map_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"map <span class="main">(</span>bs_at <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> map <span class="main">(</span>bs_at <span class="free">rho</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bs_at_def nth_append<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> steps_def map_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> acc_app_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">&lt;</span> length <span class="free">rho</span> <span class="main">⟹</span> acc <span class="free">step</span> <span class="free">accept</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span>
  acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> acc_def bs_at_def nth_append steps_app_cong<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sup_acc_app_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">rho</span> <span class="main">⟹</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span>
  sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sup_acc_def Let_def ts_at_def nth_append acc_app_cong<span class="main">)</span>
     <span class="main">(</span><span class="operator">smt</span> Collect_cong acc_app_cong less_le_trans<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sup_acc_concat_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">rho</span> <span class="main">⟹</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="free">rho'</span><span class="main">)</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span>
  sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">rho'</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> rev_induct<span class="main">)</span>
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> append.assoc le_add1 le_trans length_append sup_acc_app_cong<span class="main">)</span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> sup_leadsto_app_cong<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">≤</span> length <span class="free">rho</span> <span class="main">⟹</span>
  sup_leadsto <span class="free">init</span> <span class="free">step</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">i</span> <span class="free">j</span> <span class="free">q</span> <span class="main">=</span> sup_leadsto <span class="free">init</span> <span class="free">step</span> <span class="free">rho</span> <span class="free">i</span> <span class="free">j</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">≤</span> length <span class="free">rho</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L''</span> <span class="main">=</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> steps <span class="free">step</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="main">[</span><span class="free">x</span><span class="main">]</span><span class="main">)</span> <span class="free">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sup_leadsto_def L'_def L''_def ts_at_def nth_append steps_app_cong<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> chain_le<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">xs</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> <span class="main">::</span> timestamp list"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"chain_le <span class="free">xs</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">j</span> <span class="main">&lt;</span> length <span class="free">xs</span> <span class="main">⟹</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">i</span> <span class="main">≤</span> <span class="free">xs</span> <span class="main">!</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">xs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> chain_le.induct<span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>chain_le_cons <span class="skolem">y</span> <span class="skolem">xs</span> <span class="skolem">x</span><span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">i</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> 0
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> chain_le_cons
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">j</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> le_add1 le_add_same_cancel1 le_less less_le_trans nth_Cons_0<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> steps_refl<span class="main">[</span><span class="operator">simp</span><span class="main">]</span><span class="main">:</span> <span class="quoted"><span class="quoted">"steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> steps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> steps_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span>
  steps <span class="free">step</span> <span class="free">rho</span> <span class="main">(</span><span class="free">step</span> <span class="free">q</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>Suc <span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> steps_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> upt_rec<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> steps_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span>
  <span class="free">step</span> <span class="main">(</span>steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> steps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> steps_appE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> Suc <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">q''</span><span class="main">.</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="bound">q''</span> <span class="main">∧</span> <span class="free">q'</span> <span class="main">=</span> <span class="free">step</span> <span class="bound">q''</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> steps_def sub_bs.simps <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> steps_comp<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">q'</span> <span class="main">⟹</span>
  steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q'</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q''</span> <span class="main">⟹</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q''</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span> <span class="main">=</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q'</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q''</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> range_app<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span> <span class="main">=</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> le_Suc_ex upt_add_eq_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q'</span> <span class="main">=</span> foldl <span class="free">step</span> <span class="free">q</span> <span class="main">(</span>map <span class="main">(</span>bs_at <span class="free">rho</span><span class="main">)</span> <span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> steps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q''</span> <span class="main">=</span> foldl <span class="free">step</span> <span class="free">q'</span> <span class="main">(</span>map <span class="main">(</span>bs_at <span class="free">rho</span><span class="main">)</span> <span class="main">[</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> steps_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">q''</span> <span class="main">=</span> foldl <span class="free">step</span> <span class="free">q</span> <span class="main">(</span>map <span class="main">(</span>bs_at <span class="free">rho</span><span class="main">)</span> <span class="main">(</span><span class="main">[</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">l</span><span class="main">]</span> <span class="main">@</span> <span class="main">[</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">]</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> steps_def range_app <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sup_acc_SomeI<span class="main">:</span> <span class="quoted"><span class="quoted">"acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">tp</span><span class="main">.</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Some <span class="main">(</span>ts_at <span class="free">rho</span> <span class="bound">tp</span><span class="main">,</span> <span class="bound">tp</span><span class="main">)</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">≤</span> <span class="bound">tp</span> <span class="main">∧</span> <span class="bound">tp</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> L_props<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> L_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">tp</span><span class="main">.</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Some <span class="main">(</span>ts_at <span class="free">rho</span> <span class="bound">tp</span><span class="main">,</span> <span class="bound">tp</span><span class="main">)</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">≤</span> <span class="bound">tp</span> <span class="main">∧</span> <span class="bound">tp</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L_def L_props
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_def<span class="main">)</span>
       <span class="main">(</span><span class="operator">smt</span> L_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> L_props<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Max_ge Max_in mem_Collect_eq<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sup_acc_Some_ts<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ts</span><span class="main">,</span> <span class="free">tp</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">ts</span> <span class="main">=</span> ts_at <span class="free">rho</span> <span class="free">tp</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sup_acc_SomeE<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ts</span><span class="main">,</span> <span class="free">tp</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">tp</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span> <span class="main">∧</span> acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">tp</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ts</span><span class="main">,</span> <span class="free">tp</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span>  <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> L_props<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"Max <span class="skolem">L</span> <span class="main">=</span> <span class="free">tp</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L_def <span class="keyword1"><span class="command">using</span></span> assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_in<span class="main">[</span><span class="operator">OF</span> L_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> L_props<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> L_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sup_acc_NoneE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span> <span class="main">⟹</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> None <span class="main">⟹</span>
  <span class="main">¬</span>acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sup_acc_same<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">i</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sup_acc_None_restrict<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> None <span class="main">⟹</span>
  sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span><span class="free">step</span> <span class="free">q</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">using</span></span> steps_split
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_def Let_def acc_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
     <span class="main">(</span><span class="operator">smt</span> Suc_leD Suc_le_lessD steps_split<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sup_acc_ext_idle<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="main">¬</span>acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
  sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> L_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L_def L'_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> less_antisym <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L_def L'_def L_L' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sup_acc_comp_Some_ge<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">tp</span> <span class="main">≥</span> <span class="free">l</span> <span class="main">⟹</span>
  sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span>steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span> <span class="free">j</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ts</span><span class="main">,</span> <span class="free">tp</span><span class="main">)</span> <span class="main">⟹</span>
  sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span>steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span>steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span> <span class="free">j</span> <span class="main">=</span>
    Some <span class="main">(</span><span class="free">ts</span><span class="main">,</span> <span class="free">tp</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">tp</span> <span class="main">≥</span> <span class="free">l</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">l'</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">l</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span>steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="bound">l'</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> L'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">tp</span> <span class="main">=</span> Max <span class="skolem">L'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">ts</span> <span class="main">=</span> ts_at <span class="free">rho</span> <span class="free">tp</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> L'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> tp_in_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tp</span> <span class="main">∈</span> <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_in<span class="main">[</span><span class="operator">OF</span> L'_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> L'_props<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> tp_in_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">tp</span> <span class="main">∈</span> <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L_def L'_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> steps_comp<span class="main">[</span><span class="operator">OF</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">rho</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> acc_def<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> steps_comp
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">metis</span>
  <span class="keyword1"><span class="command">have</span></span> L_props<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L_def tp_in_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l'</span><span class="main">.</span> <span class="bound">l'</span> <span class="main">∈</span> <span class="skolem">L</span> <span class="main">⟹</span> <span class="bound">l'</span> <span class="main">≤</span> <span class="free">tp</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l'</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> <span class="skolem">L</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">≤</span> <span class="free">tp</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>4<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> <span class="skolem">L'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> assm
        <span class="keyword1"><span class="command">unfolding</span></span> L_def L'_def
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> acc_def<span class="main">)</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> assms<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> not_le steps_comp<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> Max_eq_iff<span class="main">[</span><span class="operator">OF</span> L'_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> L'_props<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="skolem">L</span> <span class="main">=</span> <span class="free">tp</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_eq_iff<span class="main">[</span><span class="operator">OF</span> L_props<span class="main">]</span> tp_in_L <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ts</span><span class="main">,</span> <span class="free">tp</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L_def L_props<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> L'_props<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span>steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sup_acc_comp_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">l</span> <span class="main">⟹</span> <span class="free">l</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span>
  sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span>steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span><span class="main">)</span> <span class="free">l</span> <span class="free">j</span> <span class="main">=</span> None <span class="main">⟹</span>
  sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">l</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">-</span> <span class="free">l</span>"</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">l</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Suc <span class="skolem">n</span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> i_lt_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> l_lt_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span>acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sup_acc_NoneE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="skolem">l</span></span> <span class="quoted"><span class="free">j</span></span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">rho</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="skolem">l</span><span class="main">)</span>"</span></span><span class="main">]</span> Suc
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> acc_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sup_acc_ext_idle<span class="main">[</span><span class="operator">OF</span> Suc<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span>steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">using</span></span> sup_acc_None_restrict<span class="main">[</span><span class="operator">OF</span> Suc<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">]</span> steps_app<span class="main">[</span><span class="operator">OF</span> Suc<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">rho</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Suc<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">+</span> <span class="main">1</span>"</span></span><span class="main">]</span> Suc<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">,</span>5<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_same<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sup_acc_ext<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">⟹</span>
  sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>ts_at <span class="free">rho</span> <span class="free">j</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">}</span><span class="main">.</span> acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> j_in_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">j</span> <span class="main">∈</span> <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> L'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> j_is_Max<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="skolem">L'</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_eq_iff<span class="main">[</span><span class="operator">OF</span> j_in_L'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> j_in_L'<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L'_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>ts_at <span class="free">rho</span> <span class="free">j</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L'_def j_is_Max j_in_L'<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sup_acc_None<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> None <span class="main">⟹</span>
  sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span><span class="free">step</span> <span class="free">q</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">using</span></span> steps_split<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">rho</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_def Let_def acc_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> sup_acc_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ts</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span>
  sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span><span class="free">step</span> <span class="free">q</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ts</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span><span class="free">step</span> <span class="free">q</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span> <span class="main">≠</span> None"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span>"</span></span>
    <span class="quoted"><span class="quoted">"acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span><span class="free">step</span> <span class="free">q</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> L'_props<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"Max <span class="skolem">L'</span> <span class="main">=</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_def L'_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> i_lt_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> l_def<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">from</span></span> l_def <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L'_def acc_def <span class="keyword1"><span class="command">using</span></span> steps_split<span class="main">[</span><span class="operator">OF</span> i_lt_l<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">rho</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
    <span class="keyword1"><span class="command">using</span></span> l_def<span class="main">(</span>1<span class="main">)</span> L'_props Max_ge i_lt_l not_le <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sup_acc_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> <span class="free">i</span> <span class="main">≠</span> <span class="free">l</span> <span class="main">⟹</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ts</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span> <span class="main">⟹</span>
  sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span><span class="free">step</span> <span class="free">q</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≠</span> <span class="free">l</span>"</span></span> <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ts</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="main">{</span>Suc <span class="free">i</span><span class="main">..&lt;</span><span class="free">j</span><span class="main">}</span><span class="main">.</span> acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span><span class="free">step</span> <span class="free">q</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">from</span></span> assms<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> L_props<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">=</span> Max <span class="skolem">L</span>"</span></span>
    <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span> Some <span class="main">(</span>ts_at <span class="free">rho</span> <span class="free">l</span><span class="main">,</span> <span class="free">l</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_def L_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> l_in_L<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="skolem">L</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_in<span class="main">[</span><span class="operator">OF</span> L_props<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> L_props<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> i_lt_l<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> l_in_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">∈</span> <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> steps_split<span class="main">[</span><span class="operator">OF</span> i_lt_l<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">rho</span></span> <span class="quoted"><span class="free">q</span></span><span class="main">]</span> l_in_L assms<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> L_def L'_def acc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">l'</span><span class="main">.</span> <span class="bound">l'</span> <span class="main">∈</span> <span class="skolem">L'</span> <span class="main">⟹</span> <span class="bound">l'</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">l'</span>
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">have</span></span> i_lt_l'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="skolem">l'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> L'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">∈</span> <span class="skolem">L</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> steps_split<span class="main">[</span><span class="operator">OF</span> i_lt_l'<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">rho</span></span><span class="main">]</span> assms <span class="keyword1"><span class="command">unfolding</span></span> L_def L'_def acc_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">≤</span> <span class="free">l</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> L_props <span class="keyword1"><span class="command">by</span></span> <span class="operator">simp</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> l_sup_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="skolem">L'</span> <span class="main">=</span> <span class="free">l</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_eq_iff<span class="main">[</span><span class="operator">OF</span> l_in_L'<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> l_in_L'<span class="main">(</span>3<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span> <span class="main">=</span>
    sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span><span class="free">step</span> <span class="free">q</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L_props<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> sup_acc_def Let_def
    <span class="keyword1"><span class="command">using</span></span> L'_def l_in_L'<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> L_props
    <span class="keyword1"><span class="command">unfolding</span></span> Suc_eq_plus1 <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sup_leadsto_idle<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span> <span class="main">⟹</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">init</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">≠</span> <span class="free">q</span> <span class="main">⟹</span>
  sup_leadsto <span class="free">init</span> <span class="free">step</span> <span class="free">rho</span> <span class="free">i</span> <span class="free">j</span> <span class="free">q</span> <span class="main">=</span> sup_leadsto <span class="free">init</span> <span class="free">step</span> <span class="free">rho</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span> <span class="free">q</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">step</span> <span class="free">rho</span> <span class="free">init</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">≠</span> <span class="free">q</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">∧</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> L_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L_def L'_def <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> less_antisym
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sup_leadsto <span class="free">init</span> <span class="free">step</span> <span class="free">rho</span> <span class="free">i</span> <span class="free">j</span> <span class="free">q</span> <span class="main">=</span> sup_leadsto <span class="free">init</span> <span class="free">step</span> <span class="free">rho</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span> <span class="free">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L_def L'_def L_L'
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_leadsto_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sup_leadsto_SomeI<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">⟹</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">init</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> sup_leadsto <span class="free">init</span> <span class="free">step</span> <span class="free">rho</span> <span class="free">i</span> <span class="free">j</span> <span class="free">q</span> <span class="main">=</span> Some <span class="main">(</span>ts_at <span class="free">rho</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">≤</span> <span class="bound">l'</span> <span class="main">∧</span> <span class="bound">l'</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">l</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">step</span> <span class="free">rho</span> <span class="free">init</span> <span class="main">(</span><span class="free">l</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> fin_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> L_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> L'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_leadsto_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="skolem">L'</span> <span class="main">∈</span> <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound">l'</span><span class="main">.</span> sup_leadsto <span class="free">init</span> <span class="free">step</span> <span class="free">rho</span> <span class="free">i</span> <span class="free">j</span> <span class="free">q</span> <span class="main">=</span> Some <span class="main">(</span>ts_at <span class="free">rho</span> <span class="bound">l'</span><span class="main">)</span> <span class="main">∧</span> <span class="free">l</span> <span class="main">≤</span> <span class="bound">l'</span> <span class="main">∧</span> <span class="bound">l'</span> <span class="main">&lt;</span> <span class="free">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> L'_def L_nonempty assms
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_leadsto_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sup_leadsto_SomeE<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span> <span class="main">⟹</span> sup_leadsto <span class="free">init</span> <span class="free">step</span> <span class="free">rho</span> <span class="free">i</span> <span class="free">j</span> <span class="free">q</span> <span class="main">=</span> Some <span class="free">ts</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound"><span class="bound">l</span></span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">.</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span> <span class="main">∧</span> ts_at <span class="free">rho</span> <span class="bound">l</span> <span class="main">=</span> <span class="free">ts</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"sup_leadsto <span class="free">init</span> <span class="free">step</span> <span class="free">rho</span> <span class="free">i</span> <span class="free">j</span> <span class="free">q</span> <span class="main">=</span> Some <span class="free">ts</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="free">i</span> <span class="main">∧</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> fin_L'<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L'_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> L_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L'</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">unfolding</span></span> L'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_leadsto_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="skolem">L'</span> <span class="main">∈</span> <span class="skolem">L'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Max_in <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="main">∃</span><span class="bound"><span class="bound">l</span></span> <span class="main">&lt;</span> <span class="free">i</span><span class="main">.</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q</span> <span class="main">∧</span> ts_at <span class="free">rho</span> <span class="bound">l</span> <span class="main">=</span> <span class="free">ts</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>2<span class="main">)</span> L'_def
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_leadsto_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">using</span></span> <span class="quoted"><span class="quoted">‹Max <span class="skolem">L'</span> <span class="main">∈</span> <span class="skolem">L'</span>›</span></span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_keys_dest<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> mmap_keys <span class="free">f</span> <span class="main">⟹</span> <span class="main">∃</span><span class="bound">y</span><span class="main">.</span> mmap_lookup <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> Some <span class="bound">y</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mmap_keys_def mmap_lookup_def weak_map_of_SomeI<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_keys_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="free">f</span> <span class="free">x</span> <span class="main">≠</span> None <span class="main">⟹</span> <span class="free">x</span> <span class="main">∈</span> mmap_keys <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mmap_keys_def mmap_lookup_def<span class="main">)</span>
     <span class="main">(</span><span class="operator">metis</span> map_of_eq_None_iff option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_not_keys_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> None <span class="main">⟹</span> <span class="free">x</span> <span class="main">∉</span> mmap_keys <span class="free">f</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mmap_lookup_def mmap_keys_def
  <span class="keyword1"><span class="command">using</span></span> weak_map_of_SomeI <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> Mapping_lookup_None_intro<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∉</span> mmap_keys <span class="free">f</span> <span class="main">⟹</span> mmap_lookup <span class="free">f</span> <span class="free">x</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mmap_lookup_def mmap_keys_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> map_of_eq_None_iff<span class="main">)</span>

<span class="keyword1"><span class="command">primrec</span></span> <span class="entity">mmap_combine</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'key</span> <span class="main">⇒</span> <span class="tfree">'val</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'val</span> <span class="main">⇒</span> <span class="tfree">'val</span> <span class="main">⇒</span> <span class="tfree">'val</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'key</span> <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span> list <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'key</span> <span class="main">×</span> <span class="tfree">'val</span><span class="main">)</span> list"</span></span>
  <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mmap_combine</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">[</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span><span class="main">]</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmap_combine</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">k'</span><span class="main">,</span> <span class="bound">v'</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="keyword1">if</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="main">=</span> <span class="bound">k'</span> <span class="keyword1">then</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">k</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">v'</span> <span class="free"><span class="bound"><span class="entity">v</span></span></span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">p</span></span></span> <span class="main">#</span> <span class="free">mmap_combine</span> <span class="free"><span class="bound"><span class="entity">k</span></span></span> <span class="free"><span class="bound"><span class="entity">v</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">ps</span></span></span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mmap_combine_distinct_set<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
  distinct <span class="main">(</span>map fst <span class="main">(</span>mmap_combine <span class="free">k</span> <span class="free">v</span> <span class="free">c</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  set <span class="main">(</span>map fst <span class="main">(</span>mmap_combine <span class="free">k</span> <span class="free">v</span> <span class="free">c</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="free">r</span><span class="main">)</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="operator">force</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mmap_combine_lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> mmap_lookup <span class="main">(</span>mmap_combine <span class="free">k</span> <span class="free">v</span> <span class="free">c</span> <span class="free">r</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="free">z</span> <span class="keyword1">then</span> <span class="main">(</span><span class="keyword1">case</span> mmap_lookup <span class="free">r</span> <span class="free">k</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Some <span class="free">v</span> <span class="main">|</span> Some <span class="bound">v'</span> <span class="main">⇒</span> Some <span class="main">(</span><span class="free">c</span> <span class="bound">v'</span> <span class="free">v</span><span class="main">)</span><span class="main">)</span>
  <span class="keyword1">else</span> mmap_lookup <span class="free">r</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> eq_key_imp_eq_value
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_lookup_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mmap_fold</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> mmap <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> mmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> mmap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mmap_fold</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="bound">r</span> <span class="bound">p</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">p</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⇒</span> mmap_combine <span class="bound">k</span> <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">r</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mmap_fold'</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> mmap <span class="main">⇒</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">×</span> <span class="tfree">'e</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">×</span> <span class="tfree">'e</span><span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> <span class="tfree">'d</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> mmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> mmap <span class="main">×</span> <span class="tfree">'e</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mmap_fold'</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">e</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="free"><span class="bound"><span class="entity">r</span></span></span> <span class="main">=</span> foldl <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">r</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="bound">p</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">,</span> <span class="bound">e'</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span>mmap_combine <span class="bound">k</span> <span class="bound">v</span> <span class="free"><span class="bound"><span class="entity">c</span></span></span> <span class="bound">r</span><span class="main">,</span> <span class="bound">e'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">r</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">e</span></span></span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mmap_fold'_eq<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_fold' <span class="free">m</span> <span class="free">e</span> <span class="free">f'</span> <span class="free">c</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">m'</span><span class="main">,</span> <span class="free">e'</span><span class="main">)</span> <span class="main">⟹</span> <span class="free">P</span> <span class="free">e</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">p</span> <span class="bound">e</span> <span class="bound">p'</span> <span class="bound">e'</span><span class="main">.</span> <span class="free">P</span> <span class="bound">e</span> <span class="main">⟹</span> <span class="free">f'</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">e'</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">p'</span> <span class="main">=</span> <span class="free">f</span> <span class="bound">p</span> <span class="main">∧</span> <span class="free">P</span> <span class="bound">e'</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">m'</span> <span class="main">=</span> mmap_fold <span class="free">m</span> <span class="free">f</span> <span class="free">c</span> <span class="free">r</span> <span class="main">∧</span> <span class="free">P</span> <span class="free">e'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">e</span></span> <span class="quoted"><span class="free">r</span></span> <span class="quoted"><span class="free">m'</span></span> <span class="quoted"><span class="free">e'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">m</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">e''</span></span> <span class="keyword2"><span class="keyword">where</span></span> kv_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span><span class="main">,</span> <span class="skolem">e''</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">P</span> <span class="skolem">e''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="free">f'</span> <span class="main">(</span><span class="skolem">p</span><span class="main">,</span> <span class="skolem">e</span><span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> mmap_fold<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_fold <span class="main">(</span><span class="skolem">p</span> <span class="main">#</span> <span class="skolem">m</span><span class="main">)</span> <span class="free">f</span> <span class="free">c</span> <span class="skolem">r</span> <span class="main">=</span> mmap_fold <span class="skolem">m</span> <span class="free">f</span> <span class="free">c</span> <span class="main">(</span>mmap_combine <span class="skolem">k</span> <span class="skolem">v</span> <span class="free">c</span> <span class="skolem">r</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_fold_def kv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> mmap_fold'<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_fold' <span class="skolem">m</span> <span class="skolem">e''</span> <span class="free">f'</span> <span class="free">c</span> <span class="main">(</span>mmap_combine <span class="skolem">k</span> <span class="skolem">v</span> <span class="free">c</span> <span class="skolem">r</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">m'</span><span class="main">,</span> <span class="skolem">e'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_fold'_def kv_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> mmap_fold' kv_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> Cons<span class="main"><span class="main">(</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> mmap_fold
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_fold_def mmap_fold'_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> foldl_mmap_combine_distinct_set<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span>
  distinct <span class="main">(</span>map fst <span class="main">(</span>mmap_fold <span class="free">m</span> <span class="free">f</span> <span class="free">c</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span>
  set <span class="main">(</span>map fst <span class="main">(</span>mmap_fold <span class="free">m</span> <span class="free">f</span> <span class="free">c</span> <span class="free">r</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> set <span class="main">(</span>map fst <span class="free">r</span><span class="main">)</span> <span class="main">∪</span> set <span class="main">(</span>map <span class="main">(</span>fst <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> mmap_combine_distinct_set
   <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_fold_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">force</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> Un_iff fst_conv imageI insert_iff<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> mk_disjoint_insert
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="operator">fastforce</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>

<span class="keyword1"><span class="command">lemma</span></span> mmap_fold_lookup_rec<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">r</span><span class="main">)</span> <span class="main">⟹</span> mmap_lookup <span class="main">(</span>mmap_fold <span class="free">m</span> <span class="free">f</span> <span class="free">c</span> <span class="free">r</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> map <span class="main">(</span>snd <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> mmap_lookup <span class="free">r</span> <span class="free">z</span>
  <span class="main">|</span> <span class="bound">v</span> <span class="main">#</span> <span class="bound">vs</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> mmap_lookup <span class="free">r</span> <span class="free">z</span> <span class="keyword1">of</span> None <span class="main">⇒</span> Some <span class="main">(</span>foldl <span class="free">c</span> <span class="bound">v</span> <span class="bound">vs</span><span class="main">)</span>
    <span class="main">|</span> Some <span class="bound">w</span> <span class="main">⇒</span> Some <span class="main">(</span>foldl <span class="free">c</span> <span class="bound">w</span> <span class="main">(</span><span class="bound">v</span> <span class="main">#</span> <span class="bound">vs</span><span class="main">)</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">r</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">p</span> <span class="skolem">ps</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">k</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="keyword2"><span class="keyword">where</span></span> kv_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">k</span><span class="main">,</span> <span class="skolem">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="main">(</span>mmap_combine <span class="skolem">k</span> <span class="skolem">v</span> <span class="free">c</span> <span class="skolem">r</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mmap_combine_distinct_set<span class="main">[</span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> distinct<span class="main">,</span> <span class="operator">unfolded</span> mmap_combine_lookup<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Cons<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_lookup_def kv_def mmap_fold_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_fold_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mmap_fold_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>map fst <span class="main">(</span>mmap_fold <span class="free">m</span> <span class="free">f</span> <span class="free">c</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> foldl_mmap_combine_distinct_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>

<span class="keyword1"><span class="command">lemma</span></span> mmap_fold_set<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span>
  set <span class="main">(</span>map fst <span class="main">(</span>mmap_fold <span class="free">m</span> <span class="free">f</span> <span class="free">c</span> <span class="main">[]</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>fst <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">`</span> set <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> foldl_mmap_combine_distinct_set<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>

<span class="keyword1"><span class="command">lemma</span></span> mmap_lookup_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="main">[]</span> <span class="free">z</span> <span class="main">=</span> None"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_lookup_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mmap_fold_lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> mmap_lookup <span class="main">(</span>mmap_fold <span class="free">m</span> <span class="free">f</span> <span class="free">c</span> <span class="main">[]</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span>
  <span class="main">(</span><span class="keyword1">case</span> map <span class="main">(</span>snd <span class="main">∘</span> <span class="free">f</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> fst <span class="main">(</span><span class="free">f</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span> <span class="free">z</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">[]</span> <span class="main">⇒</span> None
  <span class="main">|</span> <span class="bound">v</span> <span class="main">#</span> <span class="bound">vs</span> <span class="main">⇒</span> Some <span class="main">(</span>foldl <span class="free">c</span> <span class="bound">v</span> <span class="bound">vs</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mmap_fold_lookup_rec<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">[]</span>"</span></span> <span class="main">_</span> <span class="quoted"><span class="free">f</span></span> <span class="quoted"><span class="free">c</span></span><span class="main">]</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_lookup_empty <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">fold_sup</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">::</span> timestamp<span class="main">)</span> mmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">)</span> mmap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">fold_sup</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="main">=</span> mmap_fold <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> sup <span class="main">[]</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mmap_lookup_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> <span class="main">(</span><span class="free">k</span><span class="main">,</span> <span class="free">v</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">m</span> <span class="main">⟹</span>
  mmap_lookup <span class="free">m</span> <span class="free">k</span> <span class="main">=</span> Some <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_lookup_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_sup_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>map fst <span class="main">(</span>fold_sup <span class="free">m</span> <span class="free">f</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> mmap_fold_distinct
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fold_sup_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> fold_sup<span class="main">:</span>
  <span class="keyword2"><span class="keyword">fixes</span></span> <span class="free">v</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'d</span> <span class="main">::</span> timestamp"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"foldl sup <span class="free">v</span> <span class="free">vs</span> <span class="main">=</span> fold sup <span class="free">vs</span> <span class="free">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">v</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> sup.commute<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_fold_sup<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">m</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="main">(</span>fold_sup <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="bound">Z</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> mmap_keys <span class="free">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">z</span><span class="main">}</span> <span class="keyword1">in</span>
    <span class="keyword1">if</span> <span class="bound">Z</span> <span class="main">=</span> <span class="main">{}</span> <span class="keyword1">then</span> None <span class="keyword1">else</span> Some <span class="main">(</span>Sup_fin <span class="main">(</span><span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="free">m</span><span class="main">)</span> <span class="main">`</span> <span class="bound">Z</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> mmap_keys <span class="free">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">z</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> True
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∉</span> mmap_keys <span class="main">(</span>mmap_fold <span class="free">m</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> sup <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> True<span class="main">[</span><span class="operator">unfolded</span> mmap_keys_def<span class="main">]</span> mmap_fold_set<span class="main">[</span><span class="operator">OF</span> distinct<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_keys_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="main">(</span>fold_sup <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> None"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fold_sup_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> Mapping_keys_intro<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> True
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">next</span></span>
  <span class="keyword3"><span class="command">case</span></span> False
  <span class="keyword1"><span class="command">have</span></span> z_in_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> mmap_keys <span class="main">(</span>mmap_fold <span class="free">m</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> sup <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> False<span class="main">[</span><span class="operator">unfolded</span> mmap_keys_def<span class="main">]</span> mmap_fold_set<span class="main">[</span><span class="operator">OF</span> distinct<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_keys_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> vs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="main">(</span>fold_sup <span class="free">m</span> <span class="free">f</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> Some <span class="main">(</span>foldl sup <span class="skolem">v</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">#</span> <span class="skolem">vs</span> <span class="main">=</span> map snd <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="free">f</span> <span class="bound">k</span> <span class="main">=</span> <span class="free">z</span><span class="main">)</span> <span class="free">m</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mmap_fold_lookup<span class="main">[</span><span class="operator">OF</span> distinct<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">f</span> <span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted">sup</span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span>
      Mapping_keys_dest<span class="main">[</span><span class="operator">OF</span> z_in_keys<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fold_sup_def mmap_keys_def comp_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="free">m</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> mmap_keys <span class="free">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">z</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> mmap_keys <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> vs_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mmap_keys_def rev_image_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="free">m</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> mmap_keys <span class="free">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">z</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> mmap_lookup_distinct<span class="main">[</span><span class="operator">OF</span> distinct x_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> <span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="free">m</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> mmap_keys <span class="free">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> x_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> mmap_keys <span class="free">m</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">f</span> <span class="skolem">x</span> <span class="main">=</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">w</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">m</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mmap_lookup_distinct<span class="main">[</span><span class="operator">OF</span> distinct<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro distinct mmap_lookup_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> x_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vs_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl sup <span class="skolem">v</span> <span class="skolem">vs</span> <span class="main">=</span> Sup_fin <span class="main">(</span><span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="free">m</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> mmap_keys <span class="free">m</span><span class="main">.</span> <span class="free">f</span> <span class="bound">x</span> <span class="main">=</span> <span class="free">z</span><span class="main">}</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> fold_sup
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Sup_fin.set_eq_fold<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> False
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mmap_map</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> mmap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mmap_map</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="free"><span class="bound"><span class="entity">m</span></span></span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">f</span></span></span> <span class="bound">k</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="free"><span class="bound"><span class="entity">m</span></span></span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mmap_map_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_keys <span class="main">(</span>mmap_map <span class="free">f</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> mmap_keys <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_map_def mmap_keys_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mmap_map_fst<span class="main">:</span> <span class="quoted"><span class="quoted">"map fst <span class="main">(</span>mmap_map <span class="free">f</span> <span class="free">m</span><span class="main">)</span> <span class="main">=</span> map fst <span class="free">m</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cstep</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> mapping <span class="main">⇒</span>
  <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> mapping<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cstep</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">res</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">res</span><span class="main">,</span> Mapping.update <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="bound">res</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">cac</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> bool<span class="main">)</span> mapping <span class="main">⇒</span>
  <span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span>bool <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> bool<span class="main">)</span> mapping<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">cac</span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">ac</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> Mapping.lookup <span class="free"><span class="bound"><span class="entity">ac</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">res</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">q</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="bound">res</span><span class="main">,</span> Mapping.update <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">)</span> <span class="bound">res</span> <span class="free"><span class="bound"><span class="entity">ac</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">v</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ac</span></span></span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">fun</span></span> <span class="entity">mmap_fold_s</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> mapping <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> bool<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> bool<span class="main">)</span> mapping <span class="main">⇒</span>
  <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'d</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> nat<span class="main">)</span> option<span class="main">)</span> mmap <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> nat<span class="main">)</span> option<span class="main">)</span> mmap <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> mapping <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> bool<span class="main">)</span> mapping<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mmap_fold_s</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">ac</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="main">[]</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">st</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">ac</span></span></span><span class="main">)</span>"</span></span>
<span class="main">|</span> <span class="quoted"><span class="quoted">"<span class="free">mmap_fold_s</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">ac</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">q'</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tstp</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="free"><span class="bound"><span class="entity">qbss</span></span></span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span><span class="keyword1">let</span> <span class="main">(</span><span class="bound">q''</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> cstep <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">;</span>
         <span class="main">(</span><span class="bound">β</span><span class="main">,</span> <span class="bound">ac'</span><span class="main">)</span> <span class="main">=</span> cac <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">ac</span></span></span> <span class="free"><span class="bound"><span class="entity">q'</span></span></span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span><span class="main">;</span>
         <span class="main">(</span><span class="bound">qbss'</span><span class="main">,</span> <span class="bound">st''</span><span class="main">,</span> <span class="bound">ac''</span><span class="main">)</span> <span class="main">=</span> <span class="free">mmap_fold_s</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="bound">st'</span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="bound">ac'</span> <span class="free"><span class="bound"><span class="entity">bs</span></span></span> <span class="free"><span class="bound"><span class="entity">t</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">qbss</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="main">(</span><span class="free"><span class="bound"><span class="entity">q</span></span></span><span class="main">,</span> <span class="main">(</span><span class="bound">q''</span><span class="main">,</span> <span class="keyword1">if</span> <span class="bound">β</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free"><span class="bound"><span class="entity">t</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">)</span> <span class="keyword1">else</span> <span class="free"><span class="bound"><span class="entity">tstp</span></span></span><span class="main">)</span><span class="main">)</span> <span class="main">#</span> <span class="bound">qbss'</span><span class="main">,</span> <span class="bound">st''</span><span class="main">,</span> <span class="bound">ac''</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mmap_fold_s_sound<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_fold_s <span class="free">step</span> <span class="free">st</span> <span class="free">accept</span> <span class="free">ac</span> <span class="free">bs</span> <span class="free">t</span> <span class="free">j</span> <span class="free">qbss</span> <span class="main">=</span> <span class="main">(</span><span class="free">qbss'</span><span class="main">,</span> <span class="free">st'</span><span class="main">,</span> <span class="free">ac'</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">st</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">ac</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free">accept</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">⟹</span>
  <span class="free">qbss'</span> <span class="main">=</span> mmap_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">tstp</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">step</span> <span class="bound">q'</span> <span class="free">bs</span><span class="main">,</span> <span class="keyword1">if</span> <span class="free">accept</span> <span class="bound">q'</span> <span class="free">bs</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">tstp</span><span class="main">)</span><span class="main">)</span> <span class="free">qbss</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">st'</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">ac'</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free">accept</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">qbss</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="free">st</span></span> <span class="quoted"><span class="free">ac</span></span> <span class="quoted"><span class="free">qbss'</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Cons <span class="skolem">a</span> <span class="skolem">qbss</span><span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">tstp</span></span> <span class="keyword2"><span class="keyword">where</span></span> a_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">tstp</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">a</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="skolem"><span class="skolem">st''</span></span> <span class="keyword2"><span class="keyword">where</span></span> q''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"cstep <span class="free">step</span> <span class="skolem">st</span> <span class="skolem">q'</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q''</span><span class="main">,</span> <span class="skolem">st''</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">=</span> <span class="free">step</span> <span class="skolem">q'</span> <span class="free">bs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cstep <span class="free">step</span> <span class="skolem">st</span> <span class="skolem">q'</span> <span class="free">bs</span>"</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cstep_def Let_def option.case_eq_if <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="skolem"><span class="skolem">ac''</span></span> <span class="keyword2"><span class="keyword">where</span></span> b_def<span class="main">:</span> <span class="quoted"><span class="quoted">"cac <span class="free">accept</span> <span class="skolem">ac</span> <span class="skolem">q'</span> <span class="free">bs</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">b</span><span class="main">,</span> <span class="skolem">ac''</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> <span class="free">accept</span> <span class="skolem">q'</span> <span class="free">bs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"cac <span class="free">accept</span> <span class="skolem">ac</span> <span class="skolem">q'</span> <span class="free">bs</span>"</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cac_def Let_def option.case_eq_if <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">qbss''</span></span> <span class="keyword2"><span class="keyword">where</span></span> qbss''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_fold_s <span class="free">step</span> <span class="skolem">st''</span> <span class="free">accept</span> <span class="skolem">ac''</span> <span class="free">bs</span> <span class="free">t</span> <span class="free">j</span> <span class="skolem">qbss</span> <span class="main">=</span>
    <span class="main">(</span><span class="skolem">qbss''</span><span class="main">,</span> <span class="free">st'</span><span class="main">,</span> <span class="free">ac'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">qbss'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">q''</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">b</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="keyword1">else</span> <span class="skolem">tstp</span><span class="main">)</span> <span class="main">#</span> <span class="skolem">qbss''</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> a_def mmap_fold_s.simps q''_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> b_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ih<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">st''</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">a</span> <span class="main">⇒</span> <span class="free">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">a</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">ac''</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">a</span> <span class="main">⇒</span> <span class="free">accept</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">a</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> q''_def b_def Cons<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cstep_def cac_def Let_def Mapping.lookup_update' option.case_eq_if
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?case</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> Cons<span class="main">(</span>1<span class="main">)</span><span class="main">[</span><span class="operator">OF</span> qbss''_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> ih<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> a_def q''_def<span class="main">(</span>2<span class="main">)</span> b_def<span class="main">(</span>2<span class="main">)</span> qbss''_def<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_map_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adv_end</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">::</span> timestamp<span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> args <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> window <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> window"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">adv_end</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">step</span> <span class="main">=</span> w_step <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">;</span> <span class="bound">accept</span> <span class="main">=</span> w_accept <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">;</span>
    <span class="bound">run_t</span> <span class="main">=</span> w_run_t <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">;</span> <span class="bound">run_sub</span> <span class="main">=</span> w_run_sub <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">;</span> <span class="bound">st</span> <span class="main">=</span> w_st <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">ac</span> <span class="main">=</span> w_ac <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span>
    <span class="bound">j</span> <span class="main">=</span> w_j <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">tj</span> <span class="main">=</span> w_tj <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">sj</span> <span class="main">=</span> w_sj <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">s</span> <span class="main">=</span> w_s <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">e</span> <span class="main">=</span> w_e <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="bound">run_t</span> <span class="bound">tj</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">tj'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">run_sub</span> <span class="bound">sj</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">sj'</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">,</span> <span class="bound">ac'</span><span class="main">)</span> <span class="main">=</span> mmap_fold_s <span class="bound">step</span> <span class="bound">st</span> <span class="bound">accept</span> <span class="bound">ac</span> <span class="bound">bs</span> <span class="bound">t</span> <span class="bound">j</span> <span class="bound">s</span><span class="main">;</span>
      <span class="main">(</span><span class="bound">e'</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span> <span class="main">=</span> mmap_fold' <span class="bound">e</span> <span class="bound">st'</span>
        <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="bound">st</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> cstep <span class="bound">step</span> <span class="bound">st</span> <span class="bound">x</span> <span class="bound">bs</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span><span class="main">)</span> sup <span class="main">[]</span> <span class="keyword1">in</span>
      <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">⦇</span>w_st <span class="main">:=</span> <span class="bound">st''</span><span class="main">,</span> w_ac <span class="main">:=</span> <span class="bound">ac'</span><span class="main">,</span> w_j <span class="main">:=</span> Suc <span class="bound">j</span><span class="main">,</span> w_tj <span class="main">:=</span> <span class="bound">tj'</span><span class="main">,</span> w_sj <span class="main">:=</span> <span class="bound">sj'</span><span class="main">,</span> w_s <span class="main">:=</span> <span class="bound">s'</span><span class="main">,</span> w_e <span class="main">:=</span> <span class="bound">e'</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> map_values_lookup<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="main">(</span>mmap_map <span class="free">f</span> <span class="free">m</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> Some <span class="free">v'</span> <span class="main">⟹</span>
  <span class="main">∃</span><span class="bound">v</span><span class="main">.</span> mmap_lookup <span class="free">m</span> <span class="free">z</span> <span class="main">=</span> Some <span class="bound">v</span> <span class="main">∧</span> <span class="free">v'</span> <span class="main">=</span> <span class="free">f</span> <span class="free">z</span> <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">m</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_lookup_def mmap_map_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> acc_app<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">accept</span> <span class="free">q'</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span>ts_at <span class="free">rho</span> <span class="free">j</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span>Suc <span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">accept</span> <span class="main">(</span>steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="bound">l</span><span class="main">)</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">unfolding</span></span> L_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">{</span><span class="bound"><span class="bound">l</span></span> <span class="main">∈</span> <span class="main">{</span><span class="free">i</span><span class="main">..&lt;</span>Suc <span class="free">j</span><span class="main">}</span><span class="main">.</span> <span class="free">accept</span> <span class="main">(</span>steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="bound">l</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="bound">l</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> L_def<span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span> Max_eq_iff<span class="main">[</span><span class="operator">OF</span> nonempty<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">j</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> L_def <span class="keyword1"><span class="command">using</span></span> assms <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_def acc_def L_def<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> acc_app_idle<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">≤</span> <span class="free">j</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">step</span> <span class="free">rho</span> <span class="free">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="free">q'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">¬</span><span class="free">accept</span> <span class="free">q'</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="main">(</span><span class="free">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">q</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_acc_def Let_def acc_def <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> less_SucE<span class="main">)</span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_Suc_eq<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>

<span class="keyword1"><span class="command">lemma</span></span> sup_fin_closed<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="free">A</span> <span class="main">⟹</span> <span class="free">A</span> <span class="main">≠</span> <span class="main">{}</span> <span class="main">⟹</span>
  <span class="main">(</span><span class="main">⋀</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> <span class="bound">y</span> <span class="main">∈</span> <span class="free">A</span> <span class="main">⟹</span> sup <span class="bound">x</span> <span class="bound">y</span> <span class="main">∈</span> <span class="main">{</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">}</span><span class="main">)</span> <span class="main">⟹</span> <span class="keyword1">⨆<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub></span> <span class="free">A</span> <span class="main">∈</span> <span class="free">A</span>"</span></span>
  <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induct</span> <span class="quoted"><span class="free">A</span></span> <span class="quasi_keyword">rule</span><span class="main"><span class="main">:</span></span> finite.induct<span class="main">)</span>
  <span class="keyword1"><span class="command">using</span></span> Sup_fin.insert
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_adv_end<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="main">(</span>w_tj <span class="free">w</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">tj'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span> <span class="main">(</span>w_sj <span class="free">w</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">sj'</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">t'</span><span class="main">.</span> <span class="bound">t'</span> <span class="main">∈</span> set <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span> <span class="main">⟹</span> <span class="bound">t'</span> <span class="main">≤</span> <span class="free">t</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>adv_end <span class="free">args</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">init</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">init</span> <span class="main">=</span> w_init <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">step</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">step</span> <span class="main">=</span> w_step <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">accept</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">accept</span> <span class="main">=</span> w_accept <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">run_t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">run_t</span> <span class="main">=</span> w_run_t <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">run_sub</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">run_sub</span> <span class="main">=</span> w_run_sub <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> w_st <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ac</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ac</span> <span class="main">=</span> w_ac <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> w_i <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ti</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ti</span> <span class="main">=</span> w_ti <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">si</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">si</span> <span class="main">=</span> w_si <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> w_j <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj</span> <span class="main">=</span> w_tj <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sj</span> <span class="main">=</span> w_sj <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> w_s <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> w_e <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">ti</span><span class="main">,</span> <span class="skolem">si</span><span class="main">,</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">tj</span><span class="main">,</span> <span class="skolem">sj</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">rho</span> <span class="main">⟹</span> ts_at <span class="free">rho</span> <span class="bound">i</span> <span class="main">≤</span> ts_at <span class="free">rho</span> <span class="bound">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">st</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="skolem">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">ac</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="skolem">accept</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> mmap_lookup <span class="skolem">e</span> <span class="bound">q</span> <span class="main">=</span> sup_leadsto <span class="skolem">init</span> <span class="skolem">step</span> <span class="free">rho</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="bound">q</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"valid_s <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">st</span> <span class="skolem">accept</span> <span class="free">rho</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> valid_window_def valid_s_def Let_def init_def step_def accept_def run_t_def
        run_sub_def st_def ac_def i_def ti_def si_def j_def tj_def sj_def s_def e_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> i_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> distinct_before<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_s_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> run_tj <span class="main">=</span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> run_t_def tj_def<span class="main">]</span>
  <span class="keyword1"><span class="command">note</span></span> run_sj <span class="main">=</span> assms<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> run_sub_def sj_def<span class="main">]</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">rho'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">rho'</span> <span class="main">=</span> <span class="free">rho</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span><span class="main">]</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> ts_at_mono<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="skolem">rho'</span> <span class="main">⟹</span> ts_at <span class="skolem">rho'</span> <span class="bound">i</span> <span class="main">≤</span> ts_at <span class="skolem">rho'</span> <span class="bound">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before<span class="main">(</span>2<span class="main">)</span> assms<span class="main">(</span>4<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def ts_at_def nth_append <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits list.splits if_splits<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="skolem"><span class="skolem">ac'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_fold_s <span class="skolem">step</span> <span class="skolem">st</span> <span class="skolem">accept</span> <span class="skolem">ac</span> <span class="free">bs</span> <span class="free">t</span> <span class="skolem">j</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">st'</span><span class="main">,</span> <span class="skolem">ac'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mmap_fold_s <span class="skolem">step</span> <span class="skolem">st</span> <span class="skolem">accept</span> <span class="skolem">ac</span> <span class="free">bs</span> <span class="free">t</span> <span class="skolem">j</span> <span class="skolem">s</span>"</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> s'_mmap_map<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s'</span> <span class="main">=</span> mmap_map <span class="main">(</span><span class="main">λ</span><span class="bound">q</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">tstp</span><span class="main">)</span><span class="main">.</span>
    <span class="main">(</span><span class="skolem">step</span> <span class="bound">q'</span> <span class="free">bs</span><span class="main">,</span> <span class="keyword1">if</span> <span class="skolem">accept</span> <span class="bound">q'</span> <span class="free">bs</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">tstp</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">st'</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="skolem">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">ac'</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="skolem">accept</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mmap_fold_s_sound<span class="main">[</span><span class="operator">OF</span> s'_def valid_before<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">)</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="skolem"><span class="skolem">st''</span></span> <span class="keyword2"><span class="keyword">where</span></span> e'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_fold' <span class="skolem">e</span> <span class="skolem">st'</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="bound">st</span><span class="main">)</span><span class="main">.</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> cstep <span class="skolem">step</span> <span class="bound">st</span> <span class="bound">x</span> <span class="free">bs</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span><span class="main">)</span> sup <span class="main">[]</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">e'</span><span class="main">,</span> <span class="skolem">st''</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> old.prod.exhaust<span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">inv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">inv</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">st'</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="bound">st'</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True
    <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="skolem">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> inv_st'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">inv</span> <span class="skolem">st'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> s'_mmap_map<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">p</span> <span class="bound">e</span> <span class="bound">p'</span> <span class="bound">e'</span><span class="main">.</span> <span class="skolem">inv</span> <span class="bound">e</span> <span class="main">⟹</span> <span class="main">(</span><span class="keyword1">case</span> <span class="main">(</span><span class="bound">p</span><span class="main">,</span> <span class="bound">e</span><span class="main">)</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">x</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">λ</span><span class="bound">st</span><span class="main">.</span> <span class="keyword1">let</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> cstep <span class="skolem">step</span> <span class="bound">st</span> <span class="bound">x</span> <span class="free">bs</span> <span class="keyword1">in</span> <span class="main">(</span><span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span><span class="main">)</span> <span class="bound">xa</span><span class="main">)</span> <span class="main">=</span> <span class="main">(</span><span class="bound">p'</span><span class="main">,</span> <span class="bound">e'</span><span class="main">)</span> <span class="main">⟹</span>
    <span class="bound">p'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">p</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="skolem">step</span> <span class="bound">x</span> <span class="free">bs</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">)</span> <span class="main">∧</span> <span class="skolem">inv</span> <span class="bound">e'</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_def cstep_def Let_def Mapping.lookup_update' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> e'_fold_sup_st''<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">=</span> fold_sup <span class="skolem">e</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="skolem">step</span> <span class="bound">q</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">st''</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="skolem">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mmap_fold'_eq<span class="main">[</span><span class="operator">OF</span> e'_def<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">inv</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="skolem">step</span> <span class="bound">x</span> <span class="free">bs</span><span class="main">,</span> <span class="bound">y</span><span class="main">)</span>"</span></span><span class="main">,</span> <span class="operator">OF</span> inv_st'<span class="main">]</span> 
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> fold_sup_def inv_def<span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> adv_end<span class="main">:</span> <span class="quoted"><span class="quoted">"adv_end <span class="free">args</span> <span class="free">w</span> <span class="main">=</span> <span class="free">w</span><span class="main">⦇</span>w_st <span class="main">:=</span> <span class="skolem">st''</span><span class="main">,</span> w_ac <span class="main">:=</span> <span class="skolem">ac'</span><span class="main">,</span>
    w_j <span class="main">:=</span> Suc <span class="skolem">j</span><span class="main">,</span> w_tj <span class="main">:=</span> <span class="free">tj'</span><span class="main">,</span> w_sj <span class="main">:=</span> <span class="free">sj'</span><span class="main">,</span> w_s <span class="main">:=</span> <span class="skolem">s'</span><span class="main">,</span> w_e <span class="main">:=</span> <span class="skolem">e'</span><span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> run_tj run_sj e'_def<span class="main">[</span><span class="operator">unfolded</span> st_def<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> adv_end_def init_def step_def accept_def run_t_def run_sub_def
      i_def ti_def si_def j_def tj_def sj_def s_def e_def s'_def e'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def s'_def<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> step_def st_def accept_def ac_def j_def s_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> keys_s'<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_keys <span class="skolem">s'</span> <span class="main">=</span> mmap_keys <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_keys_def mmap_map_def s'_mmap_map<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lookup_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">q'</span> <span class="bound">tstp</span><span class="main">.</span> mmap_lookup <span class="skolem">s</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">tstp</span><span class="main">)</span> <span class="main">⟹</span>
  steps <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="bound">q</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="bound">q'</span> <span class="main">∧</span> <span class="bound">tstp</span> <span class="main">=</span> sup_acc <span class="skolem">step</span> <span class="skolem">accept</span> <span class="skolem">rho'</span> <span class="bound">q</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before Mapping_keys_intro
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Let_def rho'_def valid_s_def steps_app_cong sup_acc_app_cong
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> bs_at_rho'_j<span class="main">:</span> <span class="quoted"><span class="quoted">"bs_at <span class="skolem">rho'</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">bs</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def bs_at_def nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> ts_at_rho'_j<span class="main">:</span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho'</span> <span class="skolem">j</span> <span class="main">=</span> <span class="free">t</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def ts_at_def nth_append<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lookup_s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">q'</span> <span class="bound">tstp</span><span class="main">.</span> mmap_lookup <span class="skolem">s'</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">tstp</span><span class="main">)</span> <span class="main">⟹</span>
  steps <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="bound">q</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="bound">q'</span> <span class="main">∧</span> <span class="bound">tstp</span> <span class="main">=</span> sup_acc <span class="skolem">step</span> <span class="skolem">accept</span> <span class="skolem">rho'</span> <span class="bound">q</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">q''</span> <span class="skolem">tstp'</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="skolem">s'</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q''</span><span class="main">,</span> <span class="skolem">tstp'</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">tstp</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="skolem">s</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">tstp</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">=</span> <span class="skolem">step</span> <span class="skolem">q'</span> <span class="free">bs</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">tstp'</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="skolem">accept</span> <span class="skolem">q'</span> <span class="free">bs</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="keyword1">else</span> <span class="skolem">tstp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> map_values_lookup<span class="main">[</span><span class="operator">OF</span> assm<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> s'_mmap_map<span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"steps <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">q</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q''</span> <span class="main">∧</span> <span class="skolem">tstp'</span> <span class="main">=</span> sup_acc <span class="skolem">step</span> <span class="skolem">accept</span> <span class="skolem">rho'</span> <span class="skolem">q</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">j</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lookup_s
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bs_at_rho'_j ts_at_rho'_j<span class="main">)</span>
         <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 bs_at_rho'_j i_j steps_app<span class="main">)</span>
        <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 acc_app bs_at_rho'_j i_j ts_at_rho'_j<span class="main">)</span>
       <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 bs_at_rho'_j i_j steps_app<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> Suc_eq_plus1 acc_app_idle bs_at_rho'_j i_j<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> lookup_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> mmap_lookup <span class="skolem">e</span> <span class="bound">q</span> <span class="main">=</span> sup_leadsto <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="bound">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before sup_leadsto_app_cong<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="free">rho</span></span> <span class="quoted"><span class="skolem">init</span></span> <span class="quoted"><span class="skolem">step</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> keys_e_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_keys <span class="skolem">e</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">l</span></span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">.</span> steps <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="bound">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_leadsto_def rho'_def<span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Mapping_keys_dest lookup_e rho'_def sup_leadsto_SomeE<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Mapping_keys_intro option.simps<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span> order_refl steps_app_cong<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">have</span></span> finite_keys_e<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>mmap_keys <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> keys_e_alt
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> finite_surj<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">{</span></span></span><span class="bound"><span class="bound"><span class="bound">l</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="bound"><span class="bound"><span class="bound">l</span></span></span> <span class="main"><span class="main"><span class="main">&lt;</span></span></span> <span class="skolem"><span class="skolem"><span class="skolem">i</span></span></span><span class="main"><span class="main"><span class="main">}</span></span></span>"</span></span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach_sub <span class="skolem">run_sub</span> <span class="free">sub</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span> <span class="skolem">sj</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before reach_sub_trans
    <span class="keyword1"><span class="command">unfolding</span></span> run_sub_def sub_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> reach_sub'<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="skolem">run_sub</span> <span class="free">sub</span> <span class="main">(</span>map snd <span class="free">rho</span> <span class="main">@</span> <span class="main">[</span><span class="free">bs</span><span class="main">]</span><span class="main">)</span> <span class="free">sj'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_sub_app run_sj
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fast</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach_sub <span class="skolem">run_t</span> <span class="free">t0</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span> <span class="skolem">tj</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before reach_sub_trans
    <span class="keyword1"><span class="command">unfolding</span></span> run_t_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> reach_t'<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="skolem">run_t</span> <span class="free">t0</span> <span class="main">(</span>map fst <span class="skolem">rho'</span><span class="main">)</span> <span class="free">tj'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> reach_sub_app run_tj
    <span class="keyword1"><span class="command">unfolding</span></span> rho'_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
  <span class="keyword1"><span class="command">have</span></span> lookup_e'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> mmap_lookup <span class="skolem">e'</span> <span class="bound">q</span> <span class="main">=</span> sup_leadsto <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="bound">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">Z</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> mmap_keys <span class="skolem">e</span><span class="main">.</span> <span class="skolem">step</span> <span class="bound">x</span> <span class="free">bs</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">}</span>"</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="skolem">e'</span> <span class="skolem">q</span> <span class="main">=</span> sup_leadsto <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> <span class="main">{}</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="skolem">e'</span> <span class="skolem">q</span> <span class="main">=</span> None"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Z_def lookup_fold_sup<span class="main">[</span><span class="operator">OF</span> distinct_before<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> e'_fold_sup_st''
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sup_leadsto <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span> None"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> ccontr<span class="main">)</span>
        <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_leadsto <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">≠</span> None"</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> i_j sup_leadsto_SomeE<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="quoted">"Suc <span class="skolem">j</span>"</span></span><span class="main">]</span> assm
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">have</span></span> l_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> less_le_trans<span class="main">[</span><span class="operator">OF</span> l_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> i_j<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q''</span></span> <span class="keyword2"><span class="keyword">where</span></span> q''_def<span class="main">:</span> <span class="quoted"><span class="quoted">"steps <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q''</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">step</span> <span class="skolem">q''</span> <span class="free">bs</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> steps_appE<span class="main">[</span><span class="operator">OF</span> _ l_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span> l_j
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bs_at_rho'_j<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">q''</span> <span class="main">∈</span> mmap_keys <span class="skolem">e</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> keys_e_alt l_def<span class="main">(</span>1<span class="main">)</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"False"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Z_def q''_def<span class="main">(</span>2<span class="main">)</span> True
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> lookup_e'<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="skolem">e'</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span>Sup_fin <span class="main">(</span><span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="skolem">e</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Z</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Z_def lookup_fold_sup<span class="main">[</span><span class="operator">OF</span> distinct_before<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> e'_fold_sup_st''
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> Let_def<span class="main">)</span>
      <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">L</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">=</span> <span class="main">{</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> <span class="skolem">i</span> <span class="main">∧</span> steps <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">have</span></span> fin_L<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">L</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> L_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> Z_alt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">Z</span> <span class="main">=</span> <span class="main">{</span><span class="bound">x</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">l</span></span> <span class="main">&lt;</span> <span class="skolem">i</span><span class="main">.</span> steps <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="bound">x</span> <span class="main">∧</span> <span class="skolem">step</span> <span class="bound">x</span> <span class="free">bs</span> <span class="main">=</span> <span class="skolem">q</span><span class="main">}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> Z_def<span class="main">[</span><span class="operator">unfolded</span> keys_e_alt<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> fin_Z<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="skolem">Z</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> Z_alt <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> L_nonempty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">L</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L_def Z_alt False i_j steps_app<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">step</span></span> <span class="quoted"><span class="free">rho</span></span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> bs_at_rho'_j<span class="main">)</span>
          <span class="main">(</span><span class="operator">smt</span> Suc_eq_plus1 bs_at_rho'_j less_irrefl_nat less_le_trans nat_le_linear steps_app<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> sup_leadsto<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_leadsto <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">i</span> <span class="main">(</span>Suc <span class="skolem">j</span><span class="main">)</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span>ts_at <span class="skolem">rho'</span> <span class="main">(</span>Max <span class="skolem">L</span><span class="main">)</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> L_nonempty L_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_leadsto_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> j_lt_rho'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">&lt;</span> length <span class="skolem">rho'</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> valid_before
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Sup_fin <span class="main">(</span><span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="skolem">e</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">=</span> ts_at <span class="skolem">rho'</span> <span class="main">(</span>Max <span class="skolem">L</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> antisym<span class="main">)</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="keyword2"><span class="keyword">where</span></span> zts_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">Z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="skolem">e</span><span class="main">)</span> <span class="skolem">z</span> <span class="main">=</span> <span class="skolem">ts</span>"</span></span>
          <span class="quoted"><span class="quoted">"Sup_fin <span class="main">(</span><span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="skolem">e</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">ts</span>"</span></span>
        <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
          <span class="keyword3"><span class="command">assume</span></span> lassm<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">z</span> <span class="bound">ts</span><span class="main">.</span> <span class="bound">z</span> <span class="main">∈</span> <span class="skolem">Z</span> <span class="main">⟹</span> <span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="skolem">e</span><span class="main">)</span> <span class="bound">z</span> <span class="main">=</span> <span class="bound">ts</span> <span class="main">⟹</span>
          <span class="keyword1">⨆<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub></span> <span class="main">(</span><span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="skolem">e</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">=</span> <span class="bound">ts</span> <span class="main">⟹</span> <span class="skolem">thesis</span>"</span></span>
          <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">T</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">=</span> <span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="skolem">e</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Z</span>"</span></span>
          <span class="keyword1"><span class="command">have</span></span> T_sub<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">⊆</span> ts_at <span class="skolem">rho'</span> <span class="main">`</span> <span class="main">{..</span><span class="skolem">j</span><span class="main">}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> lookup_e keys_e_alt i_j
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_def Z_def sup_leadsto_def<span class="main">)</span>
          <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"finite <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">T</span> <span class="main">≠</span> <span class="main">{}</span>"</span></span>
            <span class="keyword1"><span class="command">using</span></span> fin_Z False
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> sup_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="keyword1">⨆<span class="hidden">⇩</span><sub>f</sub><span class="hidden">⇩</span><sub>i</sub><span class="hidden">⇩</span><sub>n</sub></span> <span class="skolem">T</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span>
          <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> sup_fin_closed<span class="main">)</span>
            <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span> <span class="skolem">y</span>
            <span class="keyword3"><span class="command">assume</span></span> xy<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">∈</span> <span class="skolem">T</span>"</span></span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">a</span></span> <span class="skolem"><span class="skolem">c</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">=</span> ts_at <span class="skolem">rho'</span> <span class="skolem">a</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">y</span> <span class="main">=</span> ts_at <span class="skolem">rho'</span> <span class="skolem">c</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">c</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> T_sub
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">meson</span> atMost_iff imageE subsetD<span class="main">)</span>
            <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"sup <span class="skolem">x</span> <span class="skolem">y</span> <span class="main">∈</span> <span class="main">{</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">}</span>"</span></span>
              <span class="keyword1"><span class="command">using</span></span> ts_at_mono j_lt_rho'
              <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"<span class="skolem">a</span> <span class="main">≤</span> <span class="skolem">c</span>"</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup.absorb1 sup.absorb2<span class="main">)</span>
          <span class="keyword1"><span class="command">qed</span></span>
          <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
            <span class="keyword1"><span class="command">using</span></span> lassm
            <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> T_def<span class="main">)</span>
        <span class="keyword1"><span class="command">qed</span></span>
        <span class="keyword1"><span class="command">from</span></span> zts_def<span class="main">(</span>2<span class="main">)</span> <span class="keyword1"><span class="command">have</span></span> lookup_e_z<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="skolem">e</span> <span class="skolem">z</span> <span class="main">=</span> Some <span class="skolem">ts</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> zts_def<span class="main">(</span>1<span class="main">)</span> Z_def <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sup_leadsto <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">z</span> <span class="main">=</span> Some <span class="skolem">ts</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> lookup_e_z lookup_e
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho'</span> <span class="skolem">l</span> <span class="main">=</span> <span class="skolem">ts</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sup_leadsto_SomeE<span class="main">[</span><span class="operator">OF</span> i_j<span class="main">]</span>
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def ts_at_def nth_append<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> l_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> less_le_trans<span class="main">[</span><span class="operator">OF</span> l_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> i_j<span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">∈</span> <span class="skolem">L</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> L_def <span class="keyword1"><span class="command">using</span></span> l_def zts_def<span class="main">(</span>1<span class="main">)</span> Z_alt
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> Suc_eq_plus1 bs_at_rho'_j l_j steps_app<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> Max <span class="skolem">L</span>"</span></span> <span class="quoted"><span class="quoted">"Max <span class="skolem">L</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> L_nonempty fin_L
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> L_def<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"Sup_fin <span class="main">(</span><span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="skolem">e</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Z</span><span class="main">)</span> <span class="main">≤</span> ts_at <span class="skolem">rho'</span> <span class="main">(</span>Max <span class="skolem">L</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> zts_def<span class="main">(</span>3<span class="main">)</span> l_def<span class="main">(</span>3<span class="main">)</span><span class="main">[</span><span class="operator">symmetric</span><span class="main">]</span>
          <span class="keyword1"><span class="command">using</span></span> ts_at_mono i_j j_lt_rho'
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">next</span></span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l</span></span> <span class="keyword2"><span class="keyword">where</span></span> l_def<span class="main">:</span> <span class="quoted"><span class="quoted">"Max <span class="skolem">L</span> <span class="main">=</span> <span class="skolem">l</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"steps <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> Suc <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Max_in<span class="main">[</span><span class="operator">OF</span> fin_L L_nonempty<span class="main">]</span> L_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">z</span></span> <span class="keyword2"><span class="keyword">where</span></span> z_def<span class="main">:</span> <span class="quoted"><span class="quoted">"steps <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">l</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">step</span> <span class="skolem">z</span> <span class="free">bs</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> l_def<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> i_j bs_at_rho'_j
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> less_imp_le_nat less_le_trans steps_appE<span class="main">)</span>
        <span class="keyword1"><span class="command">have</span></span> z_in_Z<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">z</span> <span class="main">∈</span> <span class="skolem">Z</span>"</span></span>
          <span class="keyword1"><span class="command">unfolding</span></span> Z_alt
          <span class="keyword1"><span class="command">using</span></span> l_def<span class="main">(</span>2<span class="main">)</span> z_def i_j
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
        <span class="keyword1"><span class="command">have</span></span> lookup_e_z<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="skolem">e</span> <span class="skolem">z</span> <span class="main">=</span> sup_leadsto <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">z</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> lookup_e z_in_Z Z_alt
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">l'</span></span> <span class="keyword2"><span class="keyword">where</span></span> l'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"sup_leadsto <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">z</span> <span class="main">=</span> Some <span class="main">(</span>ts_at <span class="skolem">rho'</span> <span class="skolem">l'</span><span class="main">)</span>"</span></span>
          <span class="quoted"><span class="quoted">"<span class="skolem">l</span> <span class="main">≤</span> <span class="skolem">l'</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">l'</span> <span class="main">&lt;</span> <span class="skolem">i</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> sup_leadsto_SomeI<span class="main">[</span><span class="operator">OF</span> l_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> z_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
        <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho'</span> <span class="skolem">l'</span> <span class="main">∈</span> <span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="skolem">e</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Z</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> lookup_e_z l'_def<span class="main">(</span>1<span class="main">)</span> z_in_Z
          <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho'</span> <span class="skolem">l'</span> <span class="main">≤</span> Sup_fin <span class="main">(</span><span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="skolem">e</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Z</span><span class="main">)</span>"</span></span>
          <span class="keyword1"><span class="command">using</span></span> Inf_fin_le_Sup_fin fin_Z z_in_Z
          <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Sup_fin.coboundedI<span class="main">)</span>
        <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"ts_at <span class="skolem">rho'</span> <span class="main">(</span>Max <span class="skolem">L</span><span class="main">)</span> <span class="main">≤</span> Sup_fin <span class="main">(</span><span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="skolem">e</span><span class="main">)</span> <span class="main">`</span> <span class="skolem">Z</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> l_def<span class="main">(</span>1<span class="main">)</span>
        <span class="keyword1"><span class="command">using</span></span> ts_at_mono l'_def<span class="main">(</span>2<span class="main">,</span>3<span class="main">)</span> i_j j_lt_rho'
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def<span class="main">)</span>
      <span class="keyword1"><span class="command">qed</span></span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> lookup_e' sup_leadsto <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">s'</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">e'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> distinct_before mmap_fold_distinct
    <span class="keyword1"><span class="command">unfolding</span></span> s'_mmap_map mmap_map_fst e'_fold_sup_st'' fold_sup_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"mmap_keys <span class="skolem">s'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">l</span></span><span class="main">≤</span><span class="skolem">i</span><span class="main">.</span> steps <span class="skolem">step</span> <span class="skolem">rho'</span> <span class="skolem">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="skolem">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> keys_s' rho'_def
    <span class="keyword1"><span class="command">using</span></span> valid_before<span class="main">(</span>1<span class="main">,</span>7<span class="main">)</span> valid_s_def<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">init</span></span> <span class="quoted"><span class="skolem">step</span></span> <span class="quoted"><span class="skolem">st</span></span> <span class="quoted"><span class="skolem">accept</span></span> <span class="quoted"><span class="free">rho</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">i</span></span> <span class="quoted"><span class="skolem">j</span></span> <span class="quoted"><span class="skolem">s</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> steps_app_cong<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="free">rho</span></span> <span class="quoted"><span class="skolem">step</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach_sub <span class="skolem">run_t</span> <span class="skolem">ti</span> <span class="main">(</span>drop <span class="skolem">i</span> <span class="main">(</span>map fst <span class="skolem">rho'</span><span class="main">)</span><span class="main">)</span> <span class="free">tj'</span>"</span></span>
    <span class="quoted"><span class="quoted">"reach_sub <span class="skolem">run_sub</span> <span class="skolem">si</span> <span class="main">(</span>drop <span class="skolem">i</span> <span class="main">(</span>map snd <span class="skolem">rho'</span><span class="main">)</span><span class="main">)</span> <span class="free">sj'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before reach_sub_app run_tj run_sj
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> rho'_def run_t_def run_sub_def<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="main">(</span><span class="free">rho</span> <span class="main">@</span> <span class="main">[</span><span class="main">(</span><span class="free">t</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span><span class="main">]</span><span class="main">)</span> <span class="main">(</span>adv_end <span class="free">args</span> <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> adv_end
    <span class="keyword1"><span class="command">using</span></span> valid_before lookup_e' lookup_s' ts_at_mono s'_mmap_map<span class="main">(</span>3<span class="main">)</span> e'_fold_sup_st''<span class="main">(</span>2<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_def Let_def init_def step_def accept_def run_t_def
        run_sub_def i_def ti_def si_def j_def tj_def sj_def s_def e'_def
        rho'_def valid_s_def <span class="quasi_keyword">intro</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> exI<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="main"><span class="main">_</span></span> <span class="quoted"><span class="skolem">rho'</span></span><span class="main"><span class="main">]</span></span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> adv_end_bounds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="main">(</span>w_tj <span class="free">w</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">tj'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span> <span class="main">(</span>w_sj <span class="free">w</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">sj'</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"w_i <span class="main">(</span>adv_end <span class="free">args</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> w_i <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"w_ti <span class="main">(</span>adv_end <span class="free">args</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> w_ti <span class="free">w</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_si <span class="main">(</span>adv_end <span class="free">args</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> w_si <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"w_j <span class="main">(</span>adv_end <span class="free">args</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>w_j <span class="free">w</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_tj <span class="main">(</span>adv_end <span class="free">args</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">tj'</span>"</span></span> <span class="quoted"><span class="quoted">"w_sj <span class="main">(</span>adv_end <span class="free">args</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">sj'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> adv_end_def Let_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">drop_cur</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"nat <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> nat<span class="main">)</span> option<span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> nat<span class="main">)</span> option<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">drop_cur</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">tstp</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="keyword1">case</span> <span class="bound">tstp</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">ts</span><span class="main">,</span> <span class="bound">tp</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="keyword1">if</span> <span class="bound">tp</span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="keyword1">then</span> None <span class="keyword1">else</span> <span class="bound">tstp</span> <span class="main">|</span> None <span class="main">⇒</span> <span class="bound">tstp</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adv_d</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> mapping <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> nat<span class="main">)</span> option<span class="main">)</span> mmap <span class="main">⇒</span>
  <span class="main">(</span><span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> nat<span class="main">)</span> option<span class="main">)</span> mmap <span class="main">×</span> <span class="main">(</span><span class="tfree">'c</span> <span class="main">×</span> <span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">)</span> mapping<span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">adv_d</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span>mmap_fold' <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="free"><span class="bound"><span class="entity">st</span></span></span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">,</span> <span class="bound">st</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> cstep <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="bound">st</span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> drop_cur <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="bound">v</span><span class="main">)</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> adv_d_mmap_fold<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">st</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> fold'<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_fold' <span class="free">s</span> <span class="free">st</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">,</span> <span class="bound">st</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> cstep <span class="free">step</span> <span class="bound">st</span> <span class="bound">x</span> <span class="free">bs</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">x'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="main">(</span><span class="main">(</span><span class="bound">x'</span><span class="main">,</span> drop_cur <span class="free">i</span> <span class="bound">v</span><span class="main">)</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="free">r</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">st'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"<span class="free">s'</span> <span class="main">=</span> mmap_fold <span class="free">s</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">step</span> <span class="bound">x</span> <span class="free">bs</span><span class="main">,</span> drop_cur <span class="free">i</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="free">r</span> <span class="main">∧</span>
    <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">st'</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">inv</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">inv</span> <span class="main">≡</span> <span class="main">λ</span><span class="bound">st</span><span class="main">.</span> <span class="main">∀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="bound">st</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True
    <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> inv_st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">inv</span> <span class="free">st</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> inv
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> inv_def<span class="main">)</span>
  <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> mmap_fold'_eq<span class="main"><span class="main">[</span></span><span class="operator">OF</span> fold'<span class="main"><span class="main">,</span></span> <span class="operator">of</span> <span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem"><span class="quoted"><span class="skolem">inv</span></span></span></span></span></span> <span class="quoted"><span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main"><span class="main">λ</span></span></span><span class="main"><span class="main"><span class="main">(</span></span></span><span class="bound"><span class="bound"><span class="bound">x</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> <span class="bound"><span class="bound"><span class="bound">v</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span><span class="main"><span class="main"><span class="main">.</span></span></span> <span class="main"><span class="main"><span class="main">(</span></span></span><span class="free"><span class="free"><span class="free">step</span></span></span> <span class="bound"><span class="bound"><span class="bound">x</span></span></span> <span class="free"><span class="free"><span class="free">bs</span></span></span><span class="main"><span class="main"><span class="main">,</span></span></span> drop_cur <span class="free"><span class="free"><span class="free">i</span></span></span> <span class="bound"><span class="bound"><span class="bound">v</span></span></span><span class="main"><span class="main"><span class="main">)</span></span></span>"</span></span></span></span><span class="main"><span class="main">,</span></span>
          <span class="operator">OF</span> inv_st<span class="main"><span class="main">,</span></span> <span class="operator">unfolded</span> inv_def<span class="main"><span class="main">]</span></span><span class="main">)</span>
       <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cstep_def Let_def Mapping.lookup_update'
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits option.splits if_splits<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">keys_idem</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'c</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="tfree">'c</span><span class="main">)</span> <span class="main">⇒</span> nat <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'c</span> <span class="main">×</span> <span class="main">(</span><span class="tfree">'d</span> <span class="main">×</span> nat<span class="main">)</span> option<span class="main">)</span> mmap <span class="main">⇒</span> bool"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">keys_idem</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">∀</span><span class="bound">x</span> <span class="main">∈</span> mmap_keys <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">.</span> <span class="main">∀</span><span class="bound">x'</span> <span class="main">∈</span> mmap_keys <span class="free"><span class="bound"><span class="entity">s</span></span></span><span class="main">.</span>
    <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="bound">x</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">=</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="bound">x'</span> <span class="free"><span class="bound"><span class="entity">b</span></span></span> <span class="main">⟶</span> drop_cur <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    drop_cur <span class="free"><span class="bound"><span class="entity">i</span></span></span> <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="free"><span class="bound"><span class="entity">s</span></span></span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> adv_d_keys<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">st</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">and</span></span> adv_d<span class="main">:</span> <span class="quoted"><span class="quoted">"adv_d <span class="free">step</span> <span class="free">st</span> <span class="free">i</span> <span class="free">bs</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">st'</span><span class="main">)</span>"</span></span>
<span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mmap_keys <span class="free">s'</span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">step</span> <span class="bound">q</span> <span class="free">bs</span><span class="main">)</span> <span class="main">`</span> <span class="main">(</span>mmap_keys <span class="free">s</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> adv_d_mmap_fold<span class="main">[</span><span class="operator">OF</span> inv adv_d<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> adv_d_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
    mmap_fold_set<span class="main">[</span><span class="operator">OF</span> distinct<span class="main">]</span>
  <span class="keyword1"><span class="command">unfolding</span></span> mmap_keys_def
  <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_adv_d_None<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">st</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> adv_d<span class="main">:</span> <span class="quoted"><span class="quoted">"adv_d <span class="free">step</span> <span class="free">st</span> <span class="free">i</span> <span class="free">bs</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">st'</span><span class="main">)</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> Z_empty<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> mmap_keys <span class="free">s</span><span class="main">.</span> <span class="free">step</span> <span class="bound">x</span> <span class="free">bs</span> <span class="main">=</span> <span class="free">z</span><span class="main">}</span> <span class="main">=</span> <span class="main">{}</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="free">s'</span> <span class="free">z</span> <span class="main">=</span> None"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∉</span> mmap_keys <span class="main">(</span>mmap_fold <span class="free">s</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">step</span> <span class="bound">x</span> <span class="free">bs</span><span class="main">,</span> drop_cur <span class="free">i</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> Z_empty<span class="main">[</span><span class="operator">unfolded</span> mmap_keys_def<span class="main">]</span> mmap_fold_set<span class="main">[</span><span class="operator">OF</span> distinct<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_keys_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> adv_d adv_d_mmap_fold<span class="main">[</span><span class="operator">OF</span> inv adv_d<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> adv_d_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> adv_d_def
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_lookup_None_intro<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> lookup_adv_d_Some<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> inv<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">st</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">s</span><span class="main">)</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> idem<span class="main">:</span> <span class="quoted"><span class="quoted">"keys_idem <span class="free">step</span> <span class="free">i</span> <span class="free">bs</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> wit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">x</span> <span class="main">∈</span> mmap_keys <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="free">x</span> <span class="free">bs</span> <span class="main">=</span> <span class="free">z</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> adv_d<span class="main">:</span> <span class="quoted"><span class="quoted">"adv_d <span class="free">step</span> <span class="free">st</span> <span class="free">i</span> <span class="free">bs</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">st'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="free">s'</span> <span class="free">z</span> <span class="main">=</span> Some <span class="main">(</span>drop_cur <span class="free">i</span> <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> z_in_keys<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">z</span> <span class="main">∈</span> mmap_keys <span class="main">(</span>mmap_fold <span class="free">s</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">step</span> <span class="bound">x</span> <span class="free">bs</span><span class="main">,</span> drop_cur <span class="free">i</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="main">[]</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wit<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> mmap_keys_def<span class="main">]</span> mmap_fold_set<span class="main">[</span><span class="operator">OF</span> distinct<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_keys_def<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">v</span></span> <span class="skolem"><span class="skolem">vs</span></span> <span class="keyword2"><span class="keyword">where</span></span> vs_def<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="free">s'</span> <span class="free">z</span> <span class="main">=</span> Some <span class="main">(</span>foldl <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">v</span> <span class="main">#</span> <span class="skolem">vs</span> <span class="main">=</span> map <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> drop_cur <span class="free">i</span> <span class="bound">v</span><span class="main">)</span> <span class="main">(</span>filter <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">k</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="free">step</span> <span class="bound">k</span> <span class="free">bs</span> <span class="main">=</span> <span class="free">z</span><span class="main">)</span> <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adv_d adv_d_mmap_fold<span class="main">[</span><span class="operator">OF</span> inv adv_d<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> adv_d_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> adv_d_def
    <span class="keyword1"><span class="command">using</span></span> mmap_fold_lookup<span class="main">[</span><span class="operator">OF</span> distinct<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">x</span><span class="main">,</span> <span class="bound">v</span><span class="main">)</span><span class="main">.</span> <span class="main">(</span><span class="free">step</span> <span class="bound">x</span> <span class="free">bs</span><span class="main">,</span> drop_cur <span class="free">i</span> <span class="bound">v</span><span class="main">)</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span>"</span></span> <span class="quoted"><span class="free">z</span></span><span class="main">]</span>
      Mapping_keys_dest<span class="main">[</span><span class="operator">OF</span> z_in_keys<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> adv_d_def mmap_keys_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> list.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"set <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">vs</span><span class="main">)</span> <span class="main">=</span> drop_cur <span class="free">i</span> <span class="main">`</span> <span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="free">s</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> mmap_keys <span class="free">s</span><span class="main">.</span> <span class="free">step</span> <span class="bound">x</span> <span class="free">bs</span> <span class="main">=</span> <span class="free">z</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> set_eqI<span class="main"><span class="keyword3">,</span></span> <span class="operator">rule</span> iffI<span class="main">)</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> xy_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> mmap_keys <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="skolem">x</span> <span class="free">bs</span> <span class="main">=</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">s</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> drop_cur <span class="free">i</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> vs_def<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mmap_keys_def rev_image_eqI<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> drop_cur <span class="free">i</span> <span class="main">`</span> <span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="free">s</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> mmap_keys <span class="free">s</span><span class="main">.</span> <span class="free">step</span> <span class="bound">x</span> <span class="free">bs</span> <span class="main">=</span> <span class="free">z</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xy_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">,</span>4<span class="main">)</span> mmap_lookup_distinct<span class="main">[</span><span class="operator">OF</span> distinct xy_def<span class="main"><span class="main">(</span></span>3<span class="main"><span class="main">)</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">force</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">w</span>
    <span class="keyword3"><span class="command">assume</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> drop_cur <span class="free">i</span> <span class="main">`</span> <span class="main">(</span>the <span class="main">∘</span> mmap_lookup <span class="free">s</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound"><span class="bound">x</span></span> <span class="main">∈</span> mmap_keys <span class="free">s</span><span class="main">.</span> <span class="free">step</span> <span class="bound">x</span> <span class="free">bs</span> <span class="main">=</span> <span class="free">z</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="skolem"><span class="skolem">y</span></span> <span class="keyword2"><span class="keyword">where</span></span> xy_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> mmap_keys <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="skolem">x</span> <span class="free">bs</span> <span class="main">=</span> <span class="free">z</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">x</span><span class="main">,</span> <span class="skolem">y</span><span class="main">)</span> <span class="main">∈</span> set <span class="free">s</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">=</span> drop_cur <span class="free">i</span> <span class="skolem">y</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> mmap_lookup_distinct<span class="main">[</span><span class="operator">OF</span> distinct<span class="main">]</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro distinct mmap_lookup_def <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">w</span> <span class="main">∈</span> set <span class="main">(</span><span class="skolem">v</span> <span class="main">#</span> <span class="skolem">vs</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> xy_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">force</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vs_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"foldl <span class="main">(</span><span class="main">λ</span><span class="bound">x</span> <span class="bound">y</span><span class="main">.</span> <span class="bound">x</span><span class="main">)</span> <span class="skolem">v</span> <span class="skolem">vs</span> <span class="main">=</span> drop_cur <span class="free">i</span> <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="free">s</span> <span class="free">x</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> wit
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="skolem">vs</span></span> <span class="quasi_keyword">arbitrary</span><span class="main"><span class="main">:</span></span> <span class="quoted"><span class="skolem">v</span></span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span><span class="main">)</span>
     <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> empty_is_image idem imageE insert_not_empty keys_idem_def mem_Collect_eq
        the_elem_eq the_elem_image_unique<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">smt</span> Collect_cong idem imageE insert_compr keys_idem_def mem_Collect_eq<span class="main">)</span>
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">using</span></span> wit
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> vs_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span><span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">loop_cond</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">ac</span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">ti</span><span class="main">,</span> <span class="bound">si</span><span class="main">,</span> <span class="bound">q</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">tstp</span><span class="main">)</span><span class="main">.</span> <span class="bound">i</span> <span class="main">&lt;</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="main">∧</span> <span class="bound">q</span> <span class="main">∉</span> mmap_keys <span class="bound">s</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">loop_body</span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">run_t</span></span></span> <span class="free"><span class="bound"><span class="entity">run_sub</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">ac</span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">ti</span><span class="main">,</span> <span class="bound">si</span><span class="main">,</span> <span class="bound">q</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">tstp</span><span class="main">)</span><span class="main">.</span> <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">run_t</span></span></span> <span class="bound">ti</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">ti'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span>
  <span class="keyword1">case</span> <span class="free"><span class="bound"><span class="entity">run_sub</span></span></span> <span class="bound">si</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">si'</span><span class="main">,</span> <span class="bound">b</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">case</span> adv_d <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="bound">st</span> <span class="bound">i</span> <span class="bound">b</span> <span class="bound">s</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">⇒</span>
  <span class="keyword1">case</span> cstep <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="bound">st'</span> <span class="bound">q</span> <span class="bound">b</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">st''</span><span class="main">)</span> <span class="main">⇒</span> <span class="keyword1">case</span> cac <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="bound">ac</span> <span class="bound">q</span> <span class="bound">b</span> <span class="keyword1">of</span> <span class="main">(</span><span class="bound">β</span><span class="main">,</span> <span class="bound">ac'</span><span class="main">)</span> <span class="main">⇒</span>
  <span class="main">(</span><span class="bound">st''</span><span class="main">,</span> <span class="bound">ac'</span><span class="main">,</span> Suc <span class="bound">i</span><span class="main">,</span> <span class="bound">ti'</span><span class="main">,</span> <span class="bound">si'</span><span class="main">,</span> <span class="bound">q'</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> <span class="keyword1">if</span> <span class="bound">β</span> <span class="keyword1">then</span> Some <span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="keyword1">else</span> <span class="bound">tstp</span><span class="main">)</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">definition</span></span> <span class="quoted"><span class="quoted">"<span class="free">loop_inv</span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="free"><span class="bound"><span class="entity">tj</span></span></span> <span class="free"><span class="bound"><span class="entity">sj</span></span></span> <span class="main">=</span>
  <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">ac</span><span class="main">,</span> <span class="bound">i</span><span class="main">,</span> <span class="bound">ti</span><span class="main">,</span> <span class="bound">si</span><span class="main">,</span> <span class="bound">q</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">tstp</span><span class="main">)</span><span class="main">.</span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="bound">i</span> <span class="main">∧</span>
  reach_window <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">t0</span></span></span> <span class="free"><span class="bound"><span class="entity">sub</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="main">(</span><span class="bound">i</span><span class="main">,</span> <span class="bound">ti</span><span class="main">,</span> <span class="bound">si</span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">tj</span></span></span><span class="main">,</span> <span class="free"><span class="bound"><span class="entity">sj</span></span></span><span class="main">)</span> <span class="main">∧</span>
  steps <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="bound">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">q</span> <span class="main">∧</span>
  <span class="main">(</span><span class="main">∀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="bound">ac</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span> <span class="main">∧</span>
  valid_s <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="bound">st</span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="bound">i</span> <span class="free"><span class="bound"><span class="entity">j</span></span></span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">tstp</span> <span class="main">=</span> sup_acc <span class="free"><span class="bound"><span class="entity">step</span></span></span> <span class="free"><span class="bound"><span class="entity">accept</span></span></span> <span class="free"><span class="bound"><span class="entity">rho</span></span></span> <span class="free"><span class="bound"><span class="entity">init</span></span></span> <span class="main">(</span><span class="free"><span class="bound"><span class="entity">u</span></span></span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="bound">i</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">mmap_update</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="tfree">'a</span> <span class="main">⇒</span> <span class="tfree">'b</span> <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mmap <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'a</span><span class="main">,</span> <span class="tfree">'b</span><span class="main">)</span> mmap"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">mmap_update</span> <span class="main">=</span> AList.update"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mmap_update_distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">m</span><span class="main">)</span> <span class="main">⟹</span> distinct <span class="main">(</span>map fst <span class="main">(</span>mmap_update <span class="free">k</span> <span class="free">v</span> <span class="free">m</span><span class="main">)</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_update_def distinct_update<span class="main">)</span>

<span class="keyword1"><span class="command">definition</span></span> <span class="entity">adv_start</span> <span class="main">::</span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span> <span class="main">::</span> timestamp<span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> args <span class="main">⇒</span>
  <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> window <span class="main">⇒</span> <span class="main">(</span><span class="tfree">'b</span><span class="main">,</span> <span class="tfree">'c</span><span class="main">,</span> <span class="tfree">'d</span><span class="main">,</span> <span class="tfree">'t</span><span class="main">,</span> <span class="tfree">'e</span><span class="main">)</span> window"</span></span> <span class="keyword2"><span class="keyword">where</span></span>
  <span class="quoted"><span class="quoted">"<span class="free">adv_start</span> <span class="free"><span class="bound"><span class="entity">args</span></span></span> <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">let</span> <span class="bound">init</span> <span class="main">=</span> w_init <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">;</span> <span class="bound">step</span> <span class="main">=</span> w_step <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">;</span> <span class="bound">accept</span> <span class="main">=</span> w_accept <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">;</span>
    <span class="bound">run_t</span> <span class="main">=</span> w_run_t <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">;</span> <span class="bound">run_sub</span> <span class="main">=</span> w_run_sub <span class="free"><span class="bound"><span class="entity">args</span></span></span><span class="main">;</span> <span class="bound">st</span> <span class="main">=</span> w_st <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">ac</span> <span class="main">=</span> w_ac <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span>
    <span class="bound">i</span> <span class="main">=</span> w_i <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">ti</span> <span class="main">=</span> w_ti <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">si</span> <span class="main">=</span> w_si <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">j</span> <span class="main">=</span> w_j <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span>
    <span class="bound">s</span> <span class="main">=</span> w_s <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">;</span> <span class="bound">e</span> <span class="main">=</span> w_e <span class="free"><span class="bound"><span class="entity">w</span></span></span> <span class="keyword1">in</span>
    <span class="main">(</span><span class="keyword1">case</span> <span class="bound">run_t</span> <span class="bound">ti</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">ti'</span><span class="main">,</span> <span class="bound">t</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">run_sub</span> <span class="bound">si</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">si'</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="main">⇒</span>
    <span class="keyword1">let</span> <span class="main">(</span><span class="bound">s'</span><span class="main">,</span> <span class="bound">st'</span><span class="main">)</span> <span class="main">=</span> adv_d <span class="bound">step</span> <span class="bound">st</span> <span class="bound">i</span> <span class="bound">bs</span> <span class="bound">s</span><span class="main">;</span>
    <span class="bound">e'</span> <span class="main">=</span> mmap_update <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="bound">s</span> <span class="bound">init</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="bound">t</span> <span class="bound">e</span><span class="main">;</span>
    <span class="main">(</span><span class="bound">st_cur</span><span class="main">,</span> <span class="bound">ac_cur</span><span class="main">,</span> <span class="bound">i_cur</span><span class="main">,</span> <span class="bound">ti_cur</span><span class="main">,</span> <span class="bound">si_cur</span><span class="main">,</span> <span class="bound">q_cur</span><span class="main">,</span> <span class="bound">s_cur</span><span class="main">,</span> <span class="bound">tstp_cur</span><span class="main">)</span> <span class="main">=</span>
      while <span class="main">(</span>loop_cond <span class="bound">j</span><span class="main">)</span> <span class="main">(</span>loop_body <span class="bound">step</span> <span class="bound">accept</span> <span class="bound">run_t</span> <span class="bound">run_sub</span><span class="main">)</span>
        <span class="main">(</span><span class="bound">st'</span><span class="main">,</span> <span class="bound">ac</span><span class="main">,</span> Suc <span class="bound">i</span><span class="main">,</span> <span class="bound">ti'</span><span class="main">,</span> <span class="bound">si'</span><span class="main">,</span> <span class="bound">init</span><span class="main">,</span> <span class="bound">s'</span><span class="main">,</span> None<span class="main">)</span><span class="main">;</span>
    <span class="bound">s''</span> <span class="main">=</span> mmap_update <span class="bound">init</span> <span class="main">(</span><span class="keyword1">case</span> mmap_lookup <span class="bound">s_cur</span> <span class="bound">q_cur</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">tstp'</span><span class="main">)</span> <span class="main">⇒</span>
      <span class="main">(</span><span class="keyword1">case</span> <span class="bound">tstp'</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">ts</span><span class="main">,</span> <span class="bound">tp</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">tstp'</span><span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">tstp_cur</span><span class="main">)</span><span class="main">)</span>
      <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="bound">q_cur</span><span class="main">,</span> <span class="bound">tstp_cur</span><span class="main">)</span><span class="main">)</span> <span class="bound">s'</span> <span class="keyword1">in</span>
    <span class="free"><span class="bound"><span class="entity">w</span></span></span><span class="main">⦇</span>w_st <span class="main">:=</span> <span class="bound">st_cur</span><span class="main">,</span> w_ac <span class="main">:=</span> <span class="bound">ac_cur</span><span class="main">,</span> w_i <span class="main">:=</span> Suc <span class="bound">i</span><span class="main">,</span> w_ti <span class="main">:=</span> <span class="bound">ti'</span><span class="main">,</span> w_si <span class="main">:=</span> <span class="bound">si'</span><span class="main">,</span>
      w_s <span class="main">:=</span> <span class="bound">s''</span><span class="main">,</span> w_e <span class="main">:=</span> <span class="bound">e'</span><span class="main">⦈</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_adv_d<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_s <span class="free">init</span> <span class="free">step</span> <span class="free">st</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">u</span> <span class="free">i</span> <span class="free">j</span> <span class="free">s</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> u_le_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">u</span> <span class="main">≤</span> <span class="free">i</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> i_lt_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">i</span> <span class="main">&lt;</span> <span class="free">j</span>"</span></span> <span class="keyword2"><span class="keyword">and</span></span> b_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="free">b</span> <span class="main">=</span> bs_at <span class="free">rho</span> <span class="free">i</span>"</span></span>
    <span class="keyword2"><span class="keyword">and</span></span> adv_d<span class="main">:</span> <span class="quoted"><span class="quoted">"adv_d <span class="free">step</span> <span class="free">st</span> <span class="free">i</span> <span class="free">b</span> <span class="free">s</span> <span class="main">=</span> <span class="main">(</span><span class="free">s'</span><span class="main">,</span> <span class="free">st'</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_s <span class="free">init</span> <span class="free">step</span> <span class="free">st'</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">u</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span> <span class="free">s'</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword1"><span class="command">have</span></span> inv_st<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="free">st</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="free">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_s_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> keys_s<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_keys <span class="free">s</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">(</span><span class="main">∃</span><span class="bound"><span class="bound">l</span></span> <span class="main">≤</span> <span class="free">u</span><span class="main">.</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">q</span><span class="main">)</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_s_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> fin_keys_s<span class="main">:</span> <span class="quoted"><span class="quoted">"finite <span class="main">(</span>mmap_keys <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_s_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lookup_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">q'</span> <span class="bound">tstp</span><span class="main">.</span> mmap_lookup <span class="free">s</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">tstp</span><span class="main">)</span> <span class="main">⟹</span>
    steps <span class="free">step</span> <span class="free">rho</span> <span class="bound">q</span> <span class="main">(</span><span class="free">i</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="bound">q'</span> <span class="main">∧</span> <span class="bound">tstp</span> <span class="main">=</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="bound">q</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before Mapping_keys_intro
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_s_def<span class="main">)</span> <span class="main">(</span><span class="operator">smt</span> case_prodD option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> drop_cur_i<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> mmap_keys <span class="free">s</span> <span class="main">⟹</span> drop_cur <span class="free">i</span> <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    <span class="main">(</span>steps <span class="free">step</span> <span class="free">rho</span> <span class="main">(</span><span class="free">step</span> <span class="bound">x</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span><span class="main">,</span>
    sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span><span class="free">step</span> <span class="bound">x</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">x</span>
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> mmap_keys <span class="free">s</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q</span></span> <span class="skolem"><span class="skolem">tstp</span></span> <span class="keyword2"><span class="keyword">where</span></span> q_def<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="free">s</span> <span class="skolem">x</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q</span><span class="main">,</span> <span class="skolem">tstp</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> q_q'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q</span> <span class="main">=</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="main">(</span><span class="free">step</span> <span class="skolem">x</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">tstp</span> <span class="main">=</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="skolem">x</span> <span class="free">i</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lookup_s<span class="main">[</span><span class="operator">OF</span> q_def<span class="main">]</span> steps_split<span class="main">[</span><span class="operator">OF</span> i_lt_j<span class="main">]</span> assms<span class="main">(</span>1<span class="main">)</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"drop_cur <span class="free">i</span> <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="free">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
      <span class="main">(</span>steps <span class="free">step</span> <span class="free">rho</span> <span class="main">(</span><span class="free">step</span> <span class="skolem">x</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span><span class="main">,</span>
      sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="main">(</span><span class="free">step</span> <span class="skolem">x</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> q_def sup_acc_None<span class="main">[</span><span class="operator">OF</span> i_lt_j<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">rho</span></span><span class="main">]</span>
        sup_acc_i<span class="main">[</span><span class="operator">OF</span> i_lt_j<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">rho</span></span><span class="main">]</span> sup_acc_l<span class="main">[</span><span class="operator">OF</span> i_lt_j<span class="main">,</span> <span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">accept</span></span> <span class="quoted"><span class="free">rho</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> q_q'
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_cur_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> valid_drop_cur<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">x</span> <span class="bound">x'</span><span class="main">.</span> <span class="bound">x</span> <span class="main">∈</span> mmap_keys <span class="free">s</span> <span class="main">⟹</span> <span class="bound">x'</span> <span class="main">∈</span> mmap_keys <span class="free">s</span> <span class="main">⟹</span>
    <span class="free">step</span> <span class="bound">x</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="free">step</span> <span class="bound">x'</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span> <span class="main">⟹</span> drop_cur <span class="free">i</span> <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="free">s</span> <span class="bound">x</span><span class="main">)</span><span class="main">)</span> <span class="main">=</span>
    drop_cur <span class="free">i</span> <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="free">s</span> <span class="bound">x'</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> drop_cur_i <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> keys_idem<span class="main">:</span> <span class="quoted"><span class="quoted">"keys_idem <span class="free">step</span> <span class="free">i</span> <span class="free">b</span> <span class="free">s</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> keys_idem_def b_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">blast</span>
  <span class="keyword1"><span class="command">have</span></span> distinct<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">s</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_s_def<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">λ</span><span class="bound">q</span><span class="main">.</span> <span class="free">step</span> <span class="bound">q</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span><span class="main">)</span> <span class="main">`</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">l</span></span><span class="main">≤</span><span class="free">u</span><span class="main">.</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="bound">q</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">l</span></span><span class="main">≤</span><span class="free">u</span><span class="main">.</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="bound">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> steps_app<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="quoted"><span class="free">i</span></span> <span class="quoted"><span class="free">step</span></span> <span class="quoted"><span class="free">rho</span></span> <span class="quoted"><span class="free">init</span></span><span class="main">]</span> u_le_i
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> keys_s'<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_keys <span class="free">s'</span> <span class="main">=</span> <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">l</span></span><span class="main">≤</span><span class="free">u</span><span class="main">.</span> steps <span class="free">step</span> <span class="free">rho</span> <span class="free">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="bound">q</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> adv_d_keys<span class="main">[</span><span class="operator">OF</span> _ distinct adv_d<span class="main">]</span> inv_st
    <span class="keyword1"><span class="command">unfolding</span></span> keys_s b_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lookup_s'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">q'</span> <span class="bound">tstp</span><span class="main">.</span> mmap_lookup <span class="free">s'</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">tstp</span><span class="main">)</span> <span class="main">⟹</span>
    steps <span class="free">step</span> <span class="free">rho</span> <span class="bound">q</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="bound">q'</span> <span class="main">∧</span> <span class="bound">tstp</span> <span class="main">=</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="bound">q</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span> <span class="skolem">q'</span> <span class="skolem">tstp</span>
    <span class="keyword3"><span class="command">assume</span></span> assm<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">tstp</span><span class="main">)</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">x</span></span> <span class="keyword2"><span class="keyword">where</span></span> wit<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">x</span> <span class="main">∈</span> mmap_keys <span class="free">s</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="free">step</span> <span class="skolem">x</span> <span class="main">(</span>bs_at <span class="free">rho</span> <span class="free">i</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm lookup_adv_d_None<span class="main">[</span><span class="operator">OF</span> _ distinct adv_d<span class="main">]</span> inv_st
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">fastforce</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> b_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> lookup_s'_q<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="free">s'</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span>drop_cur <span class="free">i</span> <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="free">s</span> <span class="skolem">x</span><span class="main">)</span><span class="main">)</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> lookup_adv_d_Some<span class="main">[</span><span class="operator">OF</span> _ distinct keys_idem wit<span class="main"><span class="main">[</span></span><span class="operator">folded</span> b_def<span class="main"><span class="main">]</span></span> adv_d<span class="main">]</span> inv_st
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"steps <span class="free">step</span> <span class="free">rho</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="free">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q'</span> <span class="main">∧</span> <span class="skolem">tstp</span> <span class="main">=</span> sup_acc <span class="free">step</span> <span class="free">accept</span> <span class="free">rho</span> <span class="skolem">q</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assm
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> drop_cur_i wit<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="free">s'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mmap_fold_distinct<span class="main">[</span><span class="operator">OF</span> distinct<span class="main">]</span> adv_d_mmap_fold<span class="main">[</span><span class="operator">OF</span> inv_st adv_d<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> adv_d_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> adv_d_def mmap_map_fst
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"valid_s <span class="free">init</span> <span class="free">step</span> <span class="free">st'</span> <span class="free">accept</span> <span class="free">rho</span> <span class="free">u</span> <span class="main">(</span><span class="free">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="free">j</span> <span class="free">s'</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> valid_s_def
    <span class="keyword1"><span class="command">using</span></span> keys_s' lookup_s' u_le_i inv_st adv_d<span class="main">[</span><span class="operator">unfolded</span> adv_d_def<span class="main">]</span>
      adv_d_mmap_fold<span class="main">[</span><span class="operator">OF</span> inv_st adv_d<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> adv_d_def<span class="main"><span class="main">]</span></span><span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> mmap_lookup_update'<span class="main">:</span>
  <span class="quoted"><span class="quoted">"mmap_lookup <span class="main">(</span>mmap_update <span class="free">k</span> <span class="free">v</span> <span class="free">kvs</span><span class="main">)</span> <span class="free">z</span> <span class="main">=</span> <span class="main">(</span><span class="keyword1">if</span> <span class="free">k</span> <span class="main">=</span> <span class="free">z</span> <span class="keyword1">then</span> Some <span class="free">v</span> <span class="keyword1">else</span> mmap_lookup <span class="free">kvs</span> <span class="free">z</span><span class="main">)</span>"</span></span>
  <span class="keyword1"><span class="command">unfolding</span></span> mmap_lookup_def mmap_update_def
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> update_conv'<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> mmap_keys_update<span class="main">:</span> <span class="quoted"><span class="quoted">"mmap_keys <span class="main">(</span>mmap_update <span class="free">k</span> <span class="free">v</span> <span class="free">kvs</span><span class="main">)</span> <span class="main">=</span> mmap_keys <span class="free">kvs</span> <span class="main">∪</span> <span class="main">{</span><span class="free">k</span><span class="main">}</span>"</span></span>
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">induction</span> <span class="quoted"><span class="free">kvs</span></span><span class="main">)</span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> mmap_keys_def mmap_update_def<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_adv_start<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"w_i <span class="free">w</span> <span class="main">&lt;</span> w_j <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span>adv_start <span class="free">args</span> <span class="free">w</span><span class="main">)</span>"</span></span>
<span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">init</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">init</span> <span class="main">=</span> w_init <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">step</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">step</span> <span class="main">=</span> w_step <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">accept</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">accept</span> <span class="main">=</span> w_accept <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">run_t</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">run_t</span> <span class="main">=</span> w_run_t <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">run_sub</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">run_sub</span> <span class="main">=</span> w_run_sub <span class="free">args</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">st</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">st</span> <span class="main">=</span> w_st <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ac</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ac</span> <span class="main">=</span> w_ac <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">=</span> w_i <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">ti</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">ti</span> <span class="main">=</span> w_ti <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">si</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">si</span> <span class="main">=</span> w_si <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">j</span> <span class="main">=</span> w_j <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">tj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">tj</span> <span class="main">=</span> w_tj <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">sj</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">sj</span> <span class="main">=</span> w_sj <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s</span> <span class="main">=</span> w_s <span class="free">w</span>"</span></span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e</span> <span class="main">=</span> w_e <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> valid_before<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">ti</span><span class="main">,</span> <span class="skolem">si</span><span class="main">,</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">tj</span><span class="main">,</span> <span class="skolem">sj</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">i</span> <span class="bound">j</span><span class="main">.</span> <span class="bound">i</span> <span class="main">≤</span> <span class="bound">j</span> <span class="main">⟹</span> <span class="bound">j</span> <span class="main">&lt;</span> length <span class="free">rho</span> <span class="main">⟹</span> ts_at <span class="free">rho</span> <span class="bound">i</span> <span class="main">≤</span> ts_at <span class="free">rho</span> <span class="bound">j</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">st</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="skolem">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">ac</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="skolem">accept</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span><span class="main">.</span> mmap_lookup <span class="skolem">e</span> <span class="bound">q</span> <span class="main">=</span> sup_leadsto <span class="skolem">init</span> <span class="skolem">step</span> <span class="free">rho</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="bound">q</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"valid_s <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">st</span> <span class="skolem">accept</span> <span class="free">rho</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> assms<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">unfolding</span></span> valid_window_def valid_s_def Let_def init_def step_def accept_def run_t_def
        run_sub_def st_def ac_def i_def ti_def si_def j_def tj_def sj_def s_def e_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> distinct_before<span class="main">:</span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">s</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">e</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_s_def<span class="main">)</span>
  <span class="keyword1"><span class="command">note</span></span> i_lt_j <span class="main">=</span> assms<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">folded</span> i_def j_def<span class="main">]</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ti'</span></span> <span class="skolem"><span class="skolem">si'</span></span> <span class="skolem"><span class="skolem">t</span></span> <span class="skolem"><span class="skolem">b</span></span> <span class="keyword2"><span class="keyword">where</span></span> tb_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">run_t</span> <span class="skolem">ti</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ti'</span><span class="main">,</span> <span class="skolem">t</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">run_sub</span> <span class="skolem">si</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">si'</span><span class="main">,</span> <span class="skolem">b</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"reach_sub <span class="skolem">run_t</span> <span class="skolem">ti'</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tj</span>"</span></span>
    <span class="quoted"><span class="quoted">"reach_sub <span class="skolem">run_sub</span> <span class="skolem">si'</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span><span class="main">)</span> <span class="skolem">sj</span>"</span></span>
    <span class="quoted"><span class="quoted">"<span class="skolem">t</span> <span class="main">=</span> ts_at <span class="free">rho</span> <span class="skolem">i</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b</span> <span class="main">=</span> bs_at <span class="free">rho</span> <span class="skolem">i</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before i_lt_j
    <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_at_def bs_at_def run_t_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> run_sub_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
        <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reach_sub.cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">run_t</span></span> <span class="quoted"><span class="skolem">ti</span></span> <span class="quoted"><span class="quoted">"drop <span class="skolem">i</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">tj</span></span><span class="main"><span class="main">]</span></span>
        reach_sub.cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">run_sub</span></span> <span class="quoted"><span class="skolem">si</span></span> <span class="quoted"><span class="quoted">"drop <span class="skolem">i</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">sj</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_nth_drop_Suc length_map list.inject nth_map<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> reach_sub_si'<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="skolem">run_sub</span> <span class="free">sub</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span><span class="main">)</span> <span class="skolem">si'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before tb_def<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> i_lt_j reach_sub_app tb_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_sub_def sub_def bs_at_def take_Suc_conv_app_nth reach_sub_app tb_def<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> reach_sub_ti'<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="skolem">run_t</span> <span class="free">t0</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">i</span><span class="main">)</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ti'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before tb_def<span class="main">(</span>2<span class="main">,</span>3<span class="main">,</span>4<span class="main">)</span> i_lt_j reach_sub_app tb_def<span class="main">(</span>1<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_t_def ts_at_def take_Suc_conv_app_nth reach_sub_app tb_def<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">e'</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">e'</span> <span class="main">=</span> mmap_update <span class="main">(</span>fst <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="skolem">s</span> <span class="skolem">init</span><span class="main">)</span><span class="main">)</span><span class="main">)</span> <span class="skolem">t</span> <span class="skolem">e</span>"</span></span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st'</span></span> <span class="skolem"><span class="skolem">s'</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"adv_d <span class="skolem">step</span> <span class="skolem">st</span> <span class="skolem">i</span> <span class="skolem">b</span> <span class="skolem">s</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">s'</span><span class="main">,</span> <span class="skolem">st'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> old.prod.exhaust<span class="main">)</span>
  <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st_cur</span></span> <span class="skolem"><span class="skolem">ac_cur</span></span> <span class="skolem"><span class="skolem">i_cur</span></span> <span class="skolem"><span class="skolem">ti_cur</span></span> <span class="skolem"><span class="skolem">si_cur</span></span> <span class="skolem"><span class="skolem">q_cur</span></span> <span class="skolem"><span class="skolem">s_cur</span></span> <span class="skolem"><span class="skolem">tstp_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> loop_def<span class="main">:</span>
    <span class="quoted"><span class="quoted">"<span class="main">(</span><span class="skolem">st_cur</span><span class="main">,</span> <span class="skolem">ac_cur</span><span class="main">,</span> <span class="skolem">i_cur</span><span class="main">,</span> <span class="skolem">ti_cur</span><span class="main">,</span> <span class="skolem">si_cur</span><span class="main">,</span> <span class="skolem">q_cur</span><span class="main">,</span> <span class="skolem">s_cur</span><span class="main">,</span> <span class="skolem">tstp_cur</span><span class="main">)</span> <span class="main">=</span>
      while <span class="main">(</span>loop_cond <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>loop_body <span class="skolem">step</span> <span class="skolem">accept</span> <span class="skolem">run_t</span> <span class="skolem">run_sub</span><span class="main">)</span>
      <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> <span class="skolem">ac</span><span class="main">,</span> Suc <span class="skolem">i</span><span class="main">,</span> <span class="skolem">ti'</span><span class="main">,</span> <span class="skolem">si'</span><span class="main">,</span> <span class="skolem">init</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"while <span class="main">(</span>loop_cond <span class="skolem">j</span><span class="main">)</span> <span class="main">(</span>loop_body <span class="skolem">step</span> <span class="skolem">accept</span> <span class="skolem">run_t</span> <span class="skolem">run_sub</span><span class="main">)</span>
        <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> <span class="skolem">ac</span><span class="main">,</span> Suc <span class="skolem">i</span><span class="main">,</span> <span class="skolem">ti'</span><span class="main">,</span> <span class="skolem">si'</span><span class="main">,</span> <span class="skolem">init</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> None<span class="main">)</span>"</span></span><span class="main">)</span> <span class="operator">auto</span>
  <span class="keyword3"><span class="command">define</span></span> <span class="skolem"><span class="skolem">s''</span></span> <span class="keyword2"><span class="keyword">where</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">s''</span> <span class="main">=</span> mmap_update <span class="skolem">init</span> <span class="main">(</span><span class="keyword1">case</span> mmap_lookup <span class="skolem">s_cur</span> <span class="skolem">q_cur</span> <span class="keyword1">of</span>
    Some <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">tstp'</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="keyword1">case</span> <span class="bound">tstp'</span> <span class="keyword1">of</span> Some <span class="main">(</span><span class="bound">ts</span><span class="main">,</span> <span class="bound">tp</span><span class="main">)</span> <span class="main">⇒</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">tstp'</span><span class="main">)</span> <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="skolem">tstp_cur</span><span class="main">)</span><span class="main">)</span>
    <span class="main">|</span> None <span class="main">⇒</span> <span class="main">(</span><span class="skolem">q_cur</span><span class="main">,</span> <span class="skolem">tstp_cur</span><span class="main">)</span><span class="main">)</span> <span class="skolem">s'</span>"</span></span>
  <span class="keyword1"><span class="command">have</span></span> i_le_j<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i_lt_j <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> length_rho<span class="main">:</span> <span class="quoted"><span class="quoted">"length <span class="free">rho</span> <span class="main">=</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lookup_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">q'</span> <span class="bound">tstp</span><span class="main">.</span> mmap_lookup <span class="skolem">s</span> <span class="bound">q</span> <span class="main">=</span> Some <span class="main">(</span><span class="bound">q'</span><span class="main">,</span> <span class="bound">tstp</span><span class="main">)</span> <span class="main">⟹</span>
    steps <span class="skolem">step</span> <span class="free">rho</span> <span class="bound">q</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="bound">q'</span> <span class="main">∧</span> <span class="bound">tstp</span> <span class="main">=</span> sup_acc <span class="skolem">step</span> <span class="skolem">accept</span> <span class="free">rho</span> <span class="bound">q</span> <span class="skolem">i</span> <span class="skolem">j</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before Mapping_keys_intro
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_s_def<span class="main">)</span> <span class="main">(</span><span class="operator">smt</span> case_prodD option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span><span class="main"><span class="keyword3">+</span></span>
  <span class="keyword1"><span class="command">have</span></span> init_in_keys_s<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">init</span> <span class="main">∈</span> mmap_keys <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> valid_s_def<span class="main">)</span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> run_init_i_j<span class="main">:</span> <span class="quoted"><span class="quoted">"steps <span class="skolem">step</span> <span class="free">rho</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> fst <span class="main">(</span>the <span class="main">(</span>mmap_lookup <span class="skolem">s</span> <span class="skolem">init</span><span class="main">)</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> lookup_s <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
  <span class="keyword1"><span class="command">have</span></span> lookup_e<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> mmap_lookup <span class="skolem">e</span> <span class="bound">q</span> <span class="main">=</span> sup_leadsto <span class="skolem">init</span> <span class="skolem">step</span> <span class="free">rho</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="bound">q</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> lookup_e'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span><span class="main">.</span> mmap_lookup <span class="skolem">e'</span> <span class="bound">q</span> <span class="main">=</span> sup_leadsto <span class="skolem">init</span> <span class="skolem">step</span> <span class="free">rho</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="bound">q</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="operator">-</span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">q</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="skolem">e'</span> <span class="skolem">q</span> <span class="main">=</span> sup_leadsto <span class="skolem">init</span> <span class="skolem">step</span> <span class="free">rho</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">q</span>"</span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"steps <span class="skolem">step</span> <span class="free">rho</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q</span>"</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> True
      <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"Max <span class="main">{</span><span class="bound">l</span><span class="main">.</span> <span class="bound">l</span> <span class="main">&lt;</span> Suc <span class="skolem">i</span> <span class="main">∧</span> steps <span class="skolem">step</span> <span class="free">rho</span> <span class="skolem">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> steps <span class="skolem">step</span> <span class="free">rho</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">i</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span><span class="main">}</span> <span class="main">=</span> <span class="skolem">i</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">rule</span> iffD2<span class="main"><span class="main">[</span></span><span class="operator">OF</span> Max_eq_iff<span class="main"><span class="main">]</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"sup_leadsto <span class="skolem">init</span> <span class="skolem">step</span> <span class="free">rho</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">q</span> <span class="main">=</span> Some <span class="main">(</span>ts_at <span class="free">rho</span> <span class="skolem">i</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> sup_leadsto_def True<span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> e'_def <span class="keyword1"><span class="command">using</span></span> run_init_i_j tb_def
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mmap_lookup_update' True<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> False
      <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> run_init_i_j sup_leadsto_idle<span class="main">[</span><span class="operator">OF</span> i_lt_j False<span class="main">]</span> lookup_e<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">q</span></span><span class="main">]</span> False
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> e'_def mmap_lookup_update'<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> reach_split<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">l</span></span><span class="main">≤</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">.</span> steps <span class="skolem">step</span> <span class="free">rho</span> <span class="skolem">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="bound">q</span><span class="main">}</span> <span class="main">=</span>
    <span class="main">{</span><span class="bound">q</span><span class="main">.</span> <span class="main">∃</span><span class="bound"><span class="bound">l</span></span><span class="main">≤</span><span class="skolem">i</span><span class="main">.</span> steps <span class="skolem">step</span> <span class="free">rho</span> <span class="skolem">init</span> <span class="main">(</span><span class="bound">l</span><span class="main">,</span> <span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">=</span> <span class="bound">q</span><span class="main">}</span> <span class="main">∪</span> <span class="main">{</span><span class="skolem">init</span><span class="main">}</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> le_Suc_eq <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> valid_s_i<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_s <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">st</span> <span class="skolem">accept</span> <span class="free">rho</span> <span class="skolem">i</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">s</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_before <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> valid_s'_Suc_i<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_s <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">st'</span> <span class="skolem">accept</span> <span class="free">rho</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">s'</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> valid_adv_d<span class="main">[</span><span class="operator">OF</span> valid_s_i order.refl i_lt_j<span class="main">,</span> <span class="operator">OF</span> tb_def<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span> s'_def<span class="main">]</span> <span class="keyword1"><span class="command">unfolding</span></span> s'_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">have</span></span> loop<span class="main">:</span> <span class="quoted"><span class="quoted">"loop_inv <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">accept</span> <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span>
    <span class="main">(</span><span class="skolem">st_cur</span><span class="main">,</span> <span class="skolem">ac_cur</span><span class="main">,</span> <span class="skolem">i_cur</span><span class="main">,</span> <span class="skolem">ti_cur</span><span class="main">,</span> <span class="skolem">si_cur</span><span class="main">,</span> <span class="skolem">q_cur</span><span class="main">,</span> <span class="skolem">s_cur</span><span class="main">,</span> <span class="skolem">tstp_cur</span><span class="main">)</span> <span class="main">∧</span>
    <span class="main">¬</span>loop_cond <span class="skolem">j</span> <span class="main">(</span><span class="skolem">st_cur</span><span class="main">,</span> <span class="skolem">ac_cur</span><span class="main">,</span> <span class="skolem">i_cur</span><span class="main">,</span> <span class="skolem">ti_cur</span><span class="main">,</span> <span class="skolem">si_cur</span><span class="main">,</span> <span class="skolem">q_cur</span><span class="main">,</span> <span class="skolem">s_cur</span><span class="main">,</span> <span class="skolem">tstp_cur</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> loop_def
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">rule</span> while_rule_lemma<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="quoted"><span class="quoted">"loop_inv <span class="skolem"><span class="skolem">init</span></span> <span class="skolem"><span class="skolem">step</span></span> <span class="skolem"><span class="skolem">accept</span></span> <span class="free"><span class="free">args</span></span> <span class="free"><span class="free">t0</span></span> <span class="free"><span class="free">sub</span></span> <span class="free"><span class="free">rho</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">tj</span></span> <span class="skolem"><span class="skolem">sj</span></span>"</span></span></span>
        <span class="quoted"><span class="quoted"><span class="quoted">"loop_cond <span class="skolem"><span class="skolem">j</span></span>"</span></span></span> <span class="quoted"><span class="quoted"><span class="quoted">"loop_body <span class="skolem"><span class="skolem">step</span></span> <span class="skolem"><span class="skolem">accept</span></span> <span class="skolem"><span class="skolem">run_t</span></span> <span class="skolem"><span class="skolem">run_sub</span></span>"</span></span></span>
        <span class="quoted"><span class="quoted"><span class="quoted">"<span class="main"><span class="main">λ</span></span><span class="bound"><span class="bound">s</span></span><span class="main"><span class="main">.</span></span> loop_inv <span class="skolem"><span class="skolem">init</span></span> <span class="skolem"><span class="skolem">step</span></span> <span class="skolem"><span class="skolem">accept</span></span> <span class="free"><span class="free">args</span></span> <span class="free"><span class="free">t0</span></span> <span class="free"><span class="free">sub</span></span> <span class="free"><span class="free">rho</span></span> <span class="skolem"><span class="skolem">i</span></span> <span class="skolem"><span class="skolem">j</span></span> <span class="skolem"><span class="skolem">tj</span></span> <span class="skolem"><span class="skolem">sj</span></span> <span class="bound"><span class="bound">s</span></span> <span class="main"><span class="main">∧</span></span> <span class="main"><span class="main">¬</span></span> loop_cond <span class="skolem"><span class="skolem">j</span></span> <span class="bound"><span class="bound">s</span></span>"</span></span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"loop_inv <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">accept</span> <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span>
      <span class="main">(</span><span class="skolem">st'</span><span class="main">,</span> <span class="skolem">ac</span><span class="main">,</span> Suc <span class="skolem">i</span><span class="main">,</span> <span class="skolem">ti'</span><span class="main">,</span> <span class="skolem">si'</span><span class="main">,</span> <span class="skolem">init</span><span class="main">,</span> <span class="skolem">s'</span><span class="main">,</span> None<span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def
      <span class="keyword1"><span class="command">using</span></span> i_lt_j valid_s'_Suc_i sup_acc_same<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">step</span></span> <span class="quoted"><span class="skolem">accept</span></span> <span class="quoted"><span class="free">rho</span></span><span class="main">]</span>
        length_rho reach_sub_si' reach_sub_ti' tb_def<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> valid_before<span class="main">(</span>4<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_t_def run_sub_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"<span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> loop_inv <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">accept</span> <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="bound">s</span> <span class="main">∧</span>
      loop_cond <span class="skolem">j</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">=</span> loop_body <span class="skolem">step</span> <span class="skolem">accept</span> <span class="skolem">run_t</span> <span class="skolem">run_sub</span> <span class="bound">s</span><span class="main">}</span> <span class="main">⊆</span>
      measure <span class="main">(</span><span class="main">λ</span><span class="main">(</span><span class="bound">st</span><span class="main">,</span> <span class="bound">ac</span><span class="main">,</span> <span class="bound">i_cur</span><span class="main">,</span> <span class="bound">ti</span><span class="main">,</span> <span class="bound">si</span><span class="main">,</span> <span class="bound">q</span><span class="main">,</span> <span class="bound">s</span><span class="main">,</span> <span class="bound">tstp</span><span class="main">)</span><span class="main">.</span> <span class="skolem">j</span> <span class="main">-</span> <span class="bound">i_cur</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def loop_cond_def loop_body_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_t_def run_sub_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> drop_eq_Nil length_map not_less option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> reach_sub.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">metis</span> <span class="main"><span class="main">(</span></span>no_types<span class="main"><span class="main">,</span></span> lifting<span class="main"><span class="main">)</span></span> drop_eq_Nil length_map not_less option.distinct<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span>
          reach_sub.simps<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">done</span></span></span></span>
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"wf <span class="main">{</span><span class="main">(</span><span class="bound">t</span><span class="main">,</span> <span class="bound">s</span><span class="main">)</span><span class="main">.</span> loop_inv <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">accept</span> <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="bound">s</span> <span class="main">∧</span>
      loop_cond <span class="skolem">j</span> <span class="bound">s</span> <span class="main">∧</span> <span class="bound">t</span> <span class="main">=</span> loop_body <span class="skolem">step</span> <span class="skolem">accept</span> <span class="skolem">run_t</span> <span class="skolem">run_sub</span> <span class="bound">s</span><span class="main">}</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> wf_measure wf_subset <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">fix</span></span> <span class="skolem">state</span>
    <span class="keyword3"><span class="command">assume</span></span> assms<span class="main">:</span> <span class="quoted"><span class="quoted">"loop_inv <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">accept</span> <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span> <span class="skolem">state</span>"</span></span>
      <span class="quoted"><span class="quoted">"loop_cond <span class="skolem">j</span> <span class="skolem">state</span>"</span></span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">st_cur</span></span> <span class="skolem"><span class="skolem">ac_cur</span></span> <span class="skolem"><span class="skolem">i_cur</span></span> <span class="skolem"><span class="skolem">ti_cur</span></span> <span class="skolem"><span class="skolem">si_cur</span></span> <span class="skolem"><span class="skolem">q_cur</span></span> <span class="skolem"><span class="skolem">s_cur</span></span> <span class="skolem"><span class="skolem">tstp_cur</span></span>
      <span class="keyword2"><span class="keyword">where</span></span> state_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">state</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">st_cur</span><span class="main">,</span> <span class="skolem">ac_cur</span><span class="main">,</span> <span class="skolem">i_cur</span><span class="main">,</span> <span class="skolem">ti_cur</span><span class="main">,</span> <span class="skolem">si_cur</span><span class="main">,</span> <span class="skolem">q_cur</span><span class="main">,</span> <span class="skolem">s_cur</span><span class="main">,</span> <span class="skolem">tstp_cur</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">state</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ti'_cur</span></span> <span class="skolem"><span class="skolem">si'_cur</span></span> <span class="skolem"><span class="skolem">t_cur</span></span> <span class="skolem"><span class="skolem">b_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> tb_cur_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">run_t</span> <span class="skolem">ti_cur</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">ti'_cur</span><span class="main">,</span> <span class="skolem">t_cur</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">run_sub</span> <span class="skolem">si_cur</span> <span class="main">=</span> Some <span class="main">(</span><span class="skolem">si'_cur</span><span class="main">,</span> <span class="skolem">b_cur</span><span class="main">)</span>"</span></span>
      <span class="quoted"><span class="quoted">"reach_sub <span class="skolem">run_t</span> <span class="skolem">ti'_cur</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">i_cur</span><span class="main">)</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span><span class="main">)</span> <span class="skolem">tj</span>"</span></span>
      <span class="quoted"><span class="quoted">"reach_sub <span class="skolem">run_sub</span> <span class="skolem">si'_cur</span> <span class="main">(</span>drop <span class="main">(</span>Suc <span class="skolem">i_cur</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span><span class="main">)</span> <span class="skolem">sj</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">t_cur</span> <span class="main">=</span> ts_at <span class="free">rho</span> <span class="skolem">i_cur</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">b_cur</span> <span class="main">=</span> bs_at <span class="free">rho</span> <span class="skolem">i_cur</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def loop_cond_def state_def
      <span class="keyword1"><span class="command"><span class="improper"><span class="command">apply</span></span></span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> ts_at_def bs_at_def run_t_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span> run_sub_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span>
          <span class="quasi_keyword">elim</span><span class="main"><span class="main">!</span></span><span class="main"><span class="main">:</span></span> reach_sub.cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">run_t</span></span> <span class="quoted"><span class="skolem">ti_cur</span></span> <span class="quoted"><span class="quoted">"drop <span class="skolem">i_cur</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">tj</span></span><span class="main"><span class="main">]</span></span>
          reach_sub.cases<span class="main"><span class="main">[</span></span><span class="operator">of</span> <span class="quoted"><span class="skolem">run_sub</span></span> <span class="quoted"><span class="skolem">si_cur</span></span> <span class="quoted"><span class="quoted">"drop <span class="skolem">i_cur</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="skolem">sj</span></span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">metis</span> Cons_nth_drop_Suc length_map list.inject nth_map<span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">s'_cur</span></span> <span class="skolem"><span class="skolem">st'_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> s'_cur_def<span class="main">:</span> <span class="quoted"><span class="quoted">"adv_d <span class="skolem">step</span> <span class="skolem">st_cur</span> <span class="skolem">i_cur</span> <span class="skolem">b_cur</span> <span class="skolem">s_cur</span> <span class="main">=</span>
      <span class="main">(</span><span class="skolem">s'_cur</span><span class="main">,</span> <span class="skolem">st'_cur</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> valid_s'_cur<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_s <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">st'_cur</span> <span class="skolem">accept</span> <span class="free">rho</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">i_cur</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">s'_cur</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms valid_adv_d<span class="main">[</span><span class="operator">of</span> <span class="quoted"><span class="skolem">init</span></span> <span class="quoted"><span class="skolem">step</span></span> <span class="quoted"><span class="skolem">st_cur</span></span> <span class="quoted"><span class="skolem">accept</span></span> <span class="quoted"><span class="free">rho</span></span><span class="main">]</span> tb_cur_def<span class="main">(</span>6<span class="main">)</span> s'_cur_def
      <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def loop_cond_def state_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">st''_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> q'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"cstep <span class="skolem">step</span> <span class="skolem">st'_cur</span> <span class="skolem">q_cur</span> <span class="skolem">b_cur</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">st''_cur</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">β</span></span> <span class="skolem"><span class="skolem">ac'_cur</span></span> <span class="keyword2"><span class="keyword">where</span></span> b_def<span class="main">:</span> <span class="quoted"><span class="quoted">"cac <span class="skolem">accept</span> <span class="skolem">ac_cur</span> <span class="skolem">q_cur</span> <span class="skolem">b_cur</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">β</span><span class="main">,</span> <span class="skolem">ac'_cur</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">fastforce</span>
    <span class="keyword1"><span class="command">have</span></span> step<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">q'</span> <span class="main">=</span> <span class="skolem">step</span> <span class="skolem">q_cur</span> <span class="skolem">b_cur</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">st''_cur</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="skolem">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_s'_cur q'_def
      <span class="keyword1"><span class="command">unfolding</span></span> valid_s_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cstep_def Let_def Mapping.lookup_update' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> accept<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> <span class="skolem">accept</span> <span class="skolem">q_cur</span> <span class="skolem">b_cur</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">⋀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">ac'_cur</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span>
      None <span class="main">⇒</span> True <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="skolem">accept</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms b_def
      <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def state_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> cac_def Let_def Mapping.lookup_update' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits if_splits<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> q_cur_def<span class="main">:</span> <span class="quoted"><span class="quoted">"steps <span class="skolem">step</span> <span class="free">rho</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">i_cur</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q_cur</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def state_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> b_acc<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">β</span> <span class="main">=</span> acc <span class="skolem">step</span> <span class="skolem">accept</span> <span class="free">rho</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">i_cur</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> accept<span class="main">(</span>1<span class="main">)</span> acc_def q_cur_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tb_cur_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> valid_s''_cur<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_s <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">st''_cur</span> <span class="skolem">accept</span> <span class="free">rho</span> <span class="skolem">i</span> <span class="main">(</span><span class="skolem">i_cur</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">s'_cur</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_s'_cur step<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> valid_s_def
      <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> reach_sub_si'<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="skolem">run_sub</span> <span class="free">sub</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">i_cur</span><span class="main">)</span> <span class="main">(</span>map snd <span class="free">rho</span><span class="main">)</span><span class="main">)</span> <span class="skolem">si'_cur</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def loop_cond_def state_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_sub_def sub_def bs_at_def take_Suc_conv_app_nth reach_sub_app
          tb_cur_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">,</span></span>4<span class="main"><span class="main">,</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">metis</span> bs_at_def reach_sub_app run_sub_def tb_cur_def<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span> tb_cur_def<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> reach_sub_ti'<span class="main">:</span> <span class="quoted"><span class="quoted">"reach_sub <span class="skolem">run_t</span> <span class="free">t0</span> <span class="main">(</span>take <span class="main">(</span>Suc <span class="skolem">i_cur</span><span class="main">)</span> <span class="main">(</span>map fst <span class="free">rho</span><span class="main">)</span><span class="main">)</span> <span class="skolem">ti'_cur</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms
      <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def loop_cond_def state_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_t_def ts_at_def take_Suc_conv_app_nth reach_sub_app tb_cur_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>3<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
         <span class="main">(</span><span class="operator">metis</span> reach_sub_app run_t_def tb_cur_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">)</span></span> tb_cur_def<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span> ts_at_def<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"reach_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="main">(</span>Suc <span class="skolem">i_cur</span><span class="main">,</span> <span class="skolem">ti'_cur</span><span class="main">,</span> <span class="skolem">si'_cur</span><span class="main">,</span> <span class="skolem">j</span><span class="main">,</span> <span class="skolem">tj</span><span class="main">,</span> <span class="skolem">sj</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> reach_sub_si' reach_sub_ti' tb_cur_def<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> length_rho assms<span class="main">(</span>2<span class="main">)</span>
      <span class="keyword1"><span class="command">unfolding</span></span> loop_cond_def state_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> run_t_def run_sub_def<span class="main">)</span>
    <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"steps <span class="skolem">step</span> <span class="free">rho</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> Suc <span class="skolem">i_cur</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms steps_app
      <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def state_def step<span class="main">(</span>1<span class="main">)</span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tb_cur_def<span class="main"><span class="main">(</span></span>6<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="quoted"><span class="quoted">"loop_inv <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">accept</span> <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="skolem">i</span> <span class="skolem">j</span> <span class="skolem">tj</span> <span class="skolem">sj</span>
      <span class="main">(</span>loop_body <span class="skolem">step</span> <span class="skolem">accept</span> <span class="skolem">run_t</span> <span class="skolem">run_sub</span> <span class="skolem">state</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> assms accept<span class="main">(</span>2<span class="main">)</span> valid_s''_cur sup_acc_ext<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">step</span></span> <span class="quoted"><span class="skolem">accept</span></span> <span class="quoted"><span class="free">rho</span></span><span class="main">]</span>
        sup_acc_ext_idle<span class="main">[</span><span class="operator">of</span> <span class="main">_</span> <span class="main">_</span> <span class="quoted"><span class="skolem">step</span></span> <span class="quoted"><span class="skolem">accept</span></span> <span class="quoted"><span class="free">rho</span></span><span class="main">]</span>
      <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def loop_body_def state_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> tb_cur_def<span class="main"><span class="main">(</span></span>1<span class="main"><span class="main">,</span></span>2<span class="main"><span class="main">,</span></span>5<span class="main"><span class="main">)</span></span> s'_cur_def q'_def b_def b_acc
          <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">qed</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> valid_stac_cur<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">st_cur</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True
    <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="skolem">step</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="main">∀</span><span class="bound">q</span> <span class="bound">bs</span><span class="main">.</span> <span class="keyword1">case</span> Mapping.lookup <span class="skolem">ac_cur</span> <span class="main">(</span><span class="bound">q</span><span class="main">,</span> <span class="bound">bs</span><span class="main">)</span> <span class="keyword1">of</span> None <span class="main">⇒</span> True
    <span class="main">|</span> Some <span class="bound">v</span> <span class="main">⇒</span> <span class="skolem">accept</span> <span class="bound">q</span> <span class="bound">bs</span> <span class="main">=</span> <span class="bound">v</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> loop <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def valid_s_def
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
  <span class="keyword1"><span class="command">have</span></span> valid_s''<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_s <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">st_cur</span> <span class="skolem">accept</span> <span class="free">rho</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span> <span class="skolem">s''</span>"</span></span>
  <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="quoted">"mmap_lookup <span class="skolem">s_cur</span> <span class="skolem">q_cur</span>"</span></span><span class="main">)</span>
    <span class="keyword3"><span class="command">case</span></span> None
    <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> added<span class="main">:</span> <span class="quoted"><span class="quoted">"steps <span class="skolem">step</span> <span class="free">rho</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q_cur</span>"</span></span>
      <span class="quoted"><span class="quoted">"<span class="skolem">tstp_cur</span> <span class="main">=</span> sup_acc <span class="skolem">step</span> <span class="skolem">accept</span> <span class="free">rho</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> loop <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def loop_cond_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">dest</span><span class="main"><span class="main">:</span></span> Mapping_keys_dest<span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> s''_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s''</span> <span class="main">=</span> mmap_update <span class="skolem">init</span> <span class="main">(</span><span class="skolem">q_cur</span><span class="main">,</span> <span class="skolem">tstp_cur</span><span class="main">)</span> <span class="skolem">s'</span>"</span></span>
      <span class="keyword1"><span class="command">unfolding</span></span> s''_def <span class="keyword1"><span class="command">using</span></span> None <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
      <span class="keyword1"><span class="command">using</span></span> valid_s'_Suc_i reach_split added mmap_update_distinct valid_stac_cur
      <span class="keyword1"><span class="command">unfolding</span></span> s''_case valid_s_def mmap_keys_update
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mmap_lookup_update' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">next</span></span>
    <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">p</span><span class="main">)</span>
    <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">q'</span></span> <span class="skolem"><span class="skolem">tstp'</span></span> <span class="keyword2"><span class="keyword">where</span></span> p_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">tstp'</span><span class="main">)</span>"</span></span>
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p</span></span><span class="main">)</span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">note</span></span> lookup_s_cur <span class="main">=</span> Some<span class="main">[</span><span class="operator">unfolded</span> p_def<span class="main">]</span>
    <span class="keyword1"><span class="command">have</span></span> i_cur_in<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span> <span class="main">≤</span> <span class="skolem">i_cur</span>"</span></span> <span class="quoted"><span class="quoted">"<span class="skolem">i_cur</span> <span class="main">≤</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> loop <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> q_cur_def<span class="main">:</span> <span class="quoted"><span class="quoted">"steps <span class="skolem">step</span> <span class="free">rho</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">i_cur</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q_cur</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> loop <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> valid_s_cur<span class="main">:</span> <span class="quoted"><span class="quoted">"valid_s <span class="skolem">init</span> <span class="skolem">step</span> <span class="skolem">st_cur</span> <span class="skolem">accept</span> <span class="free">rho</span> <span class="skolem">i</span> <span class="skolem">i_cur</span> <span class="skolem">j</span> <span class="skolem">s_cur</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> loop <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> q'_steps<span class="main">:</span> <span class="quoted"><span class="quoted">"steps <span class="skolem">step</span> <span class="free">rho</span> <span class="skolem">q_cur</span> <span class="main">(</span><span class="skolem">i_cur</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> Some valid_s_cur <span class="keyword1"><span class="command">unfolding</span></span> valid_s_def p_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro<span class="main">)</span> <span class="main">(</span><span class="operator">smt</span> case_prodD option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> tstp_cur<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tstp_cur</span> <span class="main">=</span> sup_acc <span class="skolem">step</span> <span class="skolem">accept</span> <span class="free">rho</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">i_cur</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> loop <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
    <span class="keyword1"><span class="command">have</span></span> tstp'<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tstp'</span> <span class="main">=</span> sup_acc <span class="skolem">step</span> <span class="skolem">accept</span> <span class="free">rho</span> <span class="skolem">q_cur</span> <span class="skolem">i_cur</span> <span class="skolem">j</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> loop Some <span class="keyword1"><span class="command">unfolding</span></span> loop_inv_def p_def valid_s_def
      <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">intro</span><span class="main"><span class="main">:</span></span> Mapping_keys_intro<span class="main">)</span> <span class="main">(</span><span class="operator">smt</span> case_prodD option.simps<span class="main"><span class="main">(</span></span>5<span class="main"><span class="main">)</span></span><span class="main">)</span>
    <span class="keyword1"><span class="command">have</span></span> added<span class="main">:</span> <span class="quoted"><span class="quoted">"steps <span class="skolem">step</span> <span class="free">rho</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">,</span> <span class="skolem">j</span><span class="main">)</span> <span class="main">=</span> <span class="skolem">q'</span>"</span></span>
      <span class="keyword1"><span class="command">using</span></span> steps_comp<span class="main">[</span><span class="operator">OF</span> i_cur_in q_cur_def q'_steps<span class="main">]</span> <span class="keyword1"><span class="command">.</span></span>
    <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">proof</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">tstp'</span></span><span class="main">)</span>
      <span class="keyword3"><span class="command">case</span></span> None
      <span class="keyword1"><span class="command">have</span></span> s''_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s''</span> <span class="main">=</span> mmap_update <span class="skolem">init</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">tstp_cur</span><span class="main">)</span> <span class="skolem">s'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> s''_def lookup_s_cur None <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> tstp_cur_opt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tstp_cur</span> <span class="main">=</span> sup_acc <span class="skolem">step</span> <span class="skolem">accept</span> <span class="free">rho</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sup_acc_comp_None<span class="main">[</span><span class="operator">OF</span> i_cur_in<span class="main">,</span> <span class="operator">of</span> <span class="quoted"><span class="skolem">step</span></span> <span class="quoted"><span class="skolem">accept</span></span> <span class="quoted"><span class="free">rho</span></span> <span class="quoted"><span class="skolem">init</span></span><span class="main">,</span> <span class="operator">unfolded</span> q_cur_def<span class="main">,</span>
            <span class="operator">OF</span> tstp'<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> None<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> tstp_cur <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> valid_s'_Suc_i reach_split added mmap_update_distinct valid_stac_cur
        <span class="keyword1"><span class="command">unfolding</span></span> s''_case valid_s_def mmap_keys_update
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mmap_lookup_update' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">next</span></span>
      <span class="keyword3"><span class="command">case</span></span> <span class="main">(</span>Some <span class="skolem">p'</span><span class="main">)</span>
      <span class="keyword3"><span class="command">obtain</span></span> <span class="skolem"><span class="skolem">ts</span></span> <span class="skolem"><span class="skolem">tp</span></span> <span class="keyword2"><span class="keyword">where</span></span> p'_def<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">p'</span> <span class="main">=</span> <span class="main">(</span><span class="skolem">ts</span><span class="main">,</span> <span class="skolem">tp</span><span class="main">)</span>"</span></span>
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">cases</span> <span class="quoted"><span class="skolem">p'</span></span><span class="main">)</span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> True<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tp</span> <span class="main">≥</span> <span class="skolem">i_cur</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sup_acc_SomeE<span class="main">[</span><span class="operator">OF</span> tstp'<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Some p'_def<span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span> <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> s''_case<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">s''</span> <span class="main">=</span> mmap_update <span class="skolem">init</span> <span class="main">(</span><span class="skolem">q'</span><span class="main">,</span> <span class="skolem">tstp'</span><span class="main">)</span> <span class="skolem">s'</span>"</span></span>
        <span class="keyword1"><span class="command">unfolding</span></span> s''_def lookup_s_cur Some p'_def <span class="keyword1"><span class="command">using</span></span> True <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
      <span class="keyword1"><span class="command">have</span></span> tstp'_opt<span class="main">:</span> <span class="quoted"><span class="quoted">"<span class="skolem">tstp'</span> <span class="main">=</span> sup_acc <span class="skolem">step</span> <span class="skolem">accept</span> <span class="free">rho</span> <span class="skolem">init</span> <span class="main">(</span><span class="skolem">i</span> <span class="main">+</span> <span class="main">1</span><span class="main">)</span> <span class="skolem">j</span>"</span></span>
        <span class="keyword1"><span class="command">using</span></span> sup_acc_comp_Some_ge<span class="main">[</span><span class="operator">OF</span> i_cur_in True
            tstp'<span class="main"><span class="main">[</span></span><span class="operator">unfolded</span> Some p'_def q_cur_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main"><span class="main">,</span></span> <span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">]</span>
        <span class="keyword1"><span class="command">unfolding</span></span> tstp' <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> q_cur_def<span class="main"><span class="main">[</span></span><span class="operator">symmetric</span><span class="main"><span class="main">]</span></span><span class="main">)</span>
      <span class="keyword1"><span class="command">then</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
        <span class="keyword1"><span class="command">using</span></span> valid_s'_Suc_i reach_split added mmap_update_distinct valid_stac_cur
        <span class="keyword1"><span class="command">unfolding</span></span> s''_case valid_s_def mmap_keys_update
        <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span> <span class="quasi_keyword">add</span><span class="main"><span class="main">:</span></span> mmap_lookup_update' <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits<span class="main">)</span>
    <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">qed</span></span>
  <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"distinct <span class="main">(</span>map fst <span class="skolem">e'</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> mmap_update_distinct<span class="main">[</span><span class="operator">OF</span> distinct_before<span class="main"><span class="main">(</span></span>2<span class="main"><span class="main">)</span></span><span class="main">,</span> <span class="operator">unfolded</span> e'_def<span class="main">]</span>
    <span class="keyword1"><span class="command">unfolding</span></span> e'_def <span class="keyword1"><span class="command">.</span></span>
  <span class="keyword1"><span class="command">then</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span>
    <span class="main">(</span><span class="free">w</span><span class="main">⦇</span>w_st <span class="main">:=</span> <span class="skolem">st_cur</span><span class="main">,</span> w_ac <span class="main">:=</span> <span class="skolem">ac_cur</span><span class="main">,</span> w_i <span class="main">:=</span> Suc <span class="skolem">i</span><span class="main">,</span> w_ti <span class="main">:=</span> <span class="skolem">ti'</span><span class="main">,</span> w_si <span class="main">:=</span> <span class="skolem">si'</span><span class="main">,</span> w_s <span class="main">:=</span> <span class="skolem">s''</span><span class="main">,</span> w_e <span class="main">:=</span> <span class="skolem">e'</span><span class="main">⦈</span><span class="main">)</span>"</span></span>
    <span class="keyword1"><span class="command">using</span></span> i_lt_j lookup_e' valid_s'' length_rho tb_def<span class="main">(</span>3<span class="main">,</span>4<span class="main">)</span> reach_sub_si' reach_sub_ti'
      valid_before<span class="main">[</span><span class="operator">unfolded</span> step_def accept_def<span class="main">]</span> valid_stac_cur<span class="main">(</span>2<span class="main">)</span><span class="main">[</span><span class="operator">unfolded</span> accept_def<span class="main">]</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_def Let_def init_def step_def accept_def run_t_def
        run_sub_def st_def ac_def i_def ti_def si_def j_def tj_def sj_def s_def e_def<span class="main">)</span>
  <span class="keyword1"><span class="command">moreover</span></span> <span class="keyword1"><span class="command">have</span></span> <span class="quoted"><span class="quoted">"adv_start <span class="free">args</span> <span class="free">w</span> <span class="main">=</span> <span class="free">w</span><span class="main">⦇</span>w_st <span class="main">:=</span> <span class="skolem">st_cur</span><span class="main">,</span> w_ac <span class="main">:=</span> <span class="skolem">ac_cur</span><span class="main">,</span> w_i <span class="main">:=</span> Suc <span class="skolem">i</span><span class="main">,</span>
    w_ti <span class="main">:=</span> <span class="skolem">ti'</span><span class="main">,</span> w_si <span class="main">:=</span> <span class="skolem">si'</span><span class="main">,</span> w_s <span class="main">:=</span> <span class="skolem">s''</span><span class="main">,</span> w_e <span class="main">:=</span> <span class="skolem">e'</span><span class="main">⦈</span>"</span></span>
    <span class="keyword1"><span class="command">unfolding</span></span> adv_start_def Let_def s''_def e'_def
    <span class="keyword1"><span class="command">using</span></span> tb_def<span class="main">(</span>1<span class="main">,</span>2<span class="main">)</span> s'_def i_lt_j loop_def valid_before<span class="main">(</span>3<span class="main">)</span>
    <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> valid_window_def Let_def init_def step_def accept_def run_t_def
        run_sub_def st_def ac_def i_def ti_def si_def j_def tj_def sj_def s_def e_def
        <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> prod.splits<span class="main">)</span>
  <span class="keyword1"><span class="command">ultimately</span></span> <span class="keyword3"><span class="command">show</span></span> <span class="var"><span class="quoted"><span class="var">?thesis</span></span></span>
    <span class="keyword1"><span class="command">by</span></span> <span class="operator">auto</span>
<span class="keyword1"><span class="command">qed</span></span>

<span class="keyword1"><span class="command">lemma</span></span> valid_adv_start_bounds<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"w_i <span class="free">w</span> <span class="main">&lt;</span> w_j <span class="free">w</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"w_i <span class="main">(</span>adv_start <span class="free">args</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> Suc <span class="main">(</span>w_i <span class="free">w</span><span class="main">)</span>"</span></span> <span class="quoted"><span class="quoted">"w_j <span class="main">(</span>adv_start <span class="free">args</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> w_j <span class="free">w</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_tj <span class="main">(</span>adv_start <span class="free">args</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> w_tj <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"w_sj <span class="main">(</span>adv_start <span class="free">args</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> w_sj <span class="free">w</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> adv_start_def Let_def valid_window_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits
      <span class="quasi_keyword">elim</span><span class="main"><span class="main">:</span></span> reach_sub.cases<span class="main">)</span>

<span class="keyword1"><span class="command">lemma</span></span> valid_adv_start_bounds'<span class="main">:</span>
  <span class="keyword2"><span class="keyword">assumes</span></span> <span class="quoted"><span class="quoted">"valid_window <span class="free">args</span> <span class="free">t0</span> <span class="free">sub</span> <span class="free">rho</span> <span class="free">w</span>"</span></span> <span class="quoted"><span class="quoted">"w_run_t <span class="free">args</span> <span class="main">(</span>w_ti <span class="free">w</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">ti'</span><span class="main">,</span> <span class="free">t</span><span class="main">)</span>"</span></span>
    <span class="quoted"><span class="quoted">"w_run_sub <span class="free">args</span> <span class="main">(</span>w_si <span class="free">w</span><span class="main">)</span> <span class="main">=</span> Some <span class="main">(</span><span class="free">si'</span><span class="main">,</span> <span class="free">bs</span><span class="main">)</span>"</span></span>
  <span class="keyword2"><span class="keyword">shows</span></span> <span class="quoted"><span class="quoted">"w_ti <span class="main">(</span>adv_start <span class="free">args</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">ti'</span>"</span></span> <span class="quoted"><span class="quoted">"w_si <span class="main">(</span>adv_start <span class="free">args</span> <span class="free">w</span><span class="main">)</span> <span class="main">=</span> <span class="free">si'</span>"</span></span>
  <span class="keyword1"><span class="command">using</span></span> assms
  <span class="keyword1"><span class="command">by</span></span> <span class="main">(</span><span class="operator">auto</span> <span class="quasi_keyword">simp</span><span class="main"><span class="main">:</span></span> adv_start_def Let_def valid_window_def <span class="quasi_keyword">split</span><span class="main"><span class="main">:</span></span> option.splits prod.splits<span class="main">)</span>

<span class="keyword2"><span class="keyword">end</span></span></pre>
</body>

</html>